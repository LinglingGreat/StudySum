---
title: æ¨¡å‹å¹¶è¡Œè®­ç»ƒ
created: 2024-07-20
tags:
  - å¹¶è¡Œè®­ç»ƒ
---

## æ¦‚è§ˆ

1. **æ•°æ®å¹¶è¡Œ (Data Parallelismï¼ŒDP)**Â - ç›¸åŒçš„è®¾ç½®å’Œæ¨¡å‹è¢«å¤åˆ¶å¤šä»½ï¼Œæ¯ä»½æ¯æ¬¡éƒ½è¢«é¦ˆé€ä¸åŒçš„ä¸€ä»½æ•°æ®ã€‚å¤„ç†æ˜¯å¹¶è¡Œå®Œæˆçš„ï¼Œæ‰€æœ‰ä»½åœ¨æ¯ä¸ªè®­ç»ƒæ­¥ç»“æŸæ—¶åŒæ­¥ã€‚
2. **å¼ é‡å¹¶è¡Œ (Tensor Parallelismï¼ŒTP)**Â - æ¯ä¸ªå¼ é‡éƒ½è¢«åˆ†æˆå¤šä¸ªå—ï¼Œå› æ­¤å¼ é‡çš„æ¯ä¸ªåˆ†ç‰‡éƒ½ä½äºå…¶æŒ‡å®šçš„ GPU ä¸Šï¼Œè€Œä¸æ˜¯è®©æ•´ä¸ªå¼ é‡é©»ç•™åœ¨å•ä¸ª GPU ä¸Šã€‚åœ¨å¤„ç†è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ªåˆ†ç‰‡åœ¨ä¸åŒçš„ GPU ä¸Šåˆ†åˆ«å¹¶è¡Œå¤„ç†ï¼Œç»“æœåœ¨æ­¥éª¤ç»“æŸæ—¶åŒæ­¥ã€‚è¿™å°±æ˜¯æ‰€è°“çš„æ°´å¹³å¹¶è¡Œï¼Œå› ä¸ºæ˜¯åšçš„æ°´å¹³æ‹†åˆ†ã€‚
3. **æµæ°´çº¿å¹¶è¡Œ (Pipeline Parallelismï¼ŒPP)**Â - æ¨¡å‹åœ¨å¤šä¸ª GPU ä¸Šå‚ç›´ (å³æŒ‰å±‚) æ‹†åˆ†ï¼Œå› æ­¤åªæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å‹å±‚æ”¾ç½®åœ¨å•ä¸ª GPU ä¸Šã€‚æ¯ä¸ª GPU å¹¶è¡Œå¤„ç†æµæ°´çº¿çš„ä¸åŒé˜¶æ®µï¼Œå¹¶å¤„ç† batch çš„ä¸€éƒ¨åˆ†æ•°æ®ã€‚
4. **é›¶å†—ä½™ä¼˜åŒ–å™¨ (Zero Redundancy Optimizerï¼ŒZeRO)**Â - ä¹Ÿæ‰§è¡Œä¸ TP ç›¸ç±»ä¼¼çš„å¼ é‡åˆ†ç‰‡ï¼Œä½†æ•´ä¸ªå¼ é‡ä¼šåŠæ—¶é‡å»ºä»¥è¿›è¡Œå‰å‘æˆ–åå‘è®¡ç®—ï¼Œå› æ­¤ä¸éœ€è¦ä¿®æ”¹æ¨¡å‹ã€‚å®ƒè¿˜æ”¯æŒå„ç§å¸è½½æŠ€æœ¯ä»¥è¡¥å¿æœ‰é™çš„ GPU å†…å­˜ã€‚

ç›®çš„

- è®­ç»ƒæ›´å¤§çš„æ¨¡å‹æ—¶ï¼Œæ¯å—GPUé‡Œä¸ä»…è¦å­˜æ¨¡å‹å‚æ•°ï¼Œè¿˜è¦å­˜ä¸­é—´ç»“æœï¼ˆç”¨æ¥åšBackwardï¼‰ã€‚è€Œæ›´å¤§çš„æ¨¡å‹æ„å‘³ç€éœ€è¦æ›´å¤šçš„è®­ç»ƒæ•°æ®ï¼Œè¿›ä¸€æ­¥æé«˜äº†ä¸­é—´ç»“æœçš„å¤§å°ã€‚åŠ é‡äº†æ¯å—GPUçš„å†…å­˜å‹åŠ›ã€‚ï¼ˆ**å¯¹åº”ç€GPUä¸­çš„å†…å­˜é™åˆ¶**ï¼‰
- ç½‘ç»œé€šè®¯å¼€é”€ã€‚æ•°æ®åœ¨å¡ä¹‹é—´è¿›è¡Œä¼ è¾“ï¼Œæ˜¯éœ€è¦é€šè®¯æ—¶é—´çš„ã€‚ä¸åšè®¾è®¡çš„è¯ï¼Œè¿™ä¸ªé€šè®¯æ—¶é—´å¯èƒ½ä¼šæŠ¹å¹³å¤šå¡æœ¬èº«å¸¦æ¥çš„è®­ç»ƒé€Ÿåº¦æå‡ã€‚ï¼ˆ**å¯¹åº”ç€GPUé—´çš„å¸¦å®½é™åˆ¶**ï¼‰

å¾®è½¯å¼€æºçš„åˆ†å¸ƒå¼è®­ç»ƒæ¡†DeepSpeedï¼Œèåˆäº†ä¸‰ç§å¹¶è¡ŒèŒƒå¼ï¼Œå¼€å‘å‡º**3Då¹¶è¡Œ**çš„æ¡†æ¶ï¼Œå®ç°äº†åƒäº¿çº§åˆ«æ¨¡å‹å‚æ•°çš„è®­ç»ƒã€‚

## æ•°æ®å¹¶è¡Œ

æ•°æ®å¹¶è¡Œçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**åœ¨å„ä¸ªGPUä¸Šéƒ½æ‹·è´ä¸€ä»½å®Œæ•´æ¨¡å‹ï¼Œå„è‡ªåƒä¸€ä»½æ•°æ®ï¼Œç®—ä¸€ä»½æ¢¯åº¦ï¼Œæœ€åå¯¹æ¢¯åº¦è¿›è¡Œç´¯åŠ æ¥æ›´æ–°æ•´ä½“æ¨¡å‹**ã€‚ç†å¿µä¸å¤æ‚ï¼Œä½†åˆ°äº†å¤§æ¨¡å‹åœºæ™¯ï¼Œ**å·¨å¤§çš„å­˜å‚¨å’ŒGPUé—´çš„é€šè®¯é‡ï¼Œ** å°±æ˜¯ç³»ç»Ÿè®¾è®¡è¦è€ƒè™‘çš„é‡ç‚¹äº†ã€‚

- **DPï¼ˆData Parallelismï¼‰**ï¼šæœ€æ—©çš„æ•°æ®å¹¶è¡Œæ¨¡å¼ï¼Œä¸€èˆ¬é‡‡ç”¨å‚æ•°æœåŠ¡å™¨(Parameters Server)è¿™ä¸€ç¼–ç¨‹æ¡†æ¶ã€‚å®é™…ä¸­å¤šç”¨äºå•æœºå¤šå¡
- **DDPï¼ˆDistributed Data Parallelismï¼‰**ï¼šåˆ†å¸ƒå¼æ•°æ®å¹¶è¡Œï¼Œé‡‡ç”¨Ring AllReduceçš„é€šè®¯æ–¹å¼ï¼Œå®é™…ä¸­å¤šç”¨äºå¤šæœºåœºæ™¯
- **ZeROï¼š** é›¶å†—ä½™ä¼˜åŒ–å™¨ã€‚ç”±å¾®è½¯æ¨å‡ºå¹¶åº”ç”¨äºå…¶DeepSpeedæ¡†æ¶ä¸­ã€‚ä¸¥æ ¼æ¥è®²ZeROé‡‡ç”¨æ•°æ®å¹¶è¡Œ+å¼ é‡å¹¶è¡Œçš„æ–¹å¼ï¼Œæ—¨åœ¨é™ä½å­˜å‚¨ã€‚

### DP

![](img/Pasted%20image%2020240720114219.png)

ä¸€ä¸ªç»å…¸æ•°æ®å¹¶è¡Œçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š

- è‹¥å¹²å—**è®¡ç®—GPU**ï¼Œå¦‚å›¾ä¸­GPU0~GPU2ï¼›1å—**æ¢¯åº¦æ”¶é›†GPU**ï¼Œå¦‚å›¾ä¸­AllReduceæ“ä½œæ‰€åœ¨GPUã€‚
- åœ¨æ¯å—è®¡ç®—GPUä¸Šéƒ½æ‹·è´ä¸€ä»½å®Œæ•´çš„æ¨¡å‹å‚æ•°ã€‚
- æŠŠä¸€ä»½æ•°æ®Xï¼ˆä¾‹å¦‚ä¸€ä¸ªbatchï¼‰å‡åŒ€åˆ†ç»™ä¸åŒçš„è®¡ç®—GPUã€‚
- æ¯å—è®¡ç®—GPUåšä¸€è½®FWDå’ŒBWDåï¼Œç®—å¾—ä¸€ä»½æ¢¯åº¦Gã€‚
- æ¯å—è®¡ç®—GPUå°†è‡ªå·±çš„æ¢¯åº¦**push**ç»™æ¢¯åº¦æ”¶é›†GPUï¼Œåšèšåˆæ“ä½œã€‚è¿™é‡Œçš„èšåˆæ“ä½œä¸€èˆ¬æŒ‡**æ¢¯åº¦ç´¯åŠ **ã€‚å½“ç„¶ä¹Ÿæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ã€‚
- æ¢¯åº¦æ”¶é›†GPUèšåˆå®Œæ¯•åï¼Œè®¡ç®—GPUä»å®ƒé‚£**pull**ä¸‹å®Œæ•´çš„æ¢¯åº¦ç»“æœï¼Œç”¨äºæ›´æ–°æ¨¡å‹å‚æ•°Wã€‚æ›´æ–°å®Œæ¯•åï¼Œè®¡ç®—GPUä¸Šçš„æ¨¡å‹å‚æ•°ä¾ç„¶ä¿æŒä¸€è‡´ã€‚
- **èšåˆå†ä¸‹å‘æ¢¯åº¦çš„æ“ä½œï¼Œç§°ä¸ºAllReduce**ã€‚

å®ç°DPçš„ä¸€ç§ç»å…¸ç¼–ç¨‹æ¡†æ¶å«â€œå‚æ•°æœåŠ¡å™¨â€ï¼Œåœ¨è¿™ä¸ªæ¡†æ¶é‡Œï¼Œ**è®¡ç®—GPUç§°ä¸ºWorker**ï¼Œ**æ¢¯åº¦èšåˆGPUç§°ä¸ºServerã€‚** åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä¸ºäº†å°½é‡å‡å°‘é€šè®¯é‡ï¼Œä¸€èˆ¬å¯é€‰æ‹©ä¸€ä¸ªWorkeråŒæ—¶ä½œä¸ºServerã€‚æ¯”å¦‚å¯æŠŠæ¢¯åº¦å…¨å‘åˆ°GPU0ä¸Šåšèšåˆã€‚éœ€è¦å†é¢å¤–è¯´æ˜å‡ ç‚¹ï¼š

- 1ä¸ªWorkeræˆ–è€…Serverä¸‹å¯ä»¥ä¸æ­¢1å—GPUã€‚
- Serverå¯ä»¥åªåšæ¢¯åº¦èšåˆï¼Œä¹Ÿå¯ä»¥æ¢¯åº¦èšåˆ+å…¨é‡å‚æ•°æ›´æ–°ä¸€èµ·åš

åœ¨å‚æ•°æœåŠ¡å™¨çš„è¯­è¨€ä½“ç³»ä¸‹ï¼ŒDPçš„è¿‡ç¨‹åˆå¯ä»¥è¢«æè¿°ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720140406.png)

DPçš„æ¡†æ¶ç†è§£èµ·æ¥ä¸éš¾ï¼Œä½†å®æˆ˜ä¸­ç¡®æœ‰ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

- **å­˜å‚¨å¼€é”€å¤§**ã€‚æ¯å—GPUä¸Šéƒ½å­˜äº†ä¸€ä»½å®Œæ•´çš„æ¨¡å‹ï¼Œé€ æˆå†—ä½™ã€‚
- **é€šè®¯å¼€é”€å¤§**ã€‚Serveréœ€è¦å’Œæ¯ä¸€ä¸ªWorkerè¿›è¡Œæ¢¯åº¦ä¼ è¾“ã€‚å½“Serverå’ŒWorkerä¸åœ¨ä¸€å°æœºå™¨ä¸Šæ—¶ï¼ŒServerçš„å¸¦å®½å°†ä¼šæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„è®¡ç®—æ•ˆç‡ç“¶é¢ˆã€‚

  
æˆ‘ä»¬å¯¹é€šè®¯å¼€é”€å†åšè¯¦ç»†è¯´æ˜ã€‚å¦‚æœå°†ä¼ è¾“æ¯”ä½œä¸€æ¡é©¬è·¯ï¼Œå¸¦å®½å°±æ˜¯é©¬è·¯çš„å®½åº¦ï¼Œå®ƒå†³å®šæ¯æ¬¡å¹¶æ’è¡Œé©¶çš„æ•°æ®é‡ã€‚ä¾‹å¦‚å¸¦å®½æ˜¯100G/sï¼Œä½†æ¯ç§’å´æ¨ç»™Server 1000Gçš„æ•°æ®ï¼Œæ¶ˆåŒ–è‚¯å®šéœ€è¦æ—¶é—´ã€‚é‚£ä¹ˆå½“Serveråœ¨æ¬è¿æ•°æ®ï¼Œè®¡ç®—æ¢¯åº¦çš„æ—¶å€™ï¼ŒWorkerä»¬åœ¨å¹²å˜›å‘¢ï¼Ÿå½“ç„¶æ˜¯åœ¨ï¼šæ‘¸é±¼ã€‚ä¸ºæ­¤æœ‰äº†**æ¢¯åº¦å¼‚æ­¥æ›´æ–°** è¿™ä¸€ç­–ç•¥ã€‚

![](img/Pasted%20image%2020240720141218.png)

ä¸Šå›¾åˆ»ç”»äº†åœ¨**æ¢¯åº¦å¼‚æ­¥æ›´æ–°**çš„åœºæ™¯ä¸‹ï¼ŒæŸä¸ªWorkerçš„è®¡ç®—é¡ºåºä¸ºï¼š

- åœ¨ç¬¬10è½®è®¡ç®—ä¸­ï¼Œè¯¥Workeræ­£å¸¸è®¡ç®—æ¢¯åº¦ï¼Œå¹¶å‘Serverå‘é€push&pullæ¢¯åº¦è¯·æ±‚ã€‚
- ä½†æ˜¯ï¼Œè¯¥Workerå¹¶ä¸ä¼šå®é™…ç­‰åˆ°æŠŠèšåˆæ¢¯åº¦æ‹¿å›æ¥ï¼Œæ›´æ–°å®Œå‚æ•°Wåå†åšè®¡ç®—ã€‚è€Œæ˜¯ç›´æ¥æ‹¿æ—§çš„Wï¼Œåƒæ–°çš„æ•°æ®ï¼Œç»§ç»­ç¬¬11è½®çš„è®¡ç®—ã€‚**è¿™æ ·å°±ä¿è¯åœ¨é€šè®¯çš„æ—¶é—´é‡Œï¼ŒWorkerä¹Ÿåœ¨é©¬ä¸åœè¹„åšè®¡ç®—ï¼Œæå‡è®¡ç®—é€šè®¯æ¯”ã€‚**
- å½“ç„¶ï¼Œå¼‚æ­¥ä¹Ÿä¸èƒ½å¤ªè¿‡ä»½ã€‚åªè®¡ç®—æ¢¯åº¦ï¼Œä¸æ›´æ–°æƒé‡ï¼Œé‚£æ¨¡å‹å°±æ— æ³•æ”¶æ•›ã€‚å›¾ä¸­åˆ»ç”»çš„æ˜¯**å»¶è¿Ÿä¸º1**çš„å¼‚æ­¥æ›´æ–°ï¼Œä¹Ÿå°±æ˜¯åœ¨å¼€å§‹ç¬¬12è½®å¯¹çš„è®¡ç®—æ—¶ï¼Œå¿…é¡»ä¿è¯Wå·²ç»ç”¨ç¬¬10ã€11è½®çš„æ¢¯åº¦åšå®Œ2æ¬¡æ›´æ–°äº†ã€‚

å‚æ•°æœåŠ¡å™¨çš„æ¡†æ¶ä¸‹ï¼Œå»¶è¿Ÿçš„æ­¥æ•°ä¹Ÿå¯ä»¥ç”±ç”¨æˆ·è‡ªå·±å†³å®šï¼Œä¸‹å›¾åˆ†åˆ«åˆ»åˆ’äº†å‡ ç§å»¶è¿Ÿæƒ…å†µï¼š

![](img/Pasted%20image%2020240720141246.png)

- **(a) æ— å»¶è¿Ÿ**
- **(b) å»¶è¿Ÿä½†ä¸æŒ‡å®šå»¶è¿Ÿæ­¥æ•°**ã€‚ä¹Ÿå³åœ¨è¿­ä»£2æ—¶ï¼Œç”¨çš„å¯èƒ½æ˜¯è€æƒé‡ï¼Œä¹Ÿå¯èƒ½æ˜¯æ–°æƒé‡ï¼Œå¬å¤©ç”±å‘½ã€‚
- **(c) å»¶è¿Ÿä¸”æŒ‡å®šå»¶è¿Ÿæ­¥æ•°ä¸º1**ã€‚ä¾‹å¦‚åšè¿­ä»£3æ—¶ï¼Œå¯ä»¥ä¸æ‹¿å›è¿­ä»£2çš„æ¢¯åº¦ï¼Œä½†å¿…é¡»ä¿è¯è¿­ä»£0ã€1çš„æ¢¯åº¦éƒ½å·²æ‹¿å›ä¸”ç”¨äºå‚æ•°æ›´æ–°ã€‚

æ€»ç»“ä¸€ä¸‹ï¼Œ**å¼‚æ­¥å¾ˆé¦™ï¼Œä½†å¯¹ä¸€ä¸ªWorkeræ¥è¯´ï¼Œåªæ˜¯ç­‰äºWä¸å˜ï¼Œbatchçš„æ•°é‡å¢åŠ äº†è€Œå·²ï¼Œåœ¨SGDä¸‹ï¼Œä¼šå‡æ…¢æ¨¡å‹çš„æ•´ä½“æ”¶æ•›é€Ÿåº¦**ã€‚å¼‚æ­¥çš„æ•´ä½“æ€æƒ³æ˜¯ï¼Œæ¯”èµ·è®©Workeré—²ç€ï¼Œå€’ä¸å¦‚è®©å®ƒå¤šåƒç‚¹æ•°æ®ï¼Œè™½ç„¶åé¦ˆå»¶è¿Ÿäº†ï¼Œä½†åªè¦å®ƒåœ¨å¹²æ´»åœ¨å­¦ä¹ å°±è¡Œã€‚

### DDP

**`DistributedDataParallel`(DDP)**ï¼Œè¿™æ˜¯ç›¸åº”çš„Â [PyTorch æ–‡æ¡£Â 2](https://pytorch.org/docs/master/generated/torch.nn.parallel.DistributedDataParallel.html#torch.nn.parallel.DistributedDataParallel)ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæ¨¡å‹è¢«å®Œå…¨å¤åˆ¶åˆ°æ¯ä¸ª GPUï¼Œç„¶ååœ¨æ¯æ¬¡è¿­ä»£åæ‰€æœ‰æ¨¡å‹ç›¸äº’åŒæ­¥å„è‡ªçš„çŠ¶æ€ã€‚è¿™ç§æ–¹æ³•å¯ä»¥é€šè¿‡æŠ•å…¥æ›´å¤š GPU èµ„æºçš„æ–¹å¼åŠ å¿«è®­ç»ƒé€Ÿåº¦ï¼Œè§£å†³é—®é¢˜ã€‚ä½†å®ƒæœ‰ä¸ªé™åˆ¶ï¼Œå³åªæœ‰å½“æ¨¡å‹èƒ½å¤Ÿæ”¾è¿›å•ä¸ª GPU æ—¶æ‰æœ‰æ•ˆã€‚

å—é€šè®¯è´Ÿè½½ä¸å‡çš„å½±å“ï¼Œ**DPä¸€èˆ¬ç”¨äºå•æœºå¤šå¡åœºæ™¯**ã€‚å› æ­¤ï¼ŒDDPä½œä¸ºä¸€ç§æ›´é€šç”¨çš„è§£å†³æ–¹æ¡ˆå‡ºç°äº†ï¼Œæ—¢èƒ½å¤šæœºï¼Œä¹Ÿèƒ½å•æœºã€‚**DDPé¦–å…ˆè¦è§£å†³çš„å°±æ˜¯é€šè®¯é—®é¢˜ï¼šå°†Serverä¸Šçš„é€šè®¯å‹åŠ›å‡è¡¡è½¬åˆ°å„ä¸ªWorkerä¸Šã€‚å®ç°è¿™ä¸€ç‚¹åï¼Œå¯ä»¥è¿›ä¸€æ­¥å»Serverï¼Œç•™Workerã€‚**

**ç›®å‰æœ€é€šç”¨çš„AllReduceæ–¹æ³•ï¼šRing-AllReduce**ã€‚å®ƒç”±ç™¾åº¦æœ€å…ˆæå‡ºï¼Œéå¸¸æœ‰æ•ˆåœ°è§£å†³äº†æ•°æ®å¹¶è¡Œä¸­é€šè®¯è´Ÿè½½ä¸å‡çš„é—®é¢˜ï¼Œä½¿å¾—DDPå¾—ä»¥å®ç°ã€‚

å¦‚ä¸‹å›¾ï¼Œå‡è®¾æœ‰4å—GPUï¼Œæ¯å—GPUä¸Šçš„æ•°æ®ä¹Ÿå¯¹åº”è¢«åˆ‡æˆ4ä»½ã€‚AllReduceçš„æœ€ç»ˆç›®æ ‡ï¼Œå°±æ˜¯è®©æ¯å—GPUä¸Šçš„æ•°æ®éƒ½å˜æˆç®­å¤´å³è¾¹æ±‡æ€»çš„æ ·å­ã€‚

![](img/Pasted%20image%2020240720141856.png)

Ring-ALLReduceåˆ™åˆ†ä¸¤å¤§æ­¥éª¤å®ç°è¯¥ç›®æ ‡ï¼š**Reduce-Scatter**å’Œ**All-Gatherã€‚**

**Reduce-Scatter**  
å®šä¹‰ç½‘ç»œæ‹“æ‰‘å…³ç³»ï¼Œä½¿å¾—æ¯ä¸ªGPUåªå’Œå…¶ç›¸é‚»çš„ä¸¤å—GPUé€šè®¯ã€‚æ¯æ¬¡å‘é€å¯¹åº”ä½ç½®çš„æ•°æ®è¿›è¡Œ**ç´¯åŠ **ã€‚æ¯ä¸€æ¬¡ç´¯åŠ æ›´æ–°éƒ½å½¢æˆä¸€ä¸ªæ‹“æ‰‘ç¯ï¼Œå› æ­¤è¢«ç§°ä¸ºRingã€‚çœ‹åˆ°è¿™è§‰å¾—å›°æƒ‘ä¸è¦ç´§ï¼Œæˆ‘ä»¬ç”¨å›¾ä¾‹æŠŠè¯¦ç»†æ­¥éª¤ç”»å‡ºæ¥ã€‚

![](img/Pasted%20image%2020240720141910.png)

![](img/Pasted%20image%2020240720141918.png)

ä¸€æ¬¡ç´¯åŠ å®Œæ¯•åï¼Œè“è‰²ä½ç½®çš„æ•°æ®å—è¢«æ›´æ–°ï¼Œè¢«æ›´æ–°çš„æ•°æ®å—å°†æˆä¸ºä¸‹ä¸€æ¬¡æ›´æ–°çš„èµ·ç‚¹ï¼Œç»§ç»­åšç´¯åŠ æ“ä½œã€‚

![](img/Pasted%20image%2020240720141930.png)

![](img/Pasted%20image%2020240720141937.png)

**3æ¬¡**æ›´æ–°ä¹‹åï¼Œæ¯å—GPUä¸Šéƒ½æœ‰ä¸€å—æ•°æ®æ‹¥æœ‰äº†å¯¹åº”ä½ç½®å®Œæ•´çš„èšåˆï¼ˆå›¾ä¸­çº¢è‰²ï¼‰ã€‚æ­¤æ—¶ï¼ŒReduce-Scatteré˜¶æ®µç»“æŸã€‚è¿›å…¥All-Gatheré˜¶æ®µã€‚ç›®æ ‡æ˜¯æŠŠçº¢è‰²å—çš„æ•°æ®å¹¿æ’­åˆ°å…¶ä½™GPUå¯¹åº”çš„ä½ç½®ä¸Šã€‚  
  
  
**All-Gather**  
å¦‚åå­—é‡ŒGatheræ‰€è¿°çš„ä¸€æ ·ï¼Œè¿™æ“ä½œé‡Œä¾ç„¶æŒ‰ç…§â€œç›¸é‚»GPUå¯¹åº”ä½ç½®è¿›è¡Œé€šè®¯â€çš„åŸåˆ™ï¼Œä½†å¯¹åº”ä½ç½®æ•°æ®ä¸å†åšç›¸åŠ ï¼Œè€Œæ˜¯ç›´æ¥æ›¿æ¢ã€‚All-Gatherä»¥çº¢è‰²å—ä½œä¸ºèµ·ç‚¹ã€‚

![](img/Pasted%20image%2020240720141952.png)

![](img/Pasted%20image%2020240720141959.png)

ä»¥æ­¤ç±»æ¨ï¼ŒåŒæ ·ç»è¿‡**3è½®è¿­ä»£å**ï¼Œä½¿å¾—æ¯å—GPUä¸Šéƒ½æ±‡æ€»åˆ°äº†å®Œæ•´çš„æ•°æ®ï¼Œå˜æˆå¦‚ä¸‹å½¢å¼ï¼š

![](img/Pasted%20image%2020240720142011.png)

DDPæŠŠé€šè®¯é‡å‡è¡¡è´Ÿè½½åˆ°äº†æ¯ä¸€æ—¶åˆ»çš„æ¯ä¸ªWorkerä¸Šï¼Œè€ŒDPä»…è®©Serveråšå‹¤åŠ³çš„æ¬è¿å·¥ã€‚å½“è¶Šæ¥è¶Šå¤šçš„GPUåˆ†å¸ƒåœ¨è·ç¦»è¾ƒè¿œçš„æœºå™¨ä¸Šæ—¶ï¼ŒDPçš„é€šè®¯æ—¶é—´æ˜¯ä¼šå¢åŠ çš„ã€‚

ä½†è¿™å¹¶ä¸è¯´æ˜å‚æ•°æœåŠ¡å™¨ä¸èƒ½æ‰“ï¼ˆæœ‰å¾ˆå¤šæ–‡ç« å°†å‚æ•°æœåŠ¡å™¨å½“ä½œold dinosauræ¥çœ‹ï¼‰ã€‚äº‹å®ä¸Šï¼Œå‚æ•°æœåŠ¡å™¨ä¹Ÿæä¾›äº†å¤šServeræ–¹æ³•ï¼Œå¦‚ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720142225.png)

åœ¨å¤šServerçš„æ¨¡å¼ä¸‹ï¼Œè¿›ä¸€æ­¥ï¼Œæ¯ä¸ªServerå¯ä»¥åªè´Ÿè´£ç»´æŠ¤å’Œæ›´æ–°æŸä¸€å—æ¢¯åº¦ï¼ˆä¹Ÿå¯ä»¥æŸå—æ¢¯åº¦+å‚æ•°ä¸€èµ·ç»´æŠ¤ï¼‰ï¼Œæ­¤æ—¶è™½ç„¶æ¯ä¸ªServerä»ç„¶éœ€è¦å’Œæ‰€æœ‰Workeré€šè®¯ï¼Œä½†å®ƒçš„å¸¦å®½å‹åŠ›ä¼šå°éå¸¸å¤šã€‚ç»è¿‡è°ƒæ•´è®¾è®¡åï¼Œä¾ç„¶å¯ä»¥ç”¨æ¥åšDDPã€‚

1ã€åœ¨DPä¸­ï¼Œæ¯ä¸ªGPUä¸Šéƒ½æ‹·è´ä¸€ä»½å®Œæ•´çš„æ¨¡å‹ï¼Œæ¯ä¸ªGPUä¸Šå¤„ç†batchçš„ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ‰€æœ‰GPUç®—å‡ºæ¥çš„æ¢¯åº¦è¿›è¡Œç´¯åŠ åï¼Œå†ä¼ å›å„GPUç”¨äºæ›´æ–°å‚æ•°  
2ã€DPå¤šé‡‡ç”¨å‚æ•°æœåŠ¡å™¨è¿™ä¸€ç¼–ç¨‹æ¡†æ¶ï¼Œä¸€èˆ¬ç”±è‹¥ä¸ªè®¡ç®—Workerå’Œ1ä¸ªæ¢¯åº¦èšåˆServerç»„æˆã€‚Serverä¸æ¯ä¸ªWorkeré€šè®¯ï¼ŒWorkeré—´å¹¶ä¸é€šè®¯ã€‚å› æ­¤Serveræ‰¿æ‹…äº†ç³»ç»Ÿæ‰€æœ‰çš„é€šè®¯å‹åŠ›ã€‚åŸºäºæ­¤DPå¸¸ç”¨äºå•æœºå¤šå¡åœºæ™¯ã€‚  
3ã€å¼‚æ­¥æ¢¯åº¦æ›´æ–°æ˜¯æå‡è®¡ç®—é€šè®¯æ¯”çš„ä¸€ç§æ–¹æ³•ï¼Œå»¶è¿Ÿæ›´æ–°çš„æ­¥æ•°å¤§å°å†³å®šäº†æ¨¡å‹çš„æ”¶æ•›é€Ÿåº¦ã€‚  
4ã€Ring-AllReduceé€šè¿‡å®šä¹‰ç½‘ç»œç¯æ‹“æ‰‘çš„æ–¹å¼ï¼Œå°†é€šè®¯å‹åŠ›å‡è¡¡åœ°åˆ†åˆ°æ¯ä¸ªGPUä¸Šï¼Œä½¿å¾—è·¨æœºå™¨çš„æ•°æ®å¹¶è¡Œï¼ˆDDPï¼‰å¾—ä»¥é«˜æ•ˆå®ç°ã€‚  
5ã€DPå’ŒDDPçš„æ€»é€šè®¯é‡ç›¸åŒï¼Œä½†å› è´Ÿè½½ä¸å‡çš„åŸå› ï¼ŒDPéœ€è¦è€—è´¹æ›´å¤šçš„æ—¶é—´æ¬è¿æ•°æ®



### ZeRO æ•°æ®å¹¶è¡Œ

ç”±å¾®è½¯å¼€å‘çš„**ZeROï¼ˆé›¶å†—ä½™ä¼˜åŒ–ï¼‰**ï¼Œå®ƒæ˜¯DeepSpeedè¿™ä¸€åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶çš„æ ¸å¿ƒï¼Œè¢«ç”¨æ¥è§£å†³å¤§æ¨¡å‹è®­ç»ƒä¸­çš„æ˜¾å­˜å¼€é”€é—®é¢˜ã€‚**ZeROçš„æ€æƒ³å°±æ˜¯ç”¨é€šè®¯æ¢æ˜¾å­˜ã€‚**

ä¸‹å›¾å¾ˆå¥½åœ°æè¿°äº† ZeRO æ•°æ®å¹¶è¡Œ (æ¥è‡ªÂ [æ­¤åšæ–‡Â 8](https://www.microsoft.com/en-us/research/blog/zero-deepspeed-new-system-optimizations-enable-training-models-with-over-1000-billion-parameters/))ã€‚

![DeepSpeed-Image-1](https://devrel.andfun.cn/devrel/posts/2023/03/NqC0tT.jpg)

è¿™åªæ˜¯é€šå¸¸çš„ DDPï¼Œåªæ˜¯æ²¡æœ‰æ¯ä¸ª GPU éƒ½å¤åˆ¶å®Œæ•´çš„æ¨¡å‹å‚æ•°ã€æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼Œâ€‹â€‹è€Œæ˜¯æ¯ä¸ª GPU åªå­˜å‚¨å…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚åœ¨éšåçš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“éœ€è¦ç»™å®šå±‚çš„å®Œæ•´å±‚å‚æ•°æ—¶ï¼Œæ‰€æœ‰ GPU åŒæ­¥ä»¥ç›¸äº’æä¾›å®ƒä»¬ç¼ºå¤±çš„éƒ¨åˆ†ã€‚

#### å­˜å‚¨æ¶ˆè€—

åœ¨å¤§æ¨¡å‹è®­ç»ƒçš„è¿‡ç¨‹ä¸­ï¼ŒGPUéƒ½éœ€è¦å­˜ä»€ä¹ˆå†…å®¹ã€‚

![](img/Pasted%20image%2020240720145301.png)

å­˜å‚¨ä¸»è¦åˆ†ä¸ºä¸¤å¤§å—ï¼šModel Stateså’ŒResidual States  
**Model States**æŒ‡å’Œæ¨¡å‹æœ¬èº«æ¯æ¯ç›¸å…³çš„ï¼Œå¿…é¡»å­˜å‚¨çš„å†…å®¹ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

- **optimizer states**ï¼šAdamä¼˜åŒ–ç®—æ³•ä¸­çš„momentumå’Œvariance
- **gradients**ï¼šæ¨¡å‹æ¢¯åº¦
- **parameters**ï¼šæ¨¡å‹å‚æ•°W

**Residual States**æŒ‡å¹¶éæ¨¡å‹å¿…é¡»çš„ï¼Œä½†åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šé¢å¤–äº§ç”Ÿçš„å†…å®¹ï¼Œå…·ä½“åŒ…æ‹¬ï¼š

- **activation**ï¼šæ¿€æ´»å€¼ã€‚åœ¨backwardè¿‡ç¨‹ä¸­ä½¿ç”¨é“¾å¼æ³•åˆ™è®¡ç®—æ¢¯åº¦æ—¶ä¼šç”¨åˆ°ã€‚æœ‰äº†å®ƒç®—æ¢¯åº¦ä¼šæ›´å¿«ï¼Œä½†å®ƒä¸æ˜¯å¿…é¡»å­˜å‚¨çš„ï¼Œå› ä¸ºå¯ä»¥é€šè¿‡é‡æ–°åšForwardæ¥ç®—å®ƒã€‚
- **temporary buffers:**Â ä¸´æ—¶å­˜å‚¨ã€‚ä¾‹å¦‚æŠŠæ¢¯åº¦å‘é€åˆ°æŸå—GPUä¸ŠåšåŠ æ€»èšåˆæ—¶äº§ç”Ÿçš„å­˜å‚¨ã€‚
- **unusable fragment memory**ï¼šç¢ç‰‡åŒ–çš„å­˜å‚¨ç©ºé—´ã€‚è™½ç„¶æ€»å­˜å‚¨ç©ºé—´æ˜¯å¤Ÿçš„ï¼Œä½†æ˜¯å¦‚æœå–ä¸åˆ°è¿ç»­çš„å­˜å‚¨ç©ºé—´ï¼Œç›¸å…³çš„è¯·æ±‚ä¹Ÿä¼šè¢«failæ‰ã€‚å¯¹è¿™ç±»ç©ºé—´æµªè´¹å¯ä»¥é€šè¿‡å†…å­˜æ•´ç†æ¥è§£å†³ã€‚

å¯¹äºæ¨¡å‹ï¼Œæˆ‘ä»¬è‚¯å®šå¸Œæœ›å…¶å‚æ•°è¶Šç²¾å‡†è¶Šå¥½ï¼Œä¹Ÿå³æˆ‘ä»¬ç”¨**fp32ï¼ˆå•ç²¾åº¦æµ®ç‚¹æ•°ï¼Œå­˜å‚¨å 4byteï¼‰** æ¥è¡¨ç¤ºå‚æ•°Wã€‚ä½†æ˜¯åœ¨forwardå’Œbackwardçš„è¿‡ç¨‹ä¸­ï¼Œfp32çš„è®¡ç®—å¼€é”€ä¹Ÿæ˜¯åºå¤§çš„ã€‚é‚£ä¹ˆèƒ½å¦åœ¨è®¡ç®—çš„è¿‡ç¨‹ä¸­ï¼Œå¼•å…¥**fp16æˆ–bf16ï¼ˆåŠç²¾åº¦æµ®ç‚¹æ•°ï¼Œå­˜å‚¨å 2byteï¼‰**ï¼Œæ¥å‡è½»è®¡ç®—å‹åŠ›å‘¢ï¼Ÿäºæ˜¯ï¼Œæ··åˆç²¾åº¦è®­ç»ƒå°±äº§ç”Ÿäº†ï¼Œå®ƒçš„æ­¥éª¤å¦‚ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720145438.png)

- å­˜å‚¨ä¸€ä»½fp32çš„parameterï¼Œmomentumå’Œvarianceï¼ˆç»Ÿç§°model statesï¼‰
- åœ¨forwardå¼€å§‹ä¹‹å‰ï¼Œé¢å¤–å¼€è¾Ÿä¸€å—å­˜å‚¨ç©ºé—´ï¼Œå°†fp32 parameterå‡åŠåˆ°fp16 parameterã€‚
- æ­£å¸¸åšforwardå’Œbackwardï¼Œåœ¨æ­¤ä¹‹é—´äº§ç”Ÿçš„activationå’Œgradientsï¼Œéƒ½ç”¨fp16è¿›è¡Œå­˜å‚¨ã€‚
- ç”¨fp16 gradientså»æ›´æ–°fp32ä¸‹çš„model statesã€‚
- å½“æ¨¡å‹æ”¶æ•›åï¼Œfp32çš„parameterå°±æ˜¯æœ€ç»ˆçš„å‚æ•°è¾“å‡ºã€‚

è®¡ç®—æ¨¡å‹åœ¨è®­ç»ƒæ—¶éœ€è¦çš„å­˜å‚¨å¤§å°

![](img/Pasted%20image%2020240720145535.png)

å› ä¸ºé‡‡ç”¨äº†Adamä¼˜åŒ–ï¼Œæ‰€ä»¥æ‰ä¼šå‡ºç°momentumå’Œvarianceã€‚è®°æ¨¡å‹å¿…å­˜çš„æ•°æ®å¤§å°ä¸ºÂ ğ¾Î¦Â ã€‚å› æ­¤æœ€ç»ˆå†…å­˜å¼€é”€ä¸ºï¼šå› æ­¤æœ€ç»ˆå†…å­˜å¼€é”€ä¸ºï¼šÂ 2Î¦+2Î¦+ğ¾Î¦  

å¦å¤–ï¼Œ**è¿™é‡Œæš‚ä¸å°†activationçº³å…¥ç»Ÿè®¡èŒƒå›´**ï¼ŒåŸå› æ˜¯ï¼š

- activationä¸ä»…ä¸æ¨¡å‹å‚æ•°ç›¸å…³ï¼Œè¿˜ä¸batch sizeç›¸å…³
- activationçš„å­˜å‚¨ä¸æ˜¯å¿…é¡»çš„ã€‚å­˜å‚¨activationåªæ˜¯ä¸ºäº†åœ¨ç”¨é“¾å¼æ³•åˆ™åšbackwardçš„è¿‡ç¨‹ä¸­ï¼Œè®¡ç®—æ¢¯åº¦æ›´å¿«ä¸€äº›ã€‚ä½†ä½ æ°¸è¿œå¯ä»¥é€šè¿‡åªä¿ç•™æœ€åˆçš„è¾“å…¥Xï¼Œé‡æ–°åšforwardæ¥å¾—åˆ°æ¯ä¸€å±‚çš„activationï¼ˆè™½ç„¶å®é™…ä¸­å¹¶ä¸ä¼šè¿™ä¹ˆæç«¯ï¼‰ã€‚
- å› ä¸ºactivationçš„è¿™ç§çµæ´»æ€§ï¼Œçº³å…¥å®ƒåä¸æ–¹ä¾¿è¡¡é‡ç³»ç»Ÿæ€§èƒ½éšæ¨¡å‹å¢å¤§çš„çœŸå®å˜åŠ¨æƒ…å†µ

#### ZeRO-DP

åœ¨æ•´ä¸ªè®­ç»ƒä¸­ï¼Œæœ‰å¾ˆå¤šstateså¹¶ä¸ä¼šæ¯æ—¶æ¯åˆ»éƒ½ç”¨åˆ°ï¼Œä¸¾ä¾‹æ¥è¯´ï¼›

- Adamä¼˜åŒ–ä¸‹çš„optimizer statesåªåœ¨æœ€ç»ˆåšupdateæ—¶æ‰ç”¨åˆ°
- æ•°æ®å¹¶è¡Œä¸­ï¼Œgradientsåªåœ¨æœ€ååšAllReduceå’Œupdatesæ—¶æ‰ç”¨åˆ°
- å‚æ•°Wåªåœ¨åšforwardå’Œbackwardçš„é‚£ä¸€åˆ»æ‰ç”¨åˆ°
- è¯¸å¦‚æ­¤ç±»

æ‰€ä»¥ï¼ŒZeROæƒ³äº†ä¸€ä¸ªç®€å•ç²—æš´çš„åŠæ³•ï¼š**å¦‚æœæ•°æ®ç®—å®Œå³åºŸï¼Œç­‰éœ€è¦çš„æ—¶å€™ï¼Œæˆ‘å†æƒ³åŠæ³•ä»ä¸ªä»€ä¹ˆåœ°æ–¹æ‹¿å›æ¥ï¼Œé‚£ä¸å°±çœäº†ä¸€ç¬”å­˜å‚¨ç©ºé—´å—ï¼Ÿ**  
æ²¿ç€è¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬é€ä¸€æ¥çœ‹ZeROæ˜¯å¦‚ä½•é€’è¿›åšå­˜å‚¨ä¼˜åŒ–çš„ã€‚

é¦–å…ˆï¼Œä» optimizer stateå¼€å§‹ä¼˜åŒ–ã€‚å°†optimizer stateåˆ†æˆè‹¥å¹²ä»½ï¼Œæ¯å—GPUä¸Šå„è‡ªç»´æŠ¤ä¸€ä»½ã€‚è¿™æ ·å°±å‡å°‘äº†ç›¸å½“ä¸€éƒ¨åˆ†çš„æ˜¾å­˜å¼€é”€ã€‚å¦‚ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720145856.png)

å¤ä¹ ä¸€ä¸‹ï¼Œæ­¤æ—¶W=fp16ï¼ŒG=fp16ï¼ŒO=fp32ã€‚æ­¤æ—¶ï¼Œæ•´ä½“æ•°æ®å¹¶è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰æ¯å—GPUä¸Šå­˜ä¸€ä»½å®Œæ•´çš„å‚æ•°Wã€‚å°†ä¸€ä¸ªbatchçš„æ•°æ®åˆ†æˆ3ä»½ï¼Œæ¯å—GPUå„åƒä¸€ä»½ï¼Œåšå®Œä¸€è½®fowardå’Œbackwardåï¼Œå„å¾—ä¸€ä»½æ¢¯åº¦ã€‚

ï¼ˆ2ï¼‰å¯¹æ¢¯åº¦åšä¸€æ¬¡**AllReduce**ï¼Œ**å¾—åˆ°å®Œæ•´çš„æ¢¯åº¦G**ï¼Œäº§ç”Ÿå•å¡é€šè®¯é‡Â 2Î¦Â ã€‚**ä¸ºäº†è¡¨è¾¾ç®€æ˜ï¼Œè¿™é‡Œé€šè®¯é‡æˆ‘ä»¬å°±ä¸å†æ¢ç®—æˆbyteäº†**ï¼Œè€Œç›´æ¥æ ¹æ®å‚æ•°é‡æ¥è®¡ç®—ã€‚

  
ï¼ˆ3ï¼‰å¾—åˆ°å®Œæ•´æ¢¯åº¦Gï¼Œå°±å¯ä»¥å¯¹Wåšæ›´æ–°ã€‚æˆ‘ä»¬çŸ¥é“Wçš„æ›´æ–°ç”±optimizer stateså’Œæ¢¯åº¦å…±åŒå†³å®šã€‚**ç”±äºæ¯å—GPUä¸Šåªä¿ç®¡éƒ¨åˆ†optimizer statesï¼Œå› æ­¤åªèƒ½å°†ç›¸åº”çš„Wï¼ˆè“è‰²éƒ¨åˆ†ï¼‰è¿›è¡Œæ›´æ–°**ã€‚ï¼ˆ2ï¼‰å’Œï¼ˆ3ï¼‰å¯ä»¥ç”¨ä¸‹å›¾è¡¨ç¤ºï¼š

![](img/Pasted%20image%2020240720145953.png)

ï¼ˆ4ï¼‰æ­¤æ—¶ï¼Œæ¯å—GPUä¸Šéƒ½æœ‰éƒ¨åˆ†Wæ²¡æœ‰å®Œæˆæ›´æ–°ï¼ˆå›¾ä¸­ç™½è‰²éƒ¨åˆ†ï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹Wåšä¸€æ¬¡**All-Gather**ï¼Œä»åˆ«çš„GPUä¸ŠæŠŠæ›´æ–°å¥½çš„éƒ¨åˆ†Wå–å›æ¥ã€‚äº§ç”Ÿå•å¡é€šè®¯é‡Â Î¦Â ã€‚

ç°åœ¨ï¼Œæ›´è¿‘ä¸€æ­¥ï¼Œæˆ‘ä»¬æŠŠæ¢¯åº¦ä¹Ÿæ‹†å¼€ï¼Œæ¯ä¸ªGPUæ ¼å­ç»´æŠ¤ä¸€å—æ¢¯åº¦ã€‚

![](img/Pasted%20image%2020240720150045.png)

æ­¤æ—¶ï¼Œæ•°æ®å¹¶è¡Œçš„æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰æ¯å—GPUä¸Šå­˜ä¸€ä»½å®Œæ•´çš„å‚æ•°Wã€‚å°†ä¸€ä¸ªbatchçš„æ•°æ®åˆ†æˆ3ä»½ï¼Œæ¯å—GPUå„åƒä¸€ä»½ï¼Œåšå®Œä¸€è½®fowardå’Œbackwardåï¼Œ**ç®—å¾—ä¸€ä»½å®Œæ•´çš„æ¢¯åº¦ï¼ˆä¸‹å›¾ä¸­ç»¿è‰²+ç™½è‰²ï¼‰**ã€‚  
ï¼ˆ2ï¼‰å¯¹æ¢¯åº¦åšä¸€æ¬¡**Reduce-Scatter**ï¼Œä¿è¯æ¯ä¸ªGPUä¸Šæ‰€ç»´æŒçš„é‚£å—æ¢¯åº¦æ˜¯èšåˆæ¢¯åº¦ã€‚ä¾‹å¦‚å¯¹GPU1ï¼Œå®ƒè´Ÿè´£ç»´æŠ¤G1ï¼Œå› æ­¤å…¶ä»–çš„GPUåªéœ€è¦æŠŠG1å¯¹åº”ä½ç½®çš„æ¢¯åº¦å‘ç»™GPU1åšåŠ æ€»å°±å¯ã€‚æ±‡æ€»å®Œæ¯•åï¼Œç™½è‰²å—å¯¹GPUæ— ç”¨ï¼Œå¯ä»¥ä»æ˜¾å­˜ä¸­ç§»é™¤ã€‚å•å¡é€šè®¯é‡Â Î¦Â ã€‚ï¼ˆ1ï¼‰å’Œï¼ˆ2ï¼‰è§ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720150152.png)

ï¼ˆ3ï¼‰æ¯å—GPUç”¨è‡ªå·±å¯¹åº”çš„Oå’ŒGå»æ›´æ–°ç›¸åº”çš„Wã€‚æ›´æ–°å®Œæ¯•åï¼Œ**æ¯å—GPUç»´æŒäº†ä¸€å—æ›´æ–°å®Œæ¯•çš„W**ã€‚åŒç†ï¼Œå¯¹Wåšä¸€æ¬¡**All-Gather**ï¼Œå°†åˆ«çš„GPUç®—å¥½çš„WåŒæ­¥åˆ°è‡ªå·±è¿™æ¥ã€‚å•å¡é€šè®¯é‡Â Î¦Â **ã€‚**

çœ‹åˆ°è¿™é‡Œï¼Œä¹Ÿè®¸ä½ æœ‰ç‚¹æ„Ÿè§‰äº†ï¼Œ**ZeROçš„æ€æƒ³å°±æ˜¯ï¼šä¸‡ç‰©çš†å¯åˆ‡ï¼Œä¸‡ç‰©çš†å¯æŠ›**ã€‚æ‰€ä»¥ç°åœ¨ï¼Œæˆ‘ä»¬æŠŠå‚æ•°ä¹Ÿåˆ‡å¼€ã€‚æ¯å—GPUç½®ç»´æŒå¯¹åº”çš„optimizer statesï¼Œgradientså’Œparametersï¼ˆå³Wï¼‰ã€‚

![](img/Pasted%20image%2020240720150223.png)

æ•°æ®å¹¶è¡Œçš„æµç¨‹å¦‚ä¸‹ï¼š  
ï¼ˆ1ï¼‰æ¯å—GPUä¸Šåªä¿å­˜éƒ¨åˆ†å‚æ•°Wã€‚å°†ä¸€ä¸ªbatchçš„æ•°æ®åˆ†æˆ3ä»½ï¼Œæ¯å—GPUå„åƒä¸€ä»½ã€‚  
ï¼ˆ2ï¼‰åšforwardæ—¶ï¼Œå¯¹Wåšä¸€æ¬¡**All-Gather**ï¼Œå–å›åˆ†å¸ƒåœ¨åˆ«çš„GPUä¸Šçš„Wï¼Œå¾—åˆ°ä¸€ä»½å®Œæ•´çš„Wï¼Œå•å¡é€šè®¯é‡Â Î¦Â **ã€‚forwardåšå®Œï¼Œç«‹åˆ»æŠŠä¸æ˜¯è‡ªå·±ç»´æŠ¤çš„WæŠ›å¼ƒã€‚**  
ï¼ˆ3ï¼‰åšbackwardæ—¶ï¼Œå¯¹Wåšä¸€æ¬¡**All-Gather**ï¼Œå–å›å®Œæ•´çš„Wï¼Œå•å¡é€šè®¯é‡Â Î¦Â **ã€‚backwardåšå®Œï¼Œç«‹åˆ»æŠŠä¸æ˜¯è‡ªå·±ç»´æŠ¤çš„WæŠ›å¼ƒã€‚**  
ï¼ˆ4ï¼‰åšå®Œbackwardï¼Œç®—å¾—ä¸€ä»½å®Œæ•´çš„æ¢¯åº¦Gï¼Œå¯¹Gåšä¸€æ¬¡**Reduce-Scatter**ï¼Œä»åˆ«çš„GPUä¸Šèšåˆè‡ªå·±ç»´æŠ¤çš„é‚£éƒ¨åˆ†æ¢¯åº¦ï¼Œå•å¡é€šè®¯é‡Â Î¦Â **ã€‚èšåˆæ“ä½œç»“æŸåï¼Œç«‹åˆ»æŠŠä¸æ˜¯è‡ªå·±ç»´æŠ¤çš„GæŠ›å¼ƒ**ã€‚  
ï¼ˆ5ï¼‰ç”¨è‡ªå·±ç»´æŠ¤çš„Oå’ŒGï¼Œæ›´æ–°Wã€‚ç”±äºåªç»´æŠ¤éƒ¨åˆ†Wï¼Œå› æ­¤æ— éœ€å†å¯¹Wåšä»»ä½•AllReduceæ“ä½œã€‚

æ˜¾å­˜å’Œé€šè®¯é‡å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240720150256.png)

åˆ°è¿™ä¸€æ­¥ï¼Œ**æˆ‘ä»¬ç”¨1.5å€çš„é€šè®¯å¼€é”€ï¼Œæ¢å›è¿‘120å€çš„æ˜¾å­˜**ã€‚åªè¦æ¢¯åº¦è®¡ç®—å’Œå¼‚æ­¥æ›´æ–°åšçš„å¥½ï¼Œé€šè®¯æ—¶é—´å¤§éƒ¨åˆ†å¯ä»¥è¢«è®¡ç®—æ—¶é—´éšè—ï¼Œå› æ­¤è¿™æ ·çš„é¢å¤–é€šè®¯å¼€é”€ï¼Œä¹Ÿæ˜¯åˆ’ç®—çš„

å…¶å®**ZeROæ˜¯æ¨¡å‹å¹¶è¡Œçš„å½¢å¼ï¼Œæ•°æ®å¹¶è¡Œçš„å®è´¨**ã€‚  
æ¨¡å‹å¹¶è¡Œï¼Œæ˜¯æŒ‡åœ¨forwardå’Œbackwardçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘åªéœ€è¦ç”¨è‡ªå·±ç»´æŠ¤çš„é‚£å—Wæ¥è®¡ç®—å°±è¡Œã€‚å³**åŒæ ·çš„è¾“å…¥Xï¼Œæ¯å—GPUä¸Šå„ç®—æ¨¡å‹çš„ä¸€éƒ¨åˆ†ï¼Œæœ€åé€šè¿‡æŸäº›æ–¹å¼èšåˆç»“æœ**ã€‚  
ä½†å¯¹ZeROæ¥è¯´ï¼Œå®ƒåšforwardå’Œbackwardçš„æ—¶å€™ï¼Œæ˜¯éœ€è¦æŠŠå„GPUä¸Šç»´æŠ¤çš„Wèšåˆèµ·æ¥çš„ï¼Œå³æœ¬è´¨ä¸Šè¿˜æ˜¯ç”¨å®Œæ•´çš„Wè¿›è¡Œè®¡ç®—ã€‚**å®ƒæ˜¯ä¸åŒçš„è¾“å…¥Xï¼Œå®Œæ•´çš„å‚æ•°Wï¼Œæœ€ç»ˆå†åšèšåˆ**ã€‚

#### ZeRO-R

è¯´å®Œäº†ä»¥ä¸Šå¯¹model statesçš„æ˜¾å­˜ä¼˜åŒ–ï¼Œç°åœ¨æ¥çœ‹å¯¹residual statesçš„ä¼˜åŒ–ã€‚

**Partitioned Activation Checkpointing**   å‰é¢è¯´è¿‡ï¼Œå¯¹activationçš„å­˜å‚¨æ˜¯çµæ´»çš„ã€‚ä¸åƒoptimizer statesï¼Œgradientså’Œparameterså¯¹æ¨¡å‹æ›´æ–°æ˜¯å¿…é¡»çš„ï¼Œactivationåªæ˜¯èµ·åˆ°åŠ é€Ÿæ¢¯åº¦è®¡ç®—çš„ä½œç”¨ã€‚å› æ­¤ï¼Œåœ¨å“ªå‡ å±‚ä¿å­˜activationï¼Œä¿å­˜å“ªäº›activationéƒ½æ˜¯å¯ä»¥çµæ´»è®¾ç½®çš„ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä»¿ç…§ä»¥ä¸Šåˆ‡å‰²æ–¹å¼ï¼Œæ¯å—GPUä¸Šåªç»´æŠ¤éƒ¨åˆ†çš„activationï¼Œéœ€è¦æ—¶å†ä»åˆ«çš„åœ°æ–¹èšåˆè¿‡æ¥å°±è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œactivationå¯¹æ˜¾å­˜çš„å ç”¨ä¸€èˆ¬ä¼šè¿œé«˜äºæ¨¡å‹æœ¬èº«ï¼Œé€šè®¯é‡ä¹Ÿæ˜¯å·¨å¤§çš„ï¼Œæ‰€ä»¥è¿™å—è¦çµæ´»ã€æœ‰æ•ˆåœ°å®éªŒè®¾è®¡ã€‚

**Constant Size Buffer**  å›ºå®šå¤§å°çš„å†…å­˜bufferï¼Œå®ƒçš„ç›®çš„åœ¨äºï¼š

- æå‡å¸¦å®½åˆ©ç”¨ç‡ã€‚å½“GPUæ•°é‡ä¸Šå‡ï¼ŒGPUé—´çš„é€šè®¯æ¬¡æ•°ä¹Ÿä¸Šå‡ï¼Œæ¯æ¬¡çš„é€šè®¯é‡å¯èƒ½ä¸‹é™ï¼ˆä½†æ€»é€šè®¯é‡ä¸ä¼šå˜ï¼‰ã€‚æ•°æ®åˆ‡ç‰‡å°äº†ï¼Œå°±ä¸èƒ½å¾ˆå¥½åˆ©ç”¨å¸¦å®½äº†ã€‚æ‰€ä»¥è¿™ä¸ªbufferèµ·åˆ°äº†ç§¯æ”’æ•°æ®çš„ä½œç”¨ï¼šç­‰æ•°æ®ç§¯æ”’åˆ°ä¸€å®šå¤§å°ï¼Œå†è¿›è¡Œé€šè®¯ã€‚
- ä½¿å¾—å­˜å‚¨å¤§å°å¯æ§ã€‚åœ¨æ¯æ¬¡é€šè®¯å‰ï¼Œç§¯æ”’çš„å­˜å‚¨å¤§å°æ˜¯å¸¸é‡ï¼Œæ˜¯å·²çŸ¥å¯æ§çš„ã€‚æ›´æ–¹ä¾¿ä½¿ç”¨è€…å¯¹è®­ç»ƒä¸­çš„å­˜å‚¨æ¶ˆè€—å’Œé€šè®¯æ—¶é—´è¿›è¡Œé¢„ä¼°ã€‚

**Memory Defragmentation**    è®¾ç½®æœºåˆ¶ï¼Œå¯¹ç¢ç‰‡åŒ–çš„å­˜å‚¨ç©ºé—´è¿›è¡Œé‡æ–°æ•´åˆï¼Œæ•´å‡ºè¿ç»­çš„å­˜å‚¨ç©ºé—´ã€‚é˜²æ­¢å‡ºç°æ€»å­˜å‚¨è¶³å¤Ÿï¼Œä½†è¿ç»­å­˜å‚¨ä¸å¤Ÿè€Œå¼•èµ·çš„å­˜å‚¨è¯·æ±‚fail


#### ZeRO-Offloadä¸ZeRO-Infinity

ZeRO-Offloadã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**æ˜¾å­˜ä¸å¤Ÿï¼Œå†…å­˜æ¥å‡‘**ã€‚å¦‚æœæˆ‘æŠŠè¦å­˜å‚¨çš„å¤§å¤´å¸è½½(offload)åˆ°CPUä¸Šï¼Œè€ŒæŠŠè®¡ç®—éƒ¨åˆ†æ”¾åˆ°GPUä¸Šï¼Œ**è¿™æ ·æ¯”èµ·è·¨æœºï¼Œæ˜¯ä¸æ˜¯èƒ½æ—¢é™æ˜¾å­˜ï¼Œä¹Ÿèƒ½å‡å°‘ä¸€äº›é€šè®¯å‹åŠ›å‘¢**ï¼Ÿ  
ZeRO-Offloadçš„åšæ³•æ˜¯ï¼š

- **forwardå’Œbackwardè®¡ç®—é‡é«˜**ï¼Œå› æ­¤å’Œå®ƒä»¬ç›¸å…³çš„éƒ¨åˆ†ï¼Œä¾‹å¦‚å‚æ•°Wï¼ˆfp16ï¼‰ï¼Œactivationï¼Œå°±å…¨æ”¾å…¥GPUã€‚
- **updateçš„éƒ¨åˆ†è®¡ç®—é‡ä½**ï¼Œå› æ­¤å’Œå®ƒç›¸å…³çš„éƒ¨åˆ†ï¼Œå…¨éƒ¨æ”¾å…¥CPUä¸­ã€‚ä¾‹å¦‚W(fp32)ï¼Œoptimizer statesï¼ˆfp32ï¼‰å’Œgradients(fp16)ç­‰ã€‚

å…·ä½“åˆ‡åˆ†å¦‚ä¸‹å›¾ï¼š

![](img/Pasted%20image%2020240720150703.png)

ZeRO-infinityä¹Ÿæ˜¯åŒç†ï¼Œå®ƒä»¬åœ¨è§£å†³çš„äº‹æƒ…éƒ½æ˜¯ï¼šæ‰¾ä¸ªé™¤GPUä¹‹å¤–çš„åœ°æ–¹ï¼Œå­˜æ•°æ®ã€‚

## å¼ é‡å¹¶è¡Œ

åœ¨å¼ é‡å¹¶è¡Œ (TP) ä¸­ï¼Œæ¯ä¸ª GPU ä»…å¤„ç†å¼ é‡çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶ä¸”ä»…å½“æŸäº›ç®—å­éœ€è¦å®Œæ•´çš„å¼ é‡æ—¶æ‰è§¦å‘èšåˆæ“ä½œã€‚

æŒ‰è¡Œåˆ‡åˆ†

![](img/Pasted%20image%2020240727162248.png)

æŒ‰åˆ—åˆ‡åˆ†

![](img/Pasted%20image%2020240727162305.png)

![å¹¶è¡Œ GEMM](https://devrel.andfun.cn/devrel/posts/2023/03/xZpvda.jpg)
### MLPå±‚

åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Â [Megatron-LMÂ 4](https://github.com/NVIDIA/Megatron-LM)Â è®ºæ–‡Â [Efficient Large-Scale Language Model Training on GPU ClustersÂ 3](https://arxiv.org/abs/2104.04473)Â ä¸­çš„æ¦‚å¿µå’Œå›¾è¡¨ã€‚

MLPå±‚è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š

![](https://pic1.zhimg.com/v2-d975a182edcec8003fcbc84e650a81c0_b.jpg)

å‡è®¾ç°åœ¨æœ‰Nå—GPUï¼Œæˆ‘ä»¬è¦æŠŠMLPå±‚çš„æƒé‡æ‹†åˆ°ä¸Šé¢åšè®¡ç®—ï¼Œè¦æ€ä¹ˆæ‹†åˆ†å‘¢ï¼ŸMegatronæä¾›çš„æ‹†åˆ†åŠæ³•å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240727162440.png)

åœ¨MLPå±‚ä¸­ï¼Œ**å¯¹Aé‡‡ç”¨â€œåˆ—åˆ‡å‰²â€ï¼Œå¯¹Bé‡‡ç”¨â€œè¡Œåˆ‡å‰²â€**ã€‚

- `f`Â çš„forwardè®¡ç®—ï¼šæŠŠè¾“å…¥Xæ‹·è´åˆ°ä¸¤å—GPUä¸Šï¼Œæ¯å—GPUå³å¯ç‹¬ç«‹åšforwardè®¡ç®—ã€‚
- `g`Â çš„forwardè®¡ç®—ï¼šæ¯å—GPUä¸Šçš„forwardçš„è®¡ç®—å®Œæ¯•ï¼Œå–å¾—Z1å’ŒZ2åï¼ŒGPUé—´åšä¸€æ¬¡**AllReduce**ï¼Œç›¸åŠ ç»“æœäº§ç”ŸZã€‚
- `g`Â çš„backwardè®¡ç®—ï¼šåªéœ€è¦æŠŠÂ âˆ‚ğ¿/âˆ‚ğ‘Â æ‹·è´åˆ°ä¸¤å—GPUä¸Šï¼Œä¸¤å—GPUå°±èƒ½å„è‡ªç‹¬ç«‹åšæ¢¯åº¦è®¡ç®—ã€‚
- `f`Â çš„backwardè®¡ç®—ï¼šå½“å½“å‰å±‚çš„æ¢¯åº¦è®¡ç®—å®Œæ¯•ï¼Œéœ€è¦ä¼ é€’åˆ°ä¸‹ä¸€å±‚ç»§ç»­åšæ¢¯åº¦è®¡ç®—æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ±‚å¾—Â âˆ‚ğ¿/âˆ‚ğ‘‹Â ã€‚åˆ™æ­¤æ—¶ä¸¤å—GPUåšä¸€æ¬¡**AllReduce**ï¼ŒæŠŠå„è‡ªçš„æ¢¯åº¦Â âˆ‚ğ¿/âˆ‚ğ‘‹|1Â å’ŒÂ âˆ‚ğ¿/âˆ‚ğ‘‹|2Â ç›¸åŠ å³å¯ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯¹Aé‡‡ç”¨åˆ—åˆ‡å‰²ï¼Œå¯¹Bé‡‡ç”¨è¡Œåˆ‡å‰²å‘¢ï¼Ÿ**è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯ï¼Œæˆ‘ä»¬å°½é‡ä¿è¯å„GPUä¸Šçš„è®¡ç®—ç›¸äº’ç‹¬ç«‹ï¼Œå‡å°‘é€šè®¯é‡**ã€‚å¯¹Aæ¥è¯´ï¼Œéœ€è¦åšä¸€æ¬¡GELUçš„è®¡ç®—ï¼Œè€ŒGELUå‡½æ•°æ˜¯éçº¿å½¢çš„ï¼Œå®ƒçš„æ€§è´¨å¦‚ä¸‹ï¼š

![](https://pic3.zhimg.com/v2-ece343729db7067dbe8077de45a8acca_b.jpg)

  
ä¹Ÿå°±æ„å‘³ç€ï¼Œå¦‚æœå¯¹Aé‡‡ç”¨è¡Œåˆ‡å‰²ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨åšGELUå‰ï¼Œåšä¸€æ¬¡AllReduceï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿé¢å¤–é€šè®¯é‡ã€‚ä½†æ˜¯å¦‚æœå¯¹Aé‡‡ç”¨åˆ—åˆ‡å‰²ï¼Œé‚£æ¯å—GPUå°±å¯ä»¥ç»§ç»­ç‹¬ç«‹è®¡ç®—äº†ã€‚ä¸€æ—¦ç¡®è®¤å¥½Aåšåˆ—åˆ‡å‰²ï¼Œé‚£ä¹ˆä¹Ÿå°±ç›¸åº”å®šå¥½Béœ€è¦åšè¡Œåˆ‡å‰²äº†ã€‚

ä½¿ç”¨è¯¥åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°ä»»æ„æ·±åº¦çš„ MLPï¼Œåªéœ€åœ¨æ¯ä¸ªÂ `æ‹†åˆ— - æ‹†è¡Œ`Â åºåˆ—ä¹‹ååŒæ­¥ GPUã€‚ Megatron-LM è®ºæ–‡ä½œè€…ä¸ºæ­¤æä¾›äº†ä¸€ä¸ªä¸é”™çš„å›¾ç¤º:

![å¹¶è¡Œåˆ†ç‰‡å¤„ç†](https://devrel.andfun.cn/devrel/posts/2023/03/rQsQ8h.jpg)

è¿™é‡ŒÂ `f`Â æ˜¯å‰å‘ä¼ æ’­ä¸­çš„æ’ç­‰è¿ç®—ç¬¦ï¼Œåå‘ä¼ æ’­ä¸­çš„ all reduceï¼Œè€ŒÂ `g`Â æ˜¯å‰å‘ä¼ æ’­ä¸­çš„ all reduce å’Œåå‘ä¼ æ’­ä¸­çš„æ’ç­‰å¼ã€‚

å¹¶è¡ŒåŒ–å¤šå¤´æ³¨æ„åŠ›å±‚ç”šè‡³æ›´ç®€å•ï¼Œå› ä¸ºå®ƒä»¬æœ¬æ¥å°±æ˜¯å¹¶è¡Œçš„ï¼Œå› ä¸ºæœ‰å¤šä¸ªç‹¬ç«‹çš„å¤´ï¼

![å¹¶è¡Œè‡ªæ³¨æ„åŠ›](https://devrel.andfun.cn/devrel/posts/2023/03/MVTuqE.jpg)

å¯¹ä¸‰ä¸ªå‚æ•°çŸ©é˜µQï¼ŒKï¼ŒVï¼Œ**æŒ‰ç…§â€œåˆ—åˆ‡å‰²â€**ï¼Œæ¯ä¸ªå¤´æ”¾åˆ°ä¸€å—GPUä¸Šï¼Œåšå¹¶è¡Œè®¡ç®—ã€‚å¯¹çº¿æ€§å±‚Bï¼Œ**æŒ‰ç…§â€œè¡Œåˆ‡å‰²â€**ã€‚åˆ‡å‰²çš„æ–¹å¼å’ŒMLPå±‚åŸºæœ¬ä¸€è‡´ï¼Œå…¶forwardä¸backwardåŸç†ä¹Ÿä¸€è‡´ã€‚  

æœ€åï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œ**å¹¶ä¸ä¸€å®šæŒ‰ç…§ä¸€ä¸ªheadå ç”¨ä¸€å—GPUæ¥åˆ‡å‰²æƒé‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¸€ä¸ªå¤šä¸ªheadå ç”¨ä¸€å—GPUï¼Œè¿™ä¾ç„¶ä¸ä¼šæ”¹å˜å•å—GPUä¸Šç‹¬ç«‹è®¡ç®—çš„ç›®çš„ã€‚æ‰€ä»¥å®é™…è®¾è®¡æ—¶ï¼Œæˆ‘ä»¬å°½é‡ä¿è¯headæ€»æ•°èƒ½è¢«GPUä¸ªæ•°æ•´é™¤ã€‚**

éœ€è¦ç‰¹åˆ«è€ƒè™‘çš„æ˜¯: ç”±äºå‰å‘å’Œåå‘ä¼ æ’­ä¸­æ¯å±‚éƒ½æœ‰ä¸¤ä¸ª all reduceï¼Œå› æ­¤ TP éœ€è¦è®¾å¤‡é—´æœ‰éå¸¸å¿«é€Ÿçš„äº’è”ã€‚å› æ­¤ï¼Œé™¤éä½ æœ‰ä¸€ä¸ªéå¸¸å¿«çš„ç½‘ç»œï¼Œå¦åˆ™ä¸å»ºè®®è·¨å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œ TPã€‚æˆ‘ä»¬è®­ç»ƒ BLOOM çš„ç¡¬ä»¶é…ç½®ä¸­ï¼ŒèŠ‚ç‚¹é—´çš„é€Ÿåº¦æ¯” PCIe æ…¢å¾ˆå¤šã€‚å®é™…ä¸Šï¼Œå¦‚æœèŠ‚ç‚¹æœ‰ 4 ä¸ª GPUï¼Œåˆ™æœ€é«˜ TP åº¦è®¾ä¸º 4 æ¯”è¾ƒå¥½ã€‚å¦‚æœéœ€è¦ TP åº¦ä¸º 8ï¼Œåˆ™éœ€è¦ä½¿ç”¨è‡³å°‘æœ‰ 8 ä¸ª GPU çš„èŠ‚ç‚¹ã€‚

è¯¥ç»„ä»¶ç”± Megatron-LM å®ç°ã€‚ Megatron-LM æœ€è¿‘æ‰©å±•äº†å¼ é‡å¹¶è¡Œèƒ½åŠ›ï¼Œæ–°å¢äº†åºåˆ—å¹¶è¡Œçš„èƒ½åŠ›ï¼Œç”¨äºéš¾ä»¥ä½¿ç”¨å‰è¿°åˆ‡åˆ†ç®—æ³•çš„ç®—å­ï¼Œå¦‚ LayerNormã€‚[Reducing Activation Recomputation in Large Transformer ModelsÂ 2](https://arxiv.org/abs/2205.05198)Â è®ºæ–‡æä¾›äº†æ­¤æŠ€æœ¯çš„è¯¦ç»†ä¿¡æ¯ã€‚åºåˆ—å¹¶è¡Œæ˜¯åœ¨è®­ç»ƒ BLOOM ä¹‹åå¼€å‘çš„ï¼Œæ‰€ä»¥ BLOOM è®­ç»ƒæ—¶å¹¶æœªé‡‡ç”¨æ­¤æŠ€æœ¯ã€‚

### Embeddingå±‚

æˆ‘ä»¬çŸ¥é“Embeddingå±‚ä¸€èˆ¬ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- **word embedding**ï¼šç»´åº¦(v, h)ï¼Œå…¶ä¸­vè¡¨ç¤ºè¯è¡¨å¤§å°ã€‚
- **positional embedding**ï¼šç»´åº¦(max_s, h)ï¼Œå…¶ä¸­max_sè¡¨ç¤ºæ¨¡å‹å…è®¸çš„æœ€å¤§åºåˆ—é•¿åº¦ã€‚

å¯¹positional embeddingæ¥è¯´ï¼Œmax_sæœ¬èº«ä¸ä¼šå¤ªé•¿ï¼Œå› æ­¤æ¯ä¸ªGPUä¸Šéƒ½æ‹·è´ä¸€ä»½ï¼Œå¯¹æ˜¾å­˜çš„å‹åŠ›ä¹Ÿä¸ä¼šå¤ªå¤§ã€‚ä½†æ˜¯å¯¹word embeddingæ¥è¯´ï¼Œè¯è¡¨çš„å¤§å°å°±å¾ˆå®¢è§‚äº†ï¼Œå› æ­¤éœ€è¦æŠŠword embeddingæ‹†åˆ†åˆ°å„ä¸ªGPUä¸Šï¼Œå…·ä½“çš„åšæ³•å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240727163034.png)

æˆ‘ä»¬æ¥è¯¦ç»†è¯´æ˜ä¸‹è¿™å¼ å›¾ã€‚å¯¹äºè¾“å…¥Xï¼Œè¿‡word embeddingçš„è¿‡ç¨‹ï¼Œå°±æ˜¯ç­‰äºç”¨tokençš„åºå·å»word embeddingä¸­æŸ¥æ‰¾å¯¹åº”è¯å‘é‡çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼Œè¾“å…¥æ•°æ®ä¸º[0, 212, 7, 9]ï¼Œæ•°æ®ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨è¯åºå·ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å»word embeddingä¸­çš„0ï¼Œ212ï¼Œ7ï¼Œ9è¡Œå»æŠŠç›¸åº”çš„è¯å‘é‡æ‰¾å‡ºæ¥ã€‚

  
å‡è®¾è¯è¡¨ä¸­æœ‰300ä¸ªè¯ï¼Œç°åœ¨æˆ‘ä»¬å°†word embeddingæ‹†åˆ†åˆ°ä¸¤å—GPUä¸Šï¼Œç¬¬ä¸€å—GPUç»´æŠ¤è¯è¡¨[0, 150)ï¼Œç¬¬äºŒå—GPUç»´æŠ¤è¯è¡¨[150, 299)ã€‚å½“è¾“å…¥Xå»GPUä¸ŠæŸ¥æ‰¾æ—¶ï¼Œèƒ½æ‰¾åˆ°çš„è¯ï¼Œå°±æ­£å¸¸è¿”å›è¯å‘é‡ï¼Œæ‰¾åˆ°ä¸åˆ°å°±æŠŠè¯å‘é‡ä¸­çš„å…¨éƒ¨å…¨ç´ éƒ½ç½®0ã€‚æŒ‰æ­¤æ–¹å¼æŸ¥æ‰¾å®Œæ¯•åï¼Œæ¯å—GPUä¸Šçš„æ•°æ®åšä¸€æ¬¡AllReduceï¼Œå°±èƒ½å¾—åˆ°æœ€ç»ˆçš„è¾“å…¥ã€‚  

ä¾‹å¦‚ä¾‹å­ä¸­ï¼Œç¬¬ä¸€å—GPUçš„æŸ¥æ‰¾ç»“æœä¸º[ok, 0, ok, ok]ï¼Œç¬¬äºŒå—ä¸º[0, ok, 0, 0]ï¼Œä¸¤ä¸ªå‘é‡ä¸€ç›¸åŠ ï¼Œå˜ä¸º[ok, ok, ok, ok]

è¾“å‡ºå±‚ä¸­ï¼ŒåŒæ ·æœ‰ä¸€ä¸ªword embeddingï¼ŒæŠŠè¾“å…¥å†æ˜ å°„å›è¯è¡¨é‡Œï¼Œå¾—åˆ°æ¯ä¸€ä¸ªä½ç½®çš„è¯ã€‚ä¸€**èˆ¬æ¥è¯´ï¼Œè¾“å…¥å±‚å’Œè¾“å‡ºå±‚å…±ç”¨ä¸€ä¸ªword embeding**ã€‚å…¶è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240727163130.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**æˆ‘ä»¬å¿…é¡»æ—¶åˆ»ä¿è¯è¾“å…¥å±‚å’Œè¾“å‡ºå±‚å…±ç”¨ä¸€å¥—word embedding**ã€‚è€Œåœ¨backwardçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬åœ¨è¾“å‡ºå±‚æ—¶ä¼šå¯¹word embeddingè®¡ç®—ä¸€æ¬¡æ¢¯åº¦ï¼Œåœ¨è¾“å…¥å±‚ä¸­è¿˜ä¼šå¯¹word embeddingè®¡ç®—ä¸€æ¬¡æ¢¯åº¦ã€‚åœ¨ç”¨æ¢¯åº¦åšword embeddingæƒé‡æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯ç”¨ä¸¤æ¬¡æ¢¯åº¦çš„æ€»å’Œè¿›è¡Œæ›´æ–°ã€‚

  
**å½“æ¨¡å‹çš„è¾“å…¥å±‚åˆ°è¾“å…¥å±‚éƒ½åœ¨ä¸€å—GPUä¸Šæ—¶ï¼ˆå³æµæ°´çº¿å¹¶è¡Œæ·±åº¦=1ï¼‰ï¼Œæˆ‘ä»¬ä¸å¿…æ‹…å¿ƒè¿™ç‚¹ï¼ˆå®è·µä¸­å¤§éƒ¨åˆ†ç”¨Megatronåšå¹¶è¡Œçš„é¡¹ç›®ä¹Ÿæ˜¯è¿™ä¹ˆåšçš„ï¼‰ã€‚ä½†è‹¥æ¨¡å‹è¾“å…¥å±‚å’Œè¾“å‡ºå±‚åœ¨ä¸åŒçš„GPUä¸Šæ—¶ï¼Œæˆ‘ä»¬å°±è¦ä¿è¯åœ¨æƒé‡æ›´æ–°å‰ï¼Œä¸¤å—GPUä¸Šçš„word embeddingæ¢¯åº¦åšäº†ä¸€æ¬¡AllReduce**ã€‚

### Cross-entropyå±‚

è¾“å‡ºå±‚è¿‡å®Œembeddingåçš„æ ·å­ï¼š

![](https://pic4.zhimg.com/v2-96e301278d67821d7ceab462aeac581f_b.jpg)

  
æ­£å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦å¯¹Y1å’ŒY2åšä¸€æ¬¡**All-Gather**ï¼ŒæŠŠå®ƒä»¬concatèµ·æ¥å½¢æˆYï¼Œç„¶åå¯¹Yçš„æ¯ä¸€è¡Œåšsoftmaxï¼Œå°±å¯å¾—åˆ°å¯¹äºå½“å‰ä½ç½®æ¥è¯´ï¼Œæ¯ä¸ªè¯å‡ºç°çš„æ¦‚ç‡ã€‚æ¥ç€ï¼Œå†ç”¨æ­¤æ¦‚ç‡å’ŒçœŸå€¼ç»„åšcross-entropyå³å¯ã€‚  
ä½†æ˜¯All-Gatherä¼šäº§ç”Ÿé¢å¤–çš„é€šè®¯é‡Â ğ‘âˆ—ğ‘ âˆ—ğ‘£Â ã€‚å½“è¯è¡¨vå¾ˆå¤§æ—¶ï¼Œè¿™ä¸ªé€šè®¯å¼€é”€ä¹Ÿä¸å®¹å¿½è§†ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå¯ä»¥åšå¦‚ä¸‹ä¼˜åŒ–ï¼š

![](img/Pasted%20image%2020240727163259.png)

- æ¯å—GPUä¸Šï¼Œæˆ‘ä»¬å¯ä»¥å…ˆæŒ‰è¡Œæ±‚å’Œï¼Œå¾—åˆ°å„è‡ªGPUä¸Šçš„GPU_sum(e)
- å°†æ¯å—GPUä¸Šç»“æœåšAllReduceï¼Œå¾—åˆ°æ¯è¡Œæœ€ç»ˆçš„sum(e)ï¼Œä¹Ÿå°±softmaxä¸­çš„åˆ†æ¯ã€‚æ­¤æ—¶çš„**é€šè®¯é‡**ä¸ºÂ ğ‘âˆ—ğ‘ 
- åœ¨æ¯å—GPUä¸Šï¼Œå³å¯è®¡ç®—å„è‡ªç»´æŠ¤éƒ¨åˆ†çš„e/sum(e)ï¼Œå°†å…¶ä¸çœŸå€¼åšcross-entropyï¼Œå¾—åˆ°æ¯è¡Œçš„lossï¼ŒæŒ‰è¡ŒåŠ æ€»èµ·æ¥ä»¥åå¾—åˆ°GPUä¸Šscalar Lossã€‚
- å°†GPUä¸Šçš„scalar LossåšAllReduceï¼Œå¾—åˆ°æ€»Lossã€‚æ­¤æ—¶é€šè®¯é‡ä¸ºNã€‚

è¿™æ ·ï¼Œæˆ‘ä»¬æŠŠåŸå…ˆçš„é€šè®¯é‡ä»Â ğ‘âˆ—ğ‘ âˆ—ğ‘£Â å¤§å¤§é™è‡³Â ğ‘âˆ—ğ‘ +ğ‘Â ã€‚



## æµæ°´çº¿å¹¶è¡Œ

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæµæ°´çº¿å¹¶è¡Œå¹¶ä¸ç‰¹åˆ«æµè¡Œï¼Œä¸»è¦åŸå› æ˜¯æ¨¡å‹èƒ½å¦å‡åŒ€åˆ‡å‰²ï¼Œå½±å“äº†æ•´ä½“è®¡ç®—æ•ˆç‡ï¼Œè¿™å°±éœ€è¦ç®—æ³•å·¥ç¨‹å¸ˆåšæ‰‹è°ƒã€‚

åœ¨[â€œå¼ é‡å¹¶è¡Œâ€](https://nanotron-ultrascale-playbook.static.hf.space/dist/index.html?section=high_level_overview#tensor-parallelism)éƒ¨åˆ†ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œå°è¯•å°†å¼ é‡å¹¶è¡Œæ‰©å±•åˆ°è¶…è¿‡æ¯ä¸ªèŠ‚ç‚¹çš„ GPU æ•°é‡ï¼ˆé€šå¸¸ä¸º 4 æˆ– 8ï¼‰æ—¶ï¼Œä¼šé‡åˆ°å¸¦å®½è¾ƒä½çš„ç½‘ç»œï¼ˆç§°ä¸ºâ€œèŠ‚ç‚¹é—´è¿æ¥â€ï¼‰ï¼Œè¿™ä¼šä¸¥é‡å½±å“æˆ‘ä»¬çš„æ€§èƒ½ã€‚å½“æˆ‘ä»¬åœ¨è·¨å¤šä¸ªèŠ‚ç‚¹ï¼ˆæ¯ä¸ªèŠ‚ç‚¹æœ‰ 8 ä¸ª GPUï¼‰çš„é›†ç¾¤ä¸Šå¯¹ all-reduce æ“ä½œè¿›è¡ŒåŸºå‡†æµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š

![](img1/Pasted%20image%2020250309172451.png)

è·¨ä¸åŒèŠ‚ç‚¹æ•°çš„èŠ‚ç‚¹é—´é€šä¿¡å¸¦å®½æµ‹é‡ï¼Œæ˜¾ç¤º AllReduceã€AllGather å’Œ ReduceScatter æ“ä½œçš„ä¸­ä½æ•°ï¼ˆçº¿ï¼‰å’Œ 5 è‡³ 95 ç™¾åˆ†ä½èŒƒå›´ï¼ˆé˜´å½±åŒºåŸŸï¼‰ã€‚


å¯¹äºå¤§å‹æ¨¡å‹ (70B+)ï¼Œä»…æƒé‡çš„å¤§å°å°±å·²ç»è¶…å‡ºäº†å•ä¸ªèŠ‚ç‚¹ä¸Š 4-8 ä¸ª GPU çš„é™åˆ¶ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨â€œç®¡é“å¹¶è¡Œæ€§â€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

æµæ°´çº¿å¹¶è¡Œæ˜¯ä¸€ç§ç®€å•ä½†åŠŸèƒ½å¼ºå¤§çš„æŠ€æœ¯ - æˆ‘ä»¬å°†æ¨¡å‹çš„å±‚æ‹†åˆ†åˆ°å¤šä¸ª GPU ä¸Šï¼ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 8 ä¸ª GPUï¼Œæˆ‘ä»¬å¯ä»¥å°†å±‚ 1-4 æ”¾åœ¨ GPU 1 ä¸Šï¼Œå°†å±‚ 5-8 æ”¾åœ¨ GPU 2 ä¸Šï¼Œä¾æ­¤ç±»æ¨ã€‚è¿™æ ·ï¼Œæ¯ä¸ª GPU åªéœ€è¦å­˜å‚¨å’Œå¤„ç†æ¨¡å‹å±‚çš„ä¸€éƒ¨åˆ†ï¼Œä»è€Œæ˜¾è‘—å‡å°‘æ¯ä¸ª GPU çš„å†…å­˜éœ€æ±‚ã€‚è®©æˆ‘ä»¬çœ‹çœ‹æµæ°´çº¿å¹¶è¡Œå¯¹ 8B æ¨¡å‹å†…å­˜ä½¿ç”¨é‡çš„å½±å“ï¼š


![](img1/Pasted%20image%2020250309172615.png)

çœ‹ä¸Šå›¾ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ä¸€äº›æœ‰è¶£çš„äº‹æƒ…ï¼šè™½ç„¶æ¨¡å‹å‚æ•°åœ¨å„ä¸ª GPU ä¹‹é—´å¾ˆå¥½åœ°åˆ†å‰²ï¼Œä½†æ¿€æ´»å†…å­˜åœ¨æ¯ä¸ª GPU ä¸Šä¿æŒä¸å˜ï¼è¿™æ˜¯å› ä¸ºæ¯ä¸ª GPU ä»ç„¶éœ€è¦å¤„ç†æ•´æ‰¹æ•°æ®ï¼Œåªæ˜¯å±‚æ•°ä¸åŒã€‚ä¸€ä¸ª GPU å±‚çš„æ¿€æ´»å°†å‘é€åˆ°ä¸‹ä¸€ä¸ª GPU ä»¥ç»§ç»­å‰å‘ä¼ é€’ã€‚

è¿™å¼•å…¥äº†ä¸€ç§æ–°å‹é€šä¿¡æ¨¡å¼ï¼šæˆ‘ä»¬ä¸å†åƒ ZeRO-3 åœ¨æ•°æ®å¹¶è¡Œä¸­é‚£æ ·ä¼ é€’å‚æ•°ï¼Œè€Œæ˜¯åœ¨â€œç®¡é“â€ä¸­æŒ‰é¡ºåºåœ¨ GPU ä¹‹é—´ä¼ é€’æ¿€æ´»å¼ é‡ã€‚


### AFABï¼ˆåœ¨å„ä¸ªèŠ‚ç‚¹ä¸Šæ‹†åˆ†å±‚ - All forward, all backwardï¼‰

**æœ´ç´ æµæ°´çº¿å¹¶è¡Œ (naive PP)** æ˜¯å°†æ¨¡å‹å„å±‚åˆ†ç»„åˆ†å¸ƒåœ¨å¤šä¸ª GPU ä¸Šï¼Œå¹¶ç®€å•åœ°å°†æ•°æ®ä» GPU ç§»åŠ¨åˆ° GPUï¼Œå°±å¥½åƒå®ƒæ˜¯ä¸€ä¸ªå¤§å‹å¤åˆ GPU ä¸€æ ·ã€‚è¯¥æœºåˆ¶ç›¸å¯¹ç®€å• - å°†æ‰€éœ€å±‚ç”¨Â `.to()`Â æ–¹æ³•ç»‘åˆ°ç›¸åº”è®¾å¤‡ï¼Œç°åœ¨åªè¦æ•°æ®è¿›å‡ºè¿™äº›å±‚ï¼Œè¿™äº›å±‚å°±ä¼šå°†æ•°æ®åˆ‡æ¢åˆ°ä¸è¯¥å±‚ç›¸åŒçš„è®¾å¤‡ï¼Œå…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚

è¿™å…¶å®å°±æ˜¯å‚ç›´æ¨¡å‹å¹¶è¡Œï¼Œå› ä¸ºå¦‚æœä½ è¿˜è®°å¾—æˆ‘ä»¬æ˜¯æ€ä¹ˆç”»å¤§å¤šæ•°æ¨¡å‹çš„æ‹“æ‰‘å›¾çš„ï¼Œæˆ‘ä»¬å…¶å®æ˜¯å‚ç›´åˆ‡åˆ†æ¨¡å‹å„å±‚çš„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸‹å›¾æ˜¾ç¤ºä¸€ä¸ª 8 å±‚æ¨¡å‹:

| 0 | 1 | 2 | 3  | |  4 | 5 | 6 | 7 |  

æˆ‘ä»¬å°†å®ƒå‚ç›´åˆ‡æˆ 2 éƒ¨åˆ†ï¼Œå°†å±‚ 0-3 æ”¾ç½®åœ¨ GPU0 ä¸Šï¼Œå°†å±‚ 4-7 æ”¾ç½®åœ¨ GPU1 ä¸Šã€‚

ç°åœ¨ï¼Œå½“æ•°æ®ä»ç¬¬ 0 å±‚ä¼ åˆ°ç¬¬ 1 å±‚ã€ç¬¬ 1 å±‚ä¼ åˆ°ç¬¬ 2 å±‚ä»¥åŠç¬¬ 2 å±‚ä¼ åˆ°ç¬¬ 3 å±‚æ—¶ï¼Œè¿™å°±è·Ÿå• GPU ä¸Šçš„æ™®é€šå‰å‘ä¼ æ’­ä¸€æ ·ã€‚ä½†æ˜¯å½“æ•°æ®éœ€è¦ä»ç¬¬ 3 å±‚ä¼ åˆ°ç¬¬ 4 å±‚æ—¶ï¼Œå®ƒéœ€è¦ä» GPU0 ä¼ è¾“åˆ° GPU1ï¼Œè¿™ä¼šå¼•å…¥é€šä¿¡å¼€é”€ã€‚å¦‚æœå‚ä¸çš„ GPU ä½äºåŒä¸€è®¡ç®—èŠ‚ç‚¹ (ä¾‹å¦‚åŒä¸€å°ç‰©ç†æœºå™¨) ä¸Šï¼Œåˆ™ä¼ è¾“éå¸¸å¿«ï¼Œä½†å¦‚æœ GPU ä½äºä¸åŒçš„è®¡ç®—èŠ‚ç‚¹ (ä¾‹å¦‚å¤šå°æœºå™¨) ä¸Šï¼Œé€šä¿¡å¼€é”€å¯èƒ½ä¼šå¤§å¾—å¤šã€‚

ç„¶åç¬¬ 4 åˆ° 5 åˆ° 6 åˆ° 7 å±‚åˆåƒæ™®é€šæ¨¡å‹ä¸€æ ·ï¼Œå½“ç¬¬ 7 å±‚å®Œæˆæ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å°†æ•°æ®å‘é€å›æ ‡ç­¾æ‰€åœ¨çš„ç¬¬ 0 å±‚ (æˆ–è€…å°†æ ‡ç­¾å‘é€åˆ°æœ€åä¸€å±‚)ã€‚ç°åœ¨å¯ä»¥è®¡ç®—æŸå¤±ï¼Œç„¶åä½¿ç”¨ä¼˜åŒ–å™¨æ¥è¿›è¡Œæ›´æ–°å‚æ•°äº†ã€‚

æˆ‘ä»¬æœ‰ä¸€ä¸ªç›´æ¥çš„ä¼˜åŠ¿ï¼šæ‰€éœ€çš„äº’è¿å¸¦å®½ä¿æŒç›¸å½“ä½ï¼Œå› ä¸ºæˆ‘ä»¬åªåœ¨æ¨¡å‹æ·±åº¦ä¸Šçš„å°‘æ•°ä½ç½®å‘é€ä¸­ç­‰å¤§å°çš„æ¿€æ´»ã€‚ä¸å¼ é‡å¹¶è¡Œä¸­çš„é€šä¿¡ï¼ˆæ¯å±‚éƒ½ä¼šå‘ç”Ÿå‡ æ¬¡ï¼‰ç›¸æ¯”ï¼Œå®ƒå¯ä»¥äº§ç”Ÿå·¨å¤§çš„å·®å¼‚ã€‚

è¯¥æ–¹æ³•ä¸ºä»€ä¹ˆè¢«ç§°ä¸ºÂ **æœ´ç´ **Â æµæ°´çº¿å¹¶è¡Œå‘¢ï¼Œå®ƒåˆæœ‰ä»€ä¹ˆç¼ºé™·å‘¢ï¼Ÿ
- **ï¼ˆ1ï¼‰GPUåˆ©ç”¨åº¦ä¸å¤Ÿã€‚** ä¸»è¦æ˜¯å› ä¸ºè¯¥æ–¹æ¡ˆåœ¨ä»»æ„ç»™å®šæ—¶åˆ»é™¤äº†ä¸€ä¸ª GPU ä¹‹å¤–çš„å…¶ä»–æ‰€æœ‰ GPU éƒ½æ˜¯ç©ºé—²çš„ã€‚å› æ­¤ï¼Œå¦‚æœä½¿ç”¨ 4 ä¸ª GPUï¼Œåˆ™å‡ ä¹ç­‰åŒäºå°†å•ä¸ª GPU çš„å†…å­˜é‡ç¿»ä¸¤ç•ªï¼Œè€Œå…¶ä»–èµ„æº (å¦‚è®¡ç®—) ç›¸å½“äºæ²¡ç”¨ä¸Šã€‚
- **ï¼ˆ2ï¼‰ä¸­é—´ç»“æœå æ®å¤§é‡å†…å­˜**. åœ¨åšbackwardè®¡ç®—æ¢¯åº¦çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç”¨åˆ°æ¯ä¸€å±‚çš„ä¸­é—´ç»“æœzã€‚å‡è®¾æˆ‘ä»¬çš„æ¨¡å‹æœ‰Lå±‚ï¼Œæ¯ä¸€å±‚çš„å®½åº¦ä¸ºdï¼Œåˆ™å¯¹äºæ¯å—GPUï¼Œä¸è€ƒè™‘å…¶å‚æ•°æœ¬èº«çš„å­˜å‚¨ï¼Œé¢å¤–çš„ç©ºé—´å¤æ‚åº¦ä¸ºÂ ğ‘‚(ğ‘âˆ—(ğ¿/ğ¾)âˆ—ğ‘‘)Â ã€‚ä»è¿™ä¸ªå¤æ‚åº¦å¯ä»¥çœ‹å‡ºï¼Œéšç€æ¨¡å‹çš„å¢å¤§ï¼ŒNï¼ŒLï¼Œdä¸‰è€…çš„å¢åŠ å¯èƒ½ä¼šå¹³æ»‘æ‰Kå¢åŠ å¸¦æ¥çš„GPUå†…å­˜æ”¶ç›Šã€‚å› æ­¤ï¼Œè¿™ä¹Ÿæ˜¯éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ã€‚
- **è¿˜éœ€è¦åŠ ä¸Šåœ¨è®¾å¤‡ä¹‹é—´å¤åˆ¶æ•°æ®çš„å¼€é”€ã€‚** æ‰€ä»¥ 4 å¼  ä½¿ç”¨æœ´ç´ æµæ°´çº¿å¹¶è¡Œçš„ 6GB å¡å°†èƒ½å¤Ÿå®¹çº³ä¸ 1 å¼  24GB å¡ç›¸åŒå¤§å°çš„æ¨¡å‹ï¼Œè€Œåè€…è®­ç»ƒå¾—æ›´å¿«ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æ•°æ®ä¼ è¾“å¼€é”€ã€‚ä½†æ˜¯ï¼Œæ¯”å¦‚è¯´ï¼Œå¦‚æœä½ æœ‰ 40GB å¡ï¼Œä½†éœ€è¦è·‘ 45GB æ¨¡å‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ 4x 40GB å¡ (ä¹Ÿå°±åˆšåˆšå¤Ÿç”¨ï¼Œå› ä¸ºè¿˜æœ‰æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€éœ€è¦æ˜¾å­˜)ã€‚
- **å…±äº«åµŒå…¥å¯èƒ½éœ€è¦åœ¨ GPU ä¹‹é—´æ¥å›å¤åˆ¶** 

	æˆ‘ä»¬ä½¿ç”¨çš„æµæ°´çº¿å¹¶è¡Œ (PP) ä¸ä¸Šè¿°æœ´ç´  PP å‡ ä¹ç›¸åŒï¼Œä½†å®ƒè§£å†³äº† GPU é—²ç½®é—®é¢˜ï¼Œæ–¹æ³•æ˜¯å°†ä¼ å…¥çš„ batch åˆ†å—ä¸º micros batch å¹¶äººå·¥åˆ›å»ºæµæ°´çº¿ï¼Œä»è€Œå…è®¸ä¸åŒçš„ GPU åŒæ—¶å‚ä¸è®¡ç®—è¿‡ç¨‹ã€‚

![](img/Pasted%20image%2020250309174045.png)



ä¸‹å›¾æ¥è‡ªäºÂ [GPipe è®ºæ–‡Â 7](https://ai.googleblog.com/2019/03/introducing-gpipe-open-source-library.html)ï¼Œå…¶ä¸ŠåŠéƒ¨åˆ†è¡¨ç¤ºæœ´ç´  PP æ–¹æ¡ˆï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯ PP æ–¹æ³•:

![](img/Pasted%20image%2020231112190251.png)

æ¯ä¸€è¡Œè¡¨ç¤ºä¸€ä¸ªGPUã€‚æ¯ä¸€åˆ—è¡¨ç¤ºtimestepã€‚ä¸ŠåŠéƒ¨åˆ†å›¾çš„å«ä¹‰ï¼šåœ¨GPU0ä¸Šåšå®Œä¸€æ¬¡forwardï¼Œç„¶åå°†GPU0ä¸Šæœ€åä¸€å±‚çš„è¾“å…¥ä¼ ç»™GPU1ï¼Œç»§ç»­åšforwardï¼Œç›´åˆ°å››å—GPUéƒ½åšå®Œforwardåï¼Œæˆ‘å†ä¾æ¬¡åšbackwardã€‚ç­‰æŠŠå››å—GPUä¸Šçš„backwardå…¨éƒ¨åšå®Œåï¼Œæœ€åä¸€ä¸ªæ—¶åˆ»æˆ‘ç»Ÿä¸€æ›´æ–°æ¯ä¸€å±‚çš„æ¢¯åº¦ã€‚

ä»å›¾çš„ä¸‹åŠéƒ¨åˆ†å¾ˆå®¹æ˜“çœ‹å‡º PP çš„æ­»åŒº (æŒ‡ GPU å¤„äºç©ºé—²çŠ¶æ€) æ›´å°‘ï¼Œå³ â€œæ°”æ³¡â€ æ›´å°‘ã€‚

å›¾ä¸Šä¸¤ç§æ–¹æ¡ˆçš„å¹¶è¡Œåº¦å‡ä¸º 4 ï¼Œå³ç”± 4 å¼  GPU ç»„æˆæµæ°´çº¿ã€‚äºæ˜¯å°±æœ‰äº† F0ã€F1ã€F2ã€F3 è¿™ 4 ä¸ªç®¡çº§çš„forwardè·¯å¾„ï¼Œç„¶åæ˜¯ B3ã€B2ã€B1ã€B0 çš„backwardè·¯å¾„ã€‚

æµæ°´çº¿å¹¶è¡Œçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**åœ¨æ¨¡å‹å¹¶è¡Œï¼ˆä¹Ÿå°±æ˜¯æœ´ç´ PPï¼‰çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥å¼•å…¥æ•°æ®å¹¶è¡Œçš„åŠæ³•ï¼Œå³æŠŠåŸå…ˆçš„æ•°æ®å†åˆ’åˆ†æˆè‹¥å¹²ä¸ªbatchï¼Œé€å…¥GPUè¿›è¡Œè®­ç»ƒ**ã€‚æœªåˆ’åˆ†å‰çš„æ•°æ®ï¼Œå«**mini-batch**ã€‚åœ¨mini-batchä¸Šå†åˆ’åˆ†çš„æ•°æ®ï¼Œå«**micro-batch**ã€‚

PP å¼•å…¥äº†ä¸€ä¸ªæ–°çš„è¶…å‚æ•°æ¥è°ƒæ•´ï¼Œç§°ä¸ºÂ `å— (chunks)`ã€‚å®ƒå®šä¹‰äº†é€šè¿‡åŒä¸€ç®¡çº§æŒ‰é¡ºåºå‘é€å¤šå°‘æ•°æ®å—ã€‚ä¾‹å¦‚ï¼Œåœ¨å›¾çš„ä¸‹åŠéƒ¨åˆ†ï¼Œä½ å¯ä»¥çœ‹åˆ°Â `chunks = 4`ã€‚ GPU0 åœ¨ chunk 0ã€1ã€2 å’Œ 3 (F0,0ã€F0,1ã€F0,2ã€F0,3) ä¸Šæ‰§è¡Œç›¸åŒçš„å‰å‘è·¯å¾„ï¼Œç„¶åç­‰å¾…ï¼Œç­‰å…¶ä»– GPU å®Œæˆå·¥ä½œåï¼ŒGPU0 ä¼šå†æ¬¡å¼€å§‹å·¥ä½œï¼Œä¸ºå— 3ã€2ã€1 å’Œ 0 (B0,3ã€B0,2ã€B0,1ã€B0,0) æ‰§è¡Œåå‘è·¯å¾„ã€‚

è¯·æ³¨æ„ï¼Œä»æ¦‚å¿µä¸Šè®²ï¼Œè¿™ä¸æ¢¯åº¦ç´¯ç§¯ (gradient accumulation stepsï¼ŒGAS) çš„æ„æ€ç›¸åŒã€‚ PyTorch å«å®ƒÂ `å—`ï¼Œè€Œ DeepSpeed å«å®ƒÂ `GAS`ã€‚

å› ä¸ºÂ `å—`ï¼ŒPP å¼•å…¥äº† micro-batches (MBS) çš„æ¦‚å¿µã€‚ DP å°†å…¨å±€ batch size æ‹†åˆ†ä¸ºå° batch sizeï¼Œå› æ­¤å¦‚æœ DP åº¦ä¸º 4ï¼Œåˆ™å…¨å±€ batch size 1024 å°†æ‹†åˆ†ä¸º 4 ä¸ªå° batch sizeï¼Œæ¯ä¸ªå° batch size ä¸º 256 (1024/4)ã€‚è€Œå¦‚æœÂ `å—`Â (æˆ– GAS) çš„æ•°é‡ä¸º 32ï¼Œæˆ‘ä»¬æœ€ç»ˆå¾—åˆ°çš„ micro batch size ä¸º 8 (256/32)ã€‚æ¯ä¸ªç®¡çº§ä¸€æ¬¡å¤„ç†ä¸€ä¸ª micro batchã€‚

è®¡ç®— DP + PP è®¾ç½®çš„å…¨å±€æ‰¹é‡å¤§å°çš„å…¬å¼ä¸º:Â `mbs * chunks * dp_degree`Â =(`8 * 32 * 4 = 1024`)ã€‚

Gpipeé€šè¿‡å®éªŒè¯æ˜ï¼Œå½“Â ğ‘€>=4ğ¾Â æ—¶ï¼Œbubbleäº§ç”Ÿçš„ç©ºè½¬æ—¶é—´å æ¯”å¯¹æœ€ç»ˆè®­ç»ƒæ—¶é•¿å½±å“æ˜¯å¾®å°çš„ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ï¼ˆMæ˜¯chunkså¤§å°ï¼ŒKæ˜¯GPUæ•°é‡ï¼‰

![](img/Pasted%20image%2020250309174619.png)

æˆ‘ä»¬å›è¿‡å¤´å†çœ‹ä¸€ä¸‹å›¾ã€‚ä½¿ç”¨Â `chunks=1`Â ä½ æœ€ç»ˆå¾—åˆ°çš„æ˜¯æœ´ç´  PPï¼Œè¿™æ˜¯éå¸¸ä½æ•ˆçš„ã€‚è€Œä½¿ç”¨éå¸¸å¤§çš„Â `å—`Â æ•°ï¼Œä½ æœ€ç»ˆä¼šå¾—åˆ°å¾ˆå°çš„å¾®æ‰¹é‡å¤§å°ï¼Œè¿™å¾ˆå¯èƒ½ä¹Ÿä¸æ˜¯å¾ˆæœ‰æ•ˆã€‚å› æ­¤ï¼Œå¿…é¡»é€šè¿‡å®éªŒæ¥æ‰¾åˆ°èƒ½æœ€æœ‰æ•ˆåœ°åˆ©ç”¨ GPU çš„Â `å—`æ•°ã€‚

è¯¥å›¾æ˜¾ç¤ºå­˜åœ¨æ— æ³•å¹¶è¡ŒåŒ–çš„ â€œæ­»â€ æ—¶é—´æ°”æ³¡ï¼Œå› ä¸ºæœ€åä¸€ä¸ªÂ `forward`Â é˜¶æ®µå¿…é¡»ç­‰å¾…Â `backward`Â å®Œæˆæµæ°´ã€‚é‚£ä¹ˆï¼Œæ‰¾åˆ°æœ€ä½³çš„Â `å—`Â æ•°ï¼Œä»è€Œä½¿æ‰€æœ‰å‚ä¸çš„ GPU è¾¾åˆ°é«˜çš„å¹¶å‘åˆ©ç”¨ç‡ï¼Œè¿™ä¸€é—®é¢˜å…¶å®å°±è½¬åŒ–ä¸ºæœ€å°åŒ–æ°”æ³¡æ•°äº†ã€‚

è¿™ç§è°ƒåº¦æœºåˆ¶è¢«ç§°ä¸ºÂ `å…¨å‰å…¨å(AFAB)`ã€‚å› ä¸ºæˆ‘ä»¬é¦–å…ˆè¿›è¡Œæ‰€æœ‰å‰å‘ä¼ é€’ï¼Œç„¶ååªè¿›è¡Œæ‰€æœ‰åå‘ä¼ é€’ã€‚å…¶ä¼˜ç‚¹æ˜¯å‰å‘å’Œåå‘æ­¥éª¤é€šå¸¸ä»ç„¶æ˜¯è¿ç»­çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¿ç•™äº†æ¨¡å‹è®­ç»ƒä»£ç çš„ä¸€èˆ¬ç»„ç»‡ã€‚è¿™ä½¿å¾—æ­¤ PP å®ç°æˆä¸ºæœ€å®¹æ˜“å®ç°çš„å®ç°ä¹‹ä¸€ã€‚å…¶ä»–ä¸€äº›å¯é€‰æ–¹æ¡ˆæœ‰Â [ä¸€å‰ä¸€åÂ 2](https://www.microsoft.com/en-us/research/publication/pipedream-generalized-pipeline-parallelism-for-dnn-training/)Â å’ŒÂ [äº¤é”™ä¸€å‰ä¸€åÂ 3](https://arxiv.org/abs/2104.04473)ã€‚

è™½ç„¶ Megatron-LM å’Œ DeepSpeed éƒ½æœ‰è‡ªå·±çš„ PP åè®®å®ç°ï¼Œä½† Megatron-DeepSpeed ä½¿ç”¨çš„æ˜¯ DeepSpeed å®ç°ï¼Œå› ä¸ºå®ƒä¸ DeepSpeed çš„å…¶ä»–åŠŸèƒ½é›†æˆåœ¨ä¸€èµ·ã€‚

è¿™é‡Œçš„å¦ä¸€ä¸ªé‡è¦é—®é¢˜æ˜¯è¯åµŒå…¥çŸ©é˜µçš„å¤§å°ã€‚è™½ç„¶é€šå¸¸è¯åµŒå…¥çŸ©é˜µæ¯” transfomer å—æ‰€éœ€çš„å†…å­˜æ›´å°‘ï¼Œä½†åœ¨ BLOOM æœ‰ 250k è¯æ±‡è¡¨çš„æƒ…å†µä¸‹ï¼ŒåµŒå…¥å±‚éœ€è¦ 7.2GB çš„ bf16 æƒé‡ï¼Œè€Œå˜æ¢å™¨å—ä»…ä¸º 4.9GBã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸å¾—ä¸è®© Megatron-Deepspeed å°†åµŒå…¥å±‚è§†ä¸ºä¸€ä¸ªè½¬æ¢å™¨å—ã€‚æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ä¸ª 72 çº§çš„æµæ°´çº¿ï¼Œå…¶ä¸­ 2 ä¸ªæ˜¯ä¸“é—¨ç”¨äºåµŒå…¥çš„ (ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ª)ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥å¹³è¡¡ GPU çš„å†…å­˜æ¶ˆè€—ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œæˆ‘ä»¬å°±ä¼šè®©ç¬¬ä¸€çº§å’Œæœ€åä¸€çº§æ¶ˆè€—å¾ˆå¤§çš„ GPU å†…å­˜ï¼Œè€Œ 95% çš„ GPU å†…å­˜ä½¿ç”¨ä¼šå¾ˆå°‘ï¼Œå› æ­¤è®­ç»ƒå°†å¾ˆä¸é«˜æ•ˆã€‚

å‰æ–‡è¯´è¿‡ï¼Œéšç€æ¨¡å‹çš„å¢åŠ ï¼Œæ¯å—GPUä¸­å­˜å‚¨çš„ä¸­é—´ç»“æœä¹Ÿä¼šè¶Šå¤§ã€‚å¯¹æ­¤ï¼ŒGpipeé‡‡ç”¨äº†ä¸€ç§éå¸¸ç®€å•ç²—æš´ä½†æœ‰æ•ˆçš„åŠæ³•ï¼š**ç”¨æ—¶é—´æ¢ç©ºé—´ï¼Œåœ¨è®ºæ–‡é‡Œï¼Œè¿™ç§æ–¹æ³•è¢«å‘½åä¸ºre-materalizationï¼Œåäººä¹Ÿç§°å…¶ä¸ºactive checkpoint**ã€‚  
å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯**å‡ ä¹ä¸å­˜ä¸­é—´ç»“æœï¼Œç­‰åˆ°backwardçš„æ—¶å€™ï¼Œå†é‡æ–°ç®—ä¸€éforward**ï¼Œå›¾ä¾‹å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240720112136.png)

æ¯å—GPUä¸Šï¼Œæˆ‘ä»¬åªä¿å­˜æ¥è‡ªä¸Šä¸€å—çš„æœ€åä¸€å±‚è¾“å…¥zï¼Œå…¶ä½™çš„ä¸­é—´ç»“æœæˆ‘ä»¬ç®—å®Œå°±åºŸã€‚ç­‰åˆ°backwardçš„æ—¶å€™å†ç”±ä¿å­˜ä¸‹æ¥çš„zé‡æ–°è¿›è¡Œforwardæ¥ç®—å‡ºã€‚

å¦‚æœä½ ä½¿ç”¨Pytorchæä¾›çš„pipelineæ¥å£ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªå‚æ•°å«checkpointï¼Œå°±æ˜¯ç”¨æ¥åšè¿™ä¸€é¡¹çš„ã€‚

æœ€åï¼Œå†æä¸€ç‚¹ï¼Œåœ¨micro-batchçš„åˆ’åˆ†ä¸‹ï¼Œæˆ‘ä»¬åœ¨è®¡ç®—**Batch Normalization**æ—¶ä¼šæœ‰å½±å“ã€‚Gpipeçš„æ–¹æ³•æ˜¯ï¼Œåœ¨è®­ç»ƒæ—¶è®¡ç®—å’Œè¿ç”¨çš„æ˜¯micro-batché‡Œçš„å‡å€¼å’Œæ–¹å·®ï¼Œä½†åŒæ—¶æŒç»­è¿½è¸ªå…¨éƒ¨mini-batchçš„ç§»åŠ¨å¹³å‡å’Œæ–¹å·®ï¼Œä»¥ä¾¿åœ¨æµ‹è¯•é˜¶æ®µè¿›è¡Œä½¿ç”¨ã€‚Layer Normalizationåˆ™ä¸å—å½±å“ã€‚

Gpipeä¸‹æ—¶é—´æ¶ˆè€—åˆ†å¸ƒ

![](img/Pasted%20image%2020240720112533.png)

- å¯¹æ¯å—GPUæ¥è¯´ï¼Œçº¦2/3çš„æ—¶é—´ï¼Œæ˜¯çœŸæ­£èŠ±åœ¨è®¡ç®—ä¸Šçš„ã€‚
- å…¶ä½™1/3çš„æ—¶é—´ï¼Œå¤§éƒ¨åˆ†èŠ±åœ¨re-materalizationç­–ç•¥ä¸‹çš„é‡è®¡ç®—ä¸Šã€‚å› ä¸ºé‡‡ç”¨æµæ°´çº¿çš„æ–¹æ³•ï¼Œbubbleçš„æ—¶é—´ä¹Ÿè¢«å‹ç¼©åˆ°å¾ˆçŸ­ï¼Œå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

AFABçš„å®ç°

```python
def train_step_pipeline_afab(model, data_loader, tensor_shapes, device, dtype):
    logging_loss: torch.float32 = 0.0
    input_tensors, output_tensors = [], []
    requires_grad_sync = pgm.process_group_manager.cp_dp_world_size > 1

    for _ in range(data_loader.grad_acc_steps): # All forward passes
        input_tensor = pipeline_communicate(operation='recv_forward', shapes=tensor_shapes, device=device, dtype=dtype)
        batch = next(data_loader)
        batch["hidden_states"] = input_tensor.to(device) if input_tensor is not None else input_tensor
        output_tensor = model.forward(input_ids=batch["input_ids"].to(device), position_ids=batch["position_ids"].to(device), hidden_states=batch["hidden_states"])
        pipeline_communicate(operation='send_forward', tensor=output_tensor, device=device, dtype=dtype)
        
        # calculate loss on the last stage
        if pgm.process_group_manager.pp_is_last_stage:
            output_tensor = F.cross_entropy(output_tensor.transpose(1, 2), batch["target_ids"].to(device), reduction='mean')
            logging_loss += output_tensor.item() / data_loader.grad_acc_steps

        input_tensors.append(input_tensor)
        output_tensors.append(output_tensor)

    for ith_microbatch in range(data_loader.grad_acc_steps): # All backward passes
        if requires_grad_sync:
            is_last_iteration = (ith_microbatch == data_loader.grad_acc_steps - 1)
            model.require_backward_grad_sync = is_last_iteration
        output_tensor_grad = pipeline_communicate(operation='recv_backward', shapes=tensor_shapes, device=device, dtype=dtype)
        input_tensor, output_tensor = input_tensors.pop(0), output_tensors.pop(0)
        input_tensor_grad = model.backward(input_tensor, output_tensor, output_tensor_grad)
        pipeline_communicate(operation='send_backward', tensor=input_tensor_grad, device=device, dtype=dtype)

    return logging_loss
```

ç„¶è€Œï¼Œä¸æ°”æ³¡ä¸€æ ·ä»¤äººçƒ¦æ¼çš„æ˜¯å­˜å‚¨æ‰€æœ‰æ¿€æ´»æ‰€éœ€çš„å†…å­˜ç©ºé—´ã€‚æˆ‘ä»¬éœ€è¦å°†æ‰€æœ‰æ¿€æ´»ä¿ç•™åœ¨å†…å­˜ä¸­ï¼Œç›´åˆ°æˆ‘ä»¬åˆ°è¾¾åé€€é˜¶æ®µï¼Œè¿™å¯¼è‡´ PP çš„è¿™äº›å®ç°ä¸­å†…å­˜è¿…é€Ÿçˆ†ç‚¸ã€‚æˆ‘ä»¬èƒ½åšå¾—æ›´å¥½å¹¶é¿å…è¿™ç§å†…å­˜çˆ†ç‚¸å—ï¼Ÿ

ç”±äºå†…å­˜çˆ†ç‚¸æ˜¯ç”±æˆ‘ä»¬ä¸ºåå‘ä¼ æ’­å­˜å‚¨çš„æ¿€æ´»è§¦å‘çš„ï¼Œè®©æˆ‘ä»¬å°è¯•çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦å¯ä»¥åœ¨ä»åœ¨æ‰§è¡Œè®¡ç®—çš„å…¶ä»–å‰å‘éƒ¨åˆ†æ—¶å¼€å§‹æ‰§è¡Œåå‘ä¼ æ’­ã€‚è¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°½å¿«æ”¾å¼ƒä¸€äº›åå‘ä¼ æ’­æ‰€éœ€çš„æ¿€æ´»ã€‚

### ä¸€å‰ä¸€åå’Œ LLama 3.1 æ–¹æ¡ˆ

æ­¤è®¡åˆ’ç§°ä¸º**_ä¸€å‰ä¸€å (1F1B)ï¼Œ_**å› ä¸ºä¸­é—´/ç¨³å®šçŠ¶æ€æ¶‰åŠäº¤æ›¿æ‰§è¡Œä¸€æ¬¡å‰å‘å’Œä¸€æ¬¡åå‘ä¼ é€’ã€‚ä¸€èˆ¬çš„æƒ³æ³•æ˜¯å°½å¿«å¼€å§‹æ‰§è¡Œåå‘ä¼ é€’ã€‚è®¡åˆ’å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020250309174836.png)

å¦‚æœæ‚¨ä»”ç»†è®¡ç®—ï¼Œæ‚¨ä¼šå‘ç°æ°”æ³¡ä»ç„¶å…·æœ‰ç›¸åŒçš„å¤§å°ï¼Œå› æ­¤æˆ‘ä»¬çš„è®­ç»ƒæ•ˆç‡æ²¡æœ‰å¾—åˆ°æ˜¾ç€æé«˜ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬åªéœ€è¦å­˜å‚¨Â ppÂ ä¸ªå¾®æ‰¹æ¬¡ï¼ˆå…¶ä¸­ p æ˜¯ç®¡é“å¹¶è¡Œåº¦ï¼‰çš„æ¿€æ´»ï¼Œè€Œä¸æ˜¯ m ä¸ªï¼ˆå…¶ä¸­ m æ˜¯å¾®æ‰¹æ¬¡çš„æ•°é‡ï¼‰ï¼Œè¿™å¯ä»¥å‡å°‘æˆ‘ä»¬åœ¨ AFAB è®¡åˆ’ä¸­é‡åˆ°çš„æ¿€æ´»å†…å­˜çˆ†ç‚¸ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ æ›´å¤šå¾®æ‰¹æ¬¡ï¼Œè¿™å®é™…ä¸Šä¼šå‡å°‘æ°”æ³¡ã€‚

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œæ­¤è®¾ç½®çš„ä¸»è¦å¤æ‚æ€§åœ¨äºï¼Œå‰å‘å’Œåå‘ä¼ é€’ä¸å†æ˜¯æ•´é½çš„é¡ºåºä¼ é€’ï¼Œè€Œæ˜¯è·¨è®¾å¤‡å¹¶è¡Œæ‰§è¡Œä¸”äº¤é”™ä¼ é€’ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¿…é¡»åœ¨æ¯ä¸ªè®¾å¤‡ä¸Šç‹¬ç«‹å®‰æ’ä»å‰å‘ä¼ é€’åˆ°åå‘ä¼ é€’çš„åˆ‡æ¢ï¼Œè€Œä¸æ˜¯åƒå¾€å¸¸ä¸€æ ·åœ¨ç®€å•è€Œé€šç”¨çš„ä¸­å¤®è®­ç»ƒå¾ªç¯ä¸­è¿›è¡Œåˆ‡æ¢ã€‚

è¿™æ˜¯å®ç°æµæ°´çº¿å¹¶è¡Œé€šå¸¸éœ€è¦å¯¹è®­ç»ƒä»£ç å’Œå»ºæ¨¡ä»£ç è¿›è¡Œç›¸å½“å¤šä¿®æ”¹çš„åŸå› ä¹‹ä¸€ã€‚

æ‚¨è¿˜å¯ä»¥åœ¨ picotron ä¸­æ‰¾åˆ° 1F1B çš„å®Œæ•´å®ç°ï¼š

```python
def train_step_pipeline_1f1b(model, data_loader, tensor_shapes, device, dtype):    
    num_warmup_microbatches = min(pgm.process_group_manager.pp_world_size - pgm.process_group_manager.pp_rank - 1, data_loader.grad_acc_steps)
    num_microbatches_remaining = data_loader.grad_acc_steps - num_warmup_microbatches
    logging_loss, input_tensors, output_tensors  = 0.0, [], []
    requires_grad_sync = pgm.process_group_manager.cp_dp_world_size > 1
    
    def _forward_step(input_tensor):
        batch = next(data_loader)
        batch["hidden_states"] = input_tensor.to(device) if input_tensor is not None else input_tensor
        output_tensor = model.forward(input_ids=batch["input_ids"].to(device), position_ids=batch["position_ids"].to(device), hidden_states=batch["hidden_states"])
        
        # calculate loss on the last stage
        if pgm.process_group_manager.pp_is_last_stage:
            output_tensor = F.cross_entropy(output_tensor.transpose(1, 2), batch["target_ids"].to(device), reduction='mean')
            nonlocal logging_loss
            logging_loss += output_tensor.item() / data_loader.grad_acc_steps
        return output_tensor

    for _ in range(num_warmup_microbatches): # Warmup forward passes
        input_tensor = pipeline_communicate(operation='recv_forward', shapes=tensor_shapes, device=device, dtype=dtype)
        output_tensor = _forward_step(input_tensor)
        pipeline_communicate(operation='send_forward', tensor=output_tensor, device=device, dtype=dtype)
        input_tensors.append(input_tensor)
        output_tensors.append(output_tensor)

    if num_microbatches_remaining > 0:
        input_tensor = pipeline_communicate(operation='recv_forward', shapes=tensor_shapes, device=device, dtype=dtype)
    
    if requires_grad_sync:
        model.require_backward_grad_sync = False

    for ith_microbatch in range(num_microbatches_remaining):  # 1F1B steady state
        is_last_iteration = (ith_microbatch == num_microbatches_remaining - 1)
        output_tensor = _forward_step(input_tensor)
        output_tensor_grad = bidirectional_pipeline_communicate(operation='send_fwd_recv_bwd', send_tensor=output_tensor, recv_shapes=tensor_shapes, device=device, dtype=dtype)
        input_tensors.append(input_tensor)
        output_tensors.append(output_tensor)
        input_tensor, output_tensor = input_tensors.pop(0), output_tensors.pop(0)
        
        # Trigger gradient sync on the last microbatch but only when last rank (the one that has num_warmup_microbatches = 0) has finished computing its backward pass.
        if num_warmup_microbatches == 0 and is_last_iteration:
            model.require_backward_grad_sync = True

        input_tensor_grad = model.backward(input_tensor, output_tensor, output_tensor_grad)
        
        if is_last_iteration:
            input_tensor = None
            pipeline_communicate(operation='send_backward', tensor=input_tensor_grad, device=device, dtype=dtype)
        else:
            input_tensor = bidirectional_pipeline_communicate(operation='send_bwd_recv_fwd', send_tensor=input_tensor_grad, recv_shapes=tensor_shapes, device=device, dtype=dtype)

    for ith_warmup_microbatches in range(num_warmup_microbatches): # Cooldown backward passes
        if requires_grad_sync:
            is_last_iteration = (ith_warmup_microbatches == num_warmup_microbatches - 1)
            model.require_backward_grad_sync = (ith_warmup_microbatches == num_warmup_microbatches - 1)
        input_tensor, output_tensor = input_tensors.pop(0), output_tensors.pop(0)
        output_tensor_grad = pipeline_communicate(operation='recv_backward', shapes=tensor_shapes, device=device, dtype=dtype)
        input_tensor_grad = model.backward(input_tensor, output_tensor, output_tensor_grad)
        pipeline_communicate(operation='send_backward', tensor=input_tensor_grad, device=device, dtype=dtype)

    return logging_loss
```

è®©æˆ‘ä»¬é€šè¿‡é›†ç¾¤ä¸Šçš„ä¸€äº›åŸºå‡†æ¥çœ‹çœ‹ 1F1B ç®¡é“å¹¶è¡Œè®¡åˆ’åœ¨å®è·µä¸­å¦‚ä½•æ‰©å±•ï¼š

![](img/Pasted%20image%2020250309174943.png)

åœ¨å·¦ä¾§ï¼Œå½“å¾®æ‰¹æ¬¡æ•°é‡ç­‰äºæˆ–å°äº PP åº¦å‡ä¸€ (Â m=pâˆ’1) æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç®¡é“æ°”æ³¡çš„å±å®³ - æ€§èƒ½å¾ˆä½ï¼Œç”šè‡³ä¼šéšç€ PP çš„æ‰©å±•è€Œä¸‹é™ã€‚å³ä¾§å›¾è¡¨æ˜¾ç¤ºï¼Œä½¿ç”¨æ¯” PP åº¦ (Â m=32â‰«pâˆ’1Â ) å¤šå¾—å¤šçš„å¾®æ‰¹æ¬¡æœ‰åŠ©äºæé«˜ä½ PP åº¦æ€§èƒ½ï¼ŒåŒæ—¶ä»é™åˆ¶åœ¨éå¸¸å¤§çš„ PP åº¦ã€‚å®é™…ä¸Šï¼Œä¸å¯èƒ½ä»»æ„å¢åŠ å¾®æ‰¹æ¬¡æ•°é‡ä»¥ä¿æŒÂ mâ‰«pâˆ’1Â çš„æ¯”ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬æœ€ç»ˆå—åˆ°ç›®æ ‡å…¨å±€æ‰¹æ¬¡å¤§å°çš„é™åˆ¶ã€‚éšç€æˆ‘ä»¬å¢åŠ æ›´å¤š PP åº¦ï¼Œå¾®æ‰¹æ¬¡æ•°é‡è¾¾åˆ°æœ€å¤§å¯èƒ½ï¼Œæˆ‘ä»¬æœ€ç»ˆå¿…é¡»æ ¹æ®Â rbubble=(pâˆ’1)/må¢åŠ æ°”æ³¡å¤§å°ã€‚

æœ‰è¶£çš„æ˜¯ï¼Œåœ¨å¾®æ‰¹æ¬¡æ•°é‡è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œä»ä¸€ä¸ªèŠ‚ç‚¹ (Â p=8p=8Â ) æ‰©å±•åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ (Â p=16p=16Â ) æ—¶ï¼Œæ€§èƒ½ä»…ä¸‹é™ 14% - è¿™æ¯”å¼ é‡å¹¶è¡Œæ€§å¥½å¾—å¤šï¼Œåè€…åœ¨ç±»ä¼¼çš„è·¨èŠ‚ç‚¹åœºæ™¯ä¸­é€šå¸¸ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™çº¦ 43%ã€‚å½“é‡åˆ°å¸¦å®½è¾ƒä½çš„èŠ‚ç‚¹é—´ç½‘ç»œæ—¶ï¼Œè¿™ç§è¡Œä¸ºä½¿å¾—ç®¡é“å¹¶è¡Œæ€§å¯¹äºè·¨å¤šä¸ªèŠ‚ç‚¹çš„åˆ†å¸ƒå¼è®­ç»ƒç‰¹åˆ«æœ‰å¸å¼•åŠ›ã€‚

è™½ç„¶ 1F1B æ˜¾è‘—å‡å°‘äº†æˆ‘ä»¬çš„æ¿€æ´»å†…å­˜å ç”¨ï¼Œä½†æˆ‘ä»¬åœ¨æœ€åä¸€å¼ å›¾ä¸Šçœ‹åˆ°ï¼Œç®¡é“æ°”æ³¡ä»ç„¶æ˜¯ä¸€ä¸ªä¸»è¦çš„æ•ˆç‡ç“¶é¢ˆã€‚ç”±äºæ°”æ³¡å¤§å°ä»ç„¶ä¸ç®¡é“çº§æ•°æˆæ­£æ¯”ï¼Œæˆ‘ä»¬è®©å®è´µçš„ GPU è®¡ç®—å¤„äºé—²ç½®çŠ¶æ€ã€‚æˆ‘ä»¬èƒ½å¦è®¾è®¡ä¸€ä¸ªæ›´æ™ºèƒ½çš„è®¡åˆ’æ¥æœ€å¤§é™åº¦åœ°å‡å°‘æµªè´¹çš„è®¡ç®—æ—¶é—´ï¼Ÿ

### äº¤é”™é˜¶æ®µ

1F1B è®¡åˆ’è®©æˆ‘ä»¬æ”¹å–„äº†å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä½†ç©ºé—²é˜Ÿåˆ—çš„å¤§å°å¹¶æ²¡æœ‰å¤ªå¤§å˜åŒ–ã€‚æˆ‘ä»¬è¿˜èƒ½ä»¥ä»€ä¹ˆæ–¹å¼ç»§ç»­æ¨è¿›è¿™ä¸€å‰æ²¿ï¼Ÿ

äº‹å®è¯æ˜ï¼Œå¦‚æœæˆ‘ä»¬æ„¿æ„å¼•å…¥ä¸€äº›é¢å¤–çš„é€šä¿¡æ“ä½œï¼Œè¿™æ˜¯æœ‰å¯èƒ½çš„ã€‚ç°åœ¨æ˜¯æ—¶å€™è®¨è®º**_äº¤é”™é˜¶æ®µäº†_**ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæ˜¯ç®€å•åœ°æ²¿ç€æ¨¡å‹æ·±åº¦ç»´åº¦å¯¹æ¨¡å‹è¿›è¡Œäº†åˆ‡ç‰‡ï¼Œä¾‹å¦‚ï¼Œå°†å±‚ 1-4 æ‰˜ç®¡åœ¨ç¬¬ä¸€ä¸ª GPU ä¸Šï¼Œå°†å±‚ 5-8 æ‰˜ç®¡åœ¨ç¬¬äºŒä¸ª GPU ä¸Šã€‚ä½†æˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘å…¶ä»–æ–¹æ³•æ¥å¯¹å±‚è¿›è¡Œåˆ‡ç‰‡ï¼Œä¾‹å¦‚ï¼Œå°†å¥‡æ•°å±‚ 1ã€3ã€5ã€7 æ‰˜ç®¡åœ¨ç¬¬ä¸€ä¸ª GPU ä¸Šï¼Œå°†å¶æ•°å±‚ 2ã€4ã€6ã€8 æ‰˜ç®¡åœ¨ç¬¬äºŒä¸ª GPU ä¸Šã€‚

è¿™é€šå¸¸å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§â€œå¾ªç¯ç®¡é“â€ï¼Œå…¶ä¸­å¾®æ‰¹æ¬¡å°†åœ¨æ¨¡å‹ä¸­è¿›è¡Œå‰å‘ä¼ é€’æ—¶ä»ä¸€ä¸ª GPU å¾ªç¯ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ª GPUã€‚è®©æˆ‘ä»¬é€šè¿‡å›¾å½¢æ¥äº†è§£å®ƒçš„å·¥ä½œåŸç†ï¼š

![](img/Pasted%20image%2020250309175208.png)

äº¤å‰æµæ°´çº¿å¹¶è¡Œæ€§ç¤ºä¾‹ï¼Œå…¶ä¸­æ¨¡å‹çš„å„å±‚åˆ†å¸ƒåœ¨ 4 ä¸ª GPU ä¸Šã€‚æ•°å­—ä»ç„¶ä¸å¾®æ‰¹æ¬¡ ID ç›¸å¯¹åº”ï¼Œä½†ä¸ºäº†æ¸…æ™°èµ·è§ï¼Œæˆ‘ä»¬å¯¹æ¨¡å‹çš„ç¬¬ä¸€å±‚å’Œæœ€åä¸€å±‚ä½¿ç”¨äº†ä¸åŒçš„é¢œè‰²ï¼Œä»¥è¯´æ˜å„å±‚å¦‚ä½•åˆ†å¸ƒåœ¨ GPU ä¸Šã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çœ‹åˆ°å‘ç”Ÿäº†é¢å¤–çš„é€šä¿¡ï¼Œå› ä¸ºæ¨¡å‹å¤šæ¬¡é€šè¿‡æ¯ä¸ª GPU è¿›è¡Œç›¸åŒçš„è®¡ç®—ï¼Œè€Œä¹‹å‰åªéœ€ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œæ¯ä¸ªå‰å‘å’Œåå‘ä¼ é€’éƒ½ä¼šé™¤ä»¥å› å­ vï¼Œå…¶ä¸­ v æ˜¯æ¯ä¸ª GPU çš„é˜¶æ®µæˆ–æ¨¡å‹å—çš„æ•°é‡ï¼Œå› ä¸ºæˆ‘ä»¬èƒ½å¤Ÿæ›´å¥½åœ°äº¤é”™å‰å‘å’Œåå‘ä¼ é€’ã€‚

![](img/Pasted%20image%2020250309175247.png)

å› æ­¤ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥é€šè¿‡æ·»åŠ å¾®æ‰¹æ¬¡å’Œäº¤é”™Â vÂ é˜¶æ®µæ¥å‡å°‘æ°”æ³¡ï¼Œä½†è¯·æ³¨æ„ï¼Œä»æ•°é‡ä¸Šè®²ï¼Œé€šä¿¡é‡ä¹Ÿä¼šå¢åŠ  vï¼Œå› æ­¤è¿™æ˜¯ä¸€ç§æƒè¡¡ã€‚åœ¨ä¸‹å›¾ä¸­ï¼Œæ‚¨å¯ä»¥çœ‹åˆ°å…·æœ‰Â p=8Â çš„ PP è®¾ç½®çš„å‡ ç§é…ç½®ï¼Œå…¶ä¸­Â m=1,v=1çš„ç‰¹æ®Šæƒ…å†µå¯¹åº”äºç®€å•çš„ç®¡é“å¹¶è¡Œæ€§ï¼Œå…·æœ‰Â v=1Â çš„é…ç½®æ˜¯ AFAB æˆ– 1F1B è®¾ç½®ï¼Œè€ŒÂ vâ‰ 1æ˜¯äº¤é”™é…ç½®ã€‚

![](img/Pasted%20image%2020250309175316.png)

åœ¨è¿™é‡Œï¼Œè°ƒåº¦ä¹Ÿå˜å¾—æ›´åŠ å¤æ‚ï¼Œå› ä¸ºæˆ‘ä»¬å¿…é¡»åœ¨ç»™å®šçš„ GPU ä¸Šå’Œç»™å®šçš„æ—¶åˆ»å†³å®šæˆ‘ä»¬æ˜¯å¦ä¼˜å…ˆè€ƒè™‘é€šè¿‡åé¢çš„å±‚çš„è¾ƒæ—©çš„å¾®æ‰¹æ¬¡â€”â€”è¿™æ„å‘³ç€æˆ‘ä»¬å°½å¯èƒ½å¿«åœ°å…³é—­å‰å‘å’Œåå‘å¾ªç¯ï¼ˆæ‰€è°“çš„â€œæ·±åº¦ä¼˜å…ˆâ€ï¼Œå³ä¼˜å…ˆè€ƒè™‘å°½å¿«ä»æ¨¡å‹ä¸­è·å–æ‰¹æ¬¡ï¼‰â€”â€”æˆ–è€…æˆ‘ä»¬æ˜¯å¦ä¼˜å…ˆè€ƒè™‘é¦–å…ˆé€šè¿‡è¾ƒæ—©çš„å±‚è¿›è¡Œè¾ƒæ™šçš„å¾®æ‰¹æ¬¡ï¼ˆæ‰€è°“çš„â€œå¹¿åº¦ä¼˜å…ˆâ€ï¼Œå³ä¼˜å…ˆè€ƒè™‘å°½å¯èƒ½å¤šåœ°å¡«å……ç®¡é“ï¼‰ã€‚è¿™ç§é€‰æ‹©åœ¨ç²¾å½©çš„â€œå¹¿åº¦ä¼˜å…ˆç®¡é“â€è®ºæ–‡ä¸­æœ‰è¯¦ç»†è§£é‡Š

ç°åœ¨ï¼Œæ‚¨å·²ç»æŒæ¡äº†ç†è§£ Llama 3.1 ä¸­çš„ç®¡é“å¹¶è¡Œæ–¹æ³•çš„æ‰€æœ‰è¦ç´ ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨ä¸€å‰ä¸€åè®¾ç½®ï¼Œå…·æœ‰äº¤é”™é˜¶æ®µä»¥åŠå¯åœ¨æ·±åº¦ä¼˜å…ˆå’Œå¹¿åº¦ä¼˜å…ˆä¹‹é—´è°ƒæ•´çš„ä¼˜å…ˆçº§è®¾ç½®ã€‚

![](img/Pasted%20image%2020250309175354.png)

ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰åˆ°è¾¾å¯èƒ½çš„æµæ°´çº¿è°ƒåº¦çš„å°½å¤´ï¼Œæœ€è¿‘æœ‰äººæå‡ºäº†ä¸€äº›æ–¹æ³•ï¼Œå°†**æ°”æ³¡å‡å°‘åˆ°å‡ ä¹ä¸ºé›¶**ï¼ä¾‹å¦‚ï¼Œè¿™äº›æŠ€æœ¯åœ¨ DeepSeek V3/R1 å®ç°ä¸­ä½¿ç”¨

### é›¶æ°”æ³¡å’ŒåŒç®¡

æœ€è¿‘ï¼Œæœ‰äººæå‡ºäº†æ›´ä¸ºå¤æ‚çš„å‡å°‘æ°”æ³¡çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²æ¥è¿‘â€œé›¶æ°”æ³¡â€çŠ¶æ€ã€‚è¿™é‡Œçš„ç§˜è¯€æ˜¯å°†æ‰€æ¶‰åŠçš„æ“ä½œæ‹†åˆ†åˆ°æ›´ç»†ç²’åº¦çš„çº§åˆ«ï¼Œä»¥ä¾¿ä»¥æœ€æœ‰æ•ˆçš„æ–¹å¼äº¤é”™å®ƒä»¬ã€‚ä¾‹å¦‚ï¼ŒDeepSeek V3/R1 ä¸­çš„ç®¡é“å®ç°æ–¹æ³•ï¼ˆç§°ä¸º DualPipeï¼‰å·²æ¥è¿‘é›¶æ°”æ³¡çŠ¶æ€ã€‚

è®©æˆ‘ä»¬é€šè¿‡æ€»ç»“ ZeroBubble æ¥ç®€è¦äº†è§£ä¸€ä¸‹è¿™æ˜¯å¦‚ä½•è¿ä½œçš„.è¿™æ˜¯ DualPipe çš„å‰èº«ã€‚ZeroBubble çš„åŸºæœ¬è§‚å¯Ÿæ˜¯ï¼ŒçŸ©é˜µä¹˜æ³•çš„åå‘ä¼ é€’å®é™…ä¸Šæ¶‰åŠä¸¤ä¸ªç‹¬ç«‹çš„æ“ä½œï¼šè¾“å…¥çš„åå‘æ“ä½œ (B) å’Œæƒé‡çš„åå‘æ“ä½œ (W)ï¼š

è™½ç„¶ B çš„è¾“å‡ºï¼ˆè¾“å…¥çš„åå‘ä¼ é€’ï¼‰å¯¹äºæ‰§è¡Œè¾ƒä½å±‚çš„åå‘ä¼ é€’æ˜¯å¿…è¦çš„ï¼Œä½†æƒé‡ W çš„åå‘ä¼ é€’å¯¹äºå…¶ä½™çš„åå‘ä¼ é€’æ¥è¯´å¹¶ä¸æ˜¯å¿…è¦çš„ï¼Œå¹¶ä¸”é€šå¸¸åªéœ€è¦åœ¨ä¼˜åŒ–å™¨æ­¥éª¤ä¹‹å‰æ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä¸‹å›¾ä¸­çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š

![](img/Pasted%20image%2020250309175506.png)

è¿™æ„å‘³ç€ W å¯ä»¥çµæ´»åœ°å®‰æ’åœ¨åŒä¸€é˜¶æ®µçš„ç›¸åº” B ä¹‹åçš„ä»»ä½•ä½ç½®ã€‚è¿™å…è®¸æˆ˜ç•¥æ€§åœ°æ”¾ç½® W ä»¥å¡«å……ç®¡é“æ°”æ³¡ã€‚å³ä¸Šè§’çš„ ZB-H2 è®¡åˆ’æ˜¯é›¶æ°”æ³¡ï¼ˆç†è®ºï¼‰è®¡åˆ’çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œåˆ©ç”¨äº†è¿™ç§ç»†ç²’åº¦åˆ†è§£ã€‚

![](img/Pasted%20image%2020250309175535.png)

é¡¶éƒ¨ï¼ˆå›¾ 2ï¼Œæ¥è‡ª ZeroBubble è®ºæ–‡ï¼‰ï¼šç»å…¸çš„ 1F1B è°ƒåº¦ï¼Œäº¤å‰å‰å‘å’Œåå‘ä¼ é€’ï¼Œä½†ä¿æŒç²—ç²’åº¦åå‘ä¼ é€’ã€‚åº•éƒ¨ä¸¤å¼ å›¾ï¼ˆå›¾ 3ï¼Œæ¥è‡ª ZeroBubble è®ºæ–‡ï¼‰æ˜¯ ZeroBubble è°ƒåº¦çš„ä¸¤ä¸ªå˜ä½“ï¼Œå°†åå‘æ“ä½œåˆ†ä¸ºâ€œBâ€å’Œâ€œWâ€ç»†ç²’åº¦æ“ä½œã€‚æœ€åä¸€ä¸ªè°ƒåº¦ï¼Œå³æ‰€è°“çš„â€œZB-H2â€ï¼Œæ˜¯é›¶æ°”æ³¡åˆ©ç”¨è¿™ç§ç»†ç²’åº¦åˆ†è§£çš„ï¼ˆç†è®ºï¼‰è°ƒåº¦çš„ç¤ºä¾‹ã€‚

DeepSeek çš„ DualPipe åŠå…¶ V3 æŠ€æœ¯æŠ¥å‘Šé—®ä¸–,è¿™ç§åˆ†è§£æ–¹æ³•çš„æ‰©å±•é€‚ç”¨äºä» PP ç»´åº¦çš„ä¸¤ç«¯ä¼ æ’­çš„ä¸¤ä¸ªæµçš„é™„åŠ æƒ…å†µï¼Œè¿™äº›æµè¢«äº¤é”™ä»¥æœ€å¤§é™åº¦åœ°å‡å°‘ GPU ä¸­çš„ç©ºé—²æ—¶é—´ã€‚æ­¤è°ƒåº¦æ˜¾ç¤ºåœ¨ä»¥ä¸‹è°ƒåº¦å›¾ä¸­ï¼Œå¹¶ä¸”æ¯”ä»¥å‰çš„è°ƒåº¦æ›´å¤æ‚ï¼š

![](img/Pasted%20image%2020250309175606.png)

ä¸€èˆ¬æ¥è¯´ï¼Œè¦å®Œå…¨ä¼˜åŒ–è¿™ç§å¤æ‚çš„è°ƒåº¦ï¼Œéœ€è¦ä»”ç»†æµ‹é‡å„ç§ç»†ç²’åº¦æ“ä½œçš„æŒç»­æ—¶é—´ï¼Œå¹¶è§£å†³ ILP é—®é¢˜ä»¥å°½é‡å‡å°‘æœ€ç»ˆçš„æ°”æ³¡æ—¶é—´ã€‚ä¾‹å¦‚ï¼Œè¯·å‚é˜… ZeroBubble è®ºæ–‡. è®¨è®ºæ‰§è¡Œæ­¤ç±»è°ƒåº¦çš„å¯å‘å¼æ–¹æ³•å’Œç®—æ³•ã€‚å› æ­¤ï¼ŒZeroBubble å’Œ DualPipe è°ƒåº¦è¿‡äºå¤æ‚ï¼Œæˆ‘ä»¬æ— æ³•åœ¨æ­¤æä¾›ä»£ç ç‰‡æ®µï¼Œä½†æ‚¨åº”è¯¥å¼€å§‹å¯¹æ‰€æ¶‰åŠçš„æ¦‚å¿µæœ‰ä¸€ä¸ªå¤§è‡´çš„äº†è§£ã€‚

## DP+TP+ZeRO

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯¹Transformerç±»çš„æ¨¡å‹ï¼Œé‡‡ç”¨æœ€ç»å…¸æ–¹æ³•æ˜¯å¼ é‡æ¨¡å‹å¹¶è¡Œ + æ•°æ®å¹¶è¡Œï¼Œå¹¶åœ¨æ•°æ®å¹¶è¡Œä¸­å¼•å…¥ZeROåšæ˜¾å­˜ä¼˜åŒ–ã€‚å…·ä½“çš„æ¶æ„å¦‚ä¸‹ï¼š

![](img/Pasted%20image%2020240727163446.png)

å…¶ä¸­ï¼Œnodeè¡¨ç¤ºä¸€å°æœºå™¨ï¼Œ**ä¸€èˆ¬æˆ‘ä»¬åœ¨åŒä¸€å°æœºå™¨çš„GPUé—´åšå¼ é‡æ¨¡å‹å¹¶è¡Œã€‚åœ¨ä¸åŒçš„æœºå™¨ä¸Šåšæ•°æ®å¹¶è¡Œ**ã€‚å›¾ä¸­é¢œè‰²ç›¸åŒçš„éƒ¨åˆ†ï¼Œä¸ºä¸€ä¸ªæ•°æ®å¹¶è¡Œç»„ã€‚å‡­ç›´è§‰ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“è¿™ä¹ˆè®¾è®¡å¤§æ¦‚ç‡å’Œä¸¤ç§å¹¶è¡Œæ–¹å¼çš„é€šè®¯é‡æœ‰å…³ã€‚å…·ä½“æ¥è¯´ï¼Œ**å®ƒä¸TPå’ŒDPæ¨¡å¼ä¸‹æ¯ä¸€å±‚çš„é€šè®¯é‡æœ‰å…³ï¼Œä¹Ÿä¸TPå’ŒDPçš„backwardè®¡ç®—æ–¹å¼æœ‰å…³**ã€‚


## DP+PP

DeepSpeedÂ [æµæ°´çº¿å¹¶è¡Œæ•™ç¨‹Â 1](https://www.deepspeed.ai/tutorials/pipeline/)Â ä¸­æœ‰ä¸€å¼ å›¾æ¼”ç¤ºäº†å¦‚ä½•å°† DP ä¸ PP ç»“åˆèµ·æ¥ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

![dp-pp-2d](https://devrel.andfun.cn/devrel/posts/2023/03/5cpHbc.jpg)

è¿™é‡Œé‡è¦çš„æ˜¯è¦äº†è§£ DP rank 0 æ˜¯çœ‹ä¸è§ GPU2 çš„ï¼Œ DP rank 1 æ˜¯çœ‹ä¸åˆ° GPU3 çš„ã€‚å¯¹äº DP è€Œè¨€ï¼Œåªæœ‰ GPU 0 å’Œ 1ï¼Œå¹¶å‘å®ƒä»¬é¦ˆé€æ•°æ®ã€‚ GPU0 ä½¿ç”¨ PP â€œç§˜å¯†åœ°â€ å°†å®ƒçš„ä¸€äº›è´Ÿè½½å¸è½½åˆ° GPU2ã€‚åŒæ ·åœ°ï¼Œ GPU1 ä¹Ÿä¼šå¾—åˆ° GPU3 çš„å¸®åŠ©ã€‚

ç”±äºæ¯ä¸ªç»´åº¦è‡³å°‘éœ€è¦ 2 ä¸ª GPUï¼Œå› æ­¤è¿™å„¿è‡³å°‘éœ€è¦ 4 ä¸ª GPUã€‚

## DP+PP+TP

ä¸ºäº†æ›´é«˜æ•ˆåœ°è®­ç»ƒï¼Œå¯ä»¥å°† PPã€TP å’Œ DP ç›¸ç»“åˆï¼Œç§°ä¸º 3D å¹¶è¡Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚

![dp-pp-tp-3d](https://devrel.andfun.cn/devrel/posts/2023/03/bd58NV.jpg)

æ­¤å›¾æ¥è‡ªåšæ–‡Â [3D å¹¶è¡Œ: æ‰©å±•åˆ°ä¸‡äº¿å‚æ•°æ¨¡å‹Â 7](https://www.microsoft.com/en-us/research/blog/deepspeed-extreme-scale-model-training-for-everyone/)), è¿™ä¹Ÿæ˜¯ä¸€ç¯‡å¥½æ–‡ç« ã€‚

ç”±äºæ¯ä¸ªç»´åº¦è‡³å°‘éœ€è¦ 2 ä¸ª GPUï¼Œå› æ­¤åœ¨è¿™é‡Œä½ è‡³å°‘éœ€è¦ 8 ä¸ª GPU æ‰èƒ½å®ç°å®Œæ•´çš„ 3D å¹¶è¡Œã€‚

## ZeRO DP+PP+TP

DeepSpeed çš„ä¸»è¦åŠŸèƒ½ä¹‹ä¸€æ˜¯ ZeROï¼Œå®ƒæ˜¯ DP çš„è¶…çº§å¯ä¼¸ç¼©å¢å¼ºç‰ˆï¼Œæˆ‘ä»¬åœ¨ [ZeRO æ•°æ®å¹¶è¡Œ](#ZeRO-Â æ•°æ®å¹¶è¡Œ) ä¸€èŠ‚ä¸­å·²ç»è®¨è®ºè¿‡äº†ã€‚é€šå¸¸å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åŠŸèƒ½ï¼Œä¸éœ€è¦ PP æˆ– TPã€‚ä½†å®ƒä¹Ÿå¯ä»¥ä¸ PPã€TP ç»“åˆä½¿ç”¨ã€‚

å½“ ZeRO-DP ä¸ PP (ä»¥åŠ TP) ç»“åˆæ—¶ï¼Œå®ƒé€šå¸¸åªå¯ç”¨ ZeRO é˜¶æ®µ 1ï¼Œå®ƒåªå¯¹ä¼˜åŒ–å™¨çŠ¶æ€è¿›è¡Œåˆ†ç‰‡ã€‚ ZeRO é˜¶æ®µ 2 è¿˜ä¼šå¯¹æ¢¯åº¦è¿›è¡Œåˆ†ç‰‡ï¼Œé˜¶æ®µ 3 ä¹Ÿå¯¹æ¨¡å‹æƒé‡è¿›è¡Œåˆ†ç‰‡ã€‚

è™½ç„¶ç†è®ºä¸Šå¯ä»¥å°† ZeRO é˜¶æ®µ 2 ä¸ æµæ°´çº¿å¹¶è¡Œ ä¸€èµ·ä½¿ç”¨ï¼Œä½†å®ƒä¼šå¯¹æ€§èƒ½äº§ç”Ÿä¸è‰¯å½±å“ã€‚æ¯ä¸ª micro batch éƒ½éœ€è¦ä¸€ä¸ªé¢å¤–çš„ reduce-scatter é€šä¿¡æ¥åœ¨åˆ†ç‰‡ä¹‹å‰èšåˆæ¢¯åº¦ï¼Œè¿™ä¼šå¢åŠ æ½œåœ¨çš„æ˜¾è‘—é€šä¿¡å¼€é”€ã€‚æ ¹æ®æµæ°´çº¿å¹¶è¡Œçš„æ€§è´¨ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨å°çš„ micro batch ï¼Œå¹¶æŠŠé‡ç‚¹æ”¾åœ¨ç®—æœ¯å¼ºåº¦ (micro batch size) ä¸æœ€å°åŒ–æµæ°´çº¿æ°”æ³¡ (micro batch çš„æ•°é‡) ä¸¤è€…é—´æŠ˜è¡·ã€‚å› æ­¤ï¼Œå¢åŠ çš„é€šä¿¡å¼€é”€ä¼šæŸå®³æµæ°´çº¿å¹¶è¡Œã€‚

æ­¤å¤–ï¼Œç”±äº PPï¼Œå±‚æ•°å·²ç»æ¯”æ­£å¸¸æƒ…å†µä¸‹å°‘ï¼Œå› æ­¤å¹¶ä¸ä¼šèŠ‚çœå¾ˆå¤šå†…å­˜ã€‚ PP å·²ç»å°†æ¢¯åº¦å¤§å°å‡å°‘äº†Â `1/PP`ï¼Œå› æ­¤åœ¨æ­¤åŸºç¡€ä¹‹ä¸Šçš„æ¢¯åº¦åˆ†ç‰‡å’Œçº¯ DP ç›¸æ¯”èŠ‚çœä¸äº†å¤šå°‘å†…å­˜ã€‚

ZeRO é˜¶æ®µ 3 ä¹Ÿå¯ç”¨äºè®­ç»ƒè¿™ç§è§„æ¨¡çš„æ¨¡å‹ï¼Œä½†æ˜¯ï¼Œå®ƒéœ€è¦çš„é€šä¿¡é‡æ¯” DeepSpeed 3D å¹¶è¡Œæ›´å¤šã€‚ä¸€å¹´å‰ï¼Œåœ¨å¯¹æˆ‘ä»¬çš„ç¯å¢ƒè¿›è¡Œä»”ç»†è¯„ä¼°åï¼Œæˆ‘ä»¬å‘ç° Megatron-DeepSpeed 3D å¹¶è¡Œæ€§è¡¨ç°æœ€ä½³ã€‚æ­¤åï¼ŒZeRO é˜¶æ®µ 3 çš„æ€§èƒ½æœ‰äº†æ˜¾è‘—æé«˜ï¼Œå¦‚æœæˆ‘ä»¬ä»Šå¤©è¦å¯¹å…¶è¿›è¡Œé‡æ–°è¯„ä¼°ï¼Œä¹Ÿè®¸æˆ‘ä»¬ä¼šé€‰æ‹©é˜¶æ®µ 3ã€‚


## å‚è€ƒèµ„æ–™

[åƒäº¿å‚æ•°å¼€æºå¤§æ¨¡å‹ BLOOM èƒŒåçš„æŠ€æœ¯ - Hugging Face - 101.dev ç¤¾åŒº](https://101.dev/t/bloom/921)

[çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®­ç»ƒä¹‹ï¼šæµæ°´çº¿å¹¶è¡Œï¼ˆPipeline Parallelismï¼‰ï¼Œä»¥Gpipeä¸ºä¾‹](https://zhuanlan.zhihu.com/p/613196255)

[çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®­ç»ƒä¹‹ï¼šæ•°æ®å¹¶è¡Œä¸Šç¯‡(DP, DDPä¸ZeRO)](https://zhuanlan.zhihu.com/p/617133971)

[çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹è®­ç»ƒä¹‹ï¼šæ•°æ®å¹¶è¡Œä¸‹ç¯‡(ZeROï¼Œé›¶å†—ä½™ä¼˜åŒ–)](https://zhuanlan.zhihu.com/p/618865052)

[çŒ›çŒ¿ï¼šå›¾è§£å¤§æ¨¡å‹ç³»åˆ—ä¹‹ï¼šå¼ é‡æ¨¡å‹å¹¶è¡Œï¼ŒMegatron-LM](https://zhuanlan.zhihu.com/p/622212228)


