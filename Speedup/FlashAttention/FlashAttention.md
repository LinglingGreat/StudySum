Flash Attention ç”±[Tri Dao](https://tridao.me/)å¼•å…¥ï¼Œå¹¶æè®®é€šè¿‡ç¼–å†™è‡ªå®šä¹‰ CUDA å†…æ ¸æ¥ä¼˜åŒ–æ³¨æ„åŠ›è®¡ç®—ï¼Œä½¿å…¶é€Ÿåº¦æ›´å¿«ä¸”å†…å­˜æ•ˆç‡æ›´é«˜ã€‚Flash Attention èƒŒåçš„æƒ³æ³•æ˜¯é«˜æ•ˆåˆ©ç”¨ GPU çš„å„ç§å†…å­˜ï¼Œé¿å…è¿‡åº¦ä¾èµ–æœ€æ…¢çš„å†…å­˜ï¼šGPU çš„å…¨å±€å†…å­˜ã€‚
## ä¸ºä»€ä¹ˆè¦ä¼˜åŒ–

ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å¯¹Transformerè¿›è¡ŒåŠ é€Ÿï¼Œæ¢å¥è¯è¯´Transformeræ—¶é—´å¤æ‚åº¦å¦‚ä½•ï¼Œæœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ

**è™½ç„¶ç›®å‰Transformerå·²ç»æˆä¸ºæ·±åº¦å­¦ä¹ é¢†åŸŸæœ€å¹¿æ³›çš„æ¶æ„ï¼Œä½†ç”±äºå…¶å›ºæœ‰çš„O(N^2) å¤æ‚åº¦å’Œå†…å­˜é™åˆ¶çš„é”®å€¼ç¼“å­˜ï¼Œåœ¨æ¨ç†è¿‡ç¨‹ä¸­è¡¨ç°å‡ºæ¬¡ä¼˜æ•ˆç‡ã€‚**

**è¿™ç§ä½æ•ˆç‡ä½¿å®ƒä»¬çš„å®é™…éƒ¨ç½²å˜å¾—å¤æ‚ï¼Œç‰¹åˆ«æ˜¯å¯¹äºé•¿åºåˆ—æ¥è¯´ï¼Œè¿™å°±æ˜¯å¤§æ¨¡å‹åœ¨å‘å±•çš„åˆæœŸå…¶è¾“å…¥è¾“å‡ºå¾€å¾€åªæ”¯æŒ2Kæˆ–4K tokenåŸå› ã€‚**

åŸºäºTransformerçš„å¤§æ¨¡å‹ä¸èƒ½å¤„ç†é•¿tokençš„**æœ¬è´¨åŸå› æ˜¯**ï¼Œ**Transformerçš„è®¡ç®—å¤æ‚åº¦å’Œç©ºé—´å¤æ‚åº¦éšåºåˆ—é•¿åº¦Nå‘ˆäºŒæ¬¡æ–¹å¢é•¿**ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœè¦å°†åºåˆ—é•¿åº¦Nç¿»å€æˆä¸º4Nï¼Œæˆ‘ä»¬æ‰€éœ€çš„èµ„æºä¼šå˜ä¸º16å€ï¼Œå³å°†åºåˆ—é•¿åº¦æ‰©å±•Nå€ï¼Œæ‰€éœ€ä»˜å‡ºçš„è®¡ç®—å’Œå†…å­˜èµ„æºè¦æ‰©å¤§äº†çº¦N^2å€ï¼Œå½“ç„¶è¿™é‡Œåªæ˜¯è¿‘ä¼¼æ¯”å–»ã€‚

ä¸‹é¢æˆ‘ä»¬åˆ†æä¸‹Attentionçš„è®¡ç®—å¤æ‚åº¦ï¼š

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªé•¿åº¦ä¸º N çš„è¾“å…¥åºåˆ—ï¼Œæ¯ä¸ªä½ç½®éƒ½ç”¨ä¸€ä¸ªdç»´å‘é‡è¡¨ç¤ºã€‚é‚£ä¹ˆï¼ŒæŸ¥è¯¢çŸ©é˜µ Q çš„ç»´åº¦æ˜¯ NÃ—dï¼Œé”®çŸ©é˜µ K å’Œå€¼çŸ©é˜µ V çš„ç»´åº¦ä¹Ÿæ˜¯ NÃ—dï¼›

å…·ä½“æ¥è¯´ï¼ŒAttention çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š

1. çº¿æ€§å˜æ¢ï¼šå¯¹è¾“å…¥åºåˆ—è¿›è¡Œçº¿æ€§å˜æ¢ï¼Œå¾—åˆ° Qã€Kã€V ä¸‰ä¸ªçŸ©é˜µã€‚å‡è®¾æ¯ä¸ª token çš„ embedding ç»´åº¦ä¸º kï¼Œåˆ™è¯¥æ­¥éª¤çš„å¤æ‚åº¦ä¸º O(n * k * 3d)ã€‚
2. è®¡ç®—ç›¸ä¼¼åº¦å¾—åˆ†ï¼šé€šè¿‡ Qã€K ä¸¤ä¸ªçŸ©é˜µè®¡ç®—ç›¸ä¼¼åº¦å¾—åˆ†ï¼Œå¾—åˆ°æ³¨æ„åŠ›æƒé‡çŸ©é˜µã€‚æ³¨æ„åŠ›æƒé‡çŸ©é˜µçš„å¤§å°ä¸º n * nï¼Œè®¡ç®—è¯¥çŸ©é˜µçš„æ—¶é—´å¤æ‚åº¦ä¸º O(n^2 * d * h)ã€‚
3. åŠ æƒæ±‚å’Œï¼šå°†æ³¨æ„åŠ›æƒé‡çŸ©é˜µä¸ V çŸ©é˜µç›¸ä¹˜å¹¶åŠ æƒæ±‚å’Œï¼Œå¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚è¯¥æ­¥éª¤çš„å¤æ‚åº¦ä¸º O(n * d * h)ã€‚

å› æ­¤ï¼Œ**Attention çš„æ€»è®¡ç®—å¤æ‚åº¦ä¸º O(n^2 * d * h)ï¼Œçº¦ä¸ºO(n^2ï¼‰æ—¶é—´å¤æ‚åº¦ã€‚**

æ³¨æ„åŠ›æœºåˆ¶çš„åŸºæœ¬å®ç°æ¶‰åŠå†…å­˜å’Œå·¥ä½œå™¨ä¹‹é—´çš„å¤§é‡ä¼ è¾“ã€‚å®ƒéœ€è¦åœ¨ HBM ä¸­å®ç° S å’Œ P çŸ©é˜µï¼Œè¿™æ„å‘³ç€ç»“æœéœ€è¦å‘é€åˆ° HBMï¼Œç„¶åè¿”å› SRAM è¿›è¡Œä¸‹ä¸€æ­¥è®¡ç®—ï¼š

![](img/Pasted%20image%2020250309182229.png)

ç”±äº HBM ä¸­çš„å¸¦å®½è¦ä½å¾—å¤šï¼Œè¿™ç»™æ³¨æ„åŠ›è®¡ç®—å¸¦æ¥äº†ä¸¥é‡çš„ç“¶é¢ˆã€‚
## flashAttentionåŠ é€Ÿçš„åŸºç¡€

**flashAtentionå…¶åŠ é€Ÿçš„åŸç†æ˜¯éå¸¸ç®€å•çš„ï¼Œä¹Ÿæ˜¯æœ€åŸºç¡€å’Œå¸¸è§çš„ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„æ‰‹æ®µï¼Œå³é€šè¿‡åˆ©ç”¨æ›´é«˜é€Ÿçš„ä¸Šå±‚å­˜å‚¨è®¡ç®—å•å…ƒï¼Œå‡å°‘å¯¹ä½é€Ÿæ›´ä¸‹å±‚å­˜å‚¨å™¨çš„è®¿é—®æ¬¡æ•°ï¼Œæ¥æå‡æ¨¡å‹çš„è®­ç»ƒæ€§èƒ½ã€‚**

æˆ‘ä»¬éƒ½äº†è§£CPUçš„å¤šçº§åˆ†å±‚å­˜å‚¨æ¶æ„ï¼Œå…¶å®GPUçš„å­˜å‚¨æ¶æ„ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œéµå®ˆåŒæ ·çš„è§„åˆ™ï¼Œå³å†…å­˜è¶Šå¿«ï¼Œè¶Šæ˜‚è´µï¼Œå®¹é‡è¶Šå°ã€‚

FlashAttentionçš„æ ¸å¿ƒåŸç†æ˜¯é€šè¿‡å°†è¾“å…¥**åˆ†å—**å¹¶åœ¨æ¯ä¸ªå—ä¸Šæ‰§è¡Œæ³¨æ„åŠ›æ“ä½œï¼Œä»è€Œå‡å°‘å¯¹é«˜å¸¦å®½å†…å­˜ï¼ˆHBMï¼‰çš„è¯»å†™æ“ä½œã€‚å…·ä½“è€Œè¨€ï¼ŒFlashAttentionä½¿ç”¨å¹³é“ºå’Œé‡è®¡ç®—ç­‰ç»å…¸æŠ€æœ¯ï¼Œå°†è¾“å…¥å—ä»HBMåŠ è½½åˆ°SRAMï¼ˆå¿«é€Ÿç¼“å­˜ï¼‰ï¼Œåœ¨SRAMä¸Šæ‰§è¡Œæ³¨æ„åŠ›æ“ä½œï¼Œå¹¶å°†ç»“æœæ›´æ–°å›HBMã€‚FlashAttentionå‡å°‘äº†å†…å­˜è¯»å†™é‡ï¼Œä»è€Œå®ç°äº†**2-4å€**çš„æ—¶é’Ÿæ—¶é—´åŠ é€Ÿã€‚

![](img/Pasted%20image%2020240424194314.png)

![](img/Pasted%20image%2020250309182310.png)


**è™½ç„¶è¯´flashAttentionå¯¹TransformeråŠ é€Ÿçš„åŸç†éå¸¸ç®€å•ï¼Œç„¶è€Œåœ¨Transformerè¯ç”Ÿçš„åˆæœŸç”±äºç¡¬ä»¶ä¸Šçš„ä¸€äº›é™åˆ¶ï¼Œä½¿å¾—flashAttentionå¹¶æ²¡æœ‰é‚£ä¹ˆå¿«çš„å‡ºç°ï¼Œç›´åˆ°A100 GPUæ¶æ„çš„é—®ä¸–ã€‚**

ä¸‹é¢æˆ‘ä»¬æ¥æ¢³ç†ä¸‹å®‰åŸ¹æ¶æ„æˆ–A100ä¸Šçš„æ ¸å¿ƒç‰¹æ€§ï¼š

1. Ampere æ¶æ„é‡‡ç”¨äº†å°ç§¯ç”µ 7nm åˆ¶ç¨‹ï¼Œå…¶ç¬¬ä¸‰ä»£ Tensor Core å¢å¼ºäº†æ“ä½œæ•°å…±äº«å¹¶æé«˜äº†æ•ˆç‡ã€‚
2. æ›´å¤§æ›´å¿«çš„ L1 ç¼“å­˜å’ŒSRAMèƒ½å¤Ÿè®©å®ƒåœ¨æ¯ä¸ªæµå¤„ç†å™¨(SM)ä¸Šæä¾›ç›¸å½“äº V100 1.5 å€çš„æ€»å®¹é‡ï¼ˆ192 KB vs. 128 KBï¼‰ã€‚
3. A100 GPU æ‹¥æœ‰ 40 GB çš„é«˜é€ŸÂ [HBM2 æ˜¾å­˜](https://zhida.zhihu.com/search?content_id=237618187&content_type=Article&match_order=1&q=+HBM2+%E6%98%BE%E5%AD%98&zhida_source=entity)ï¼Œä¸ Tesla V100 ç›¸æ¯”æå‡äº† 73%ã€‚
4. A100 GPUä¸€ç§æ–°çš„å¼‚æ­¥æ‹·è´æŒ‡ä»¤ï¼Œå¯ä»¥ç›´æ¥ä»HBMæ‹·è´åˆ°SRAMï¼Œè¿™å¤§å¤§ç®€åŒ–äº†æ•°æ®æ‹·è´è¿‡ç¨‹ï¼Œå‡å°‘äº†å»¶è¿Ÿï¼Œå¹¶æé«˜äº†æ•´ä½“æ€§èƒ½ã€‚
5. A100 GPU åœ¨SRAMä¸­æä¾›äº†ç¡¬ä»¶åŠ é€Ÿçš„ barrierï¼Œå°† arrive å’Œ wait æ“ä½œåˆ†å¼€ï¼Œå¯å°†ä»HBMåˆ°SRAMçš„å¼‚æ­¥æ‹·è´ä¸ SM ä¸­çš„è®¡ç®—ç©¿æ’èµ·æ¥ã€‚

## flashAttention ç®—æ³•çš„é€è¡Œè§£é‡Š

ä¼ ç»ŸAttentionï¼Œæ¯æ¬¡å®Œæ•´çš„çŸ©é˜µè¿ç®—çš„å¤æ‚åº¦ä¸ºO(n^2)

æˆ‘ä»¬éƒ½çŸ¥é“flashAttentionæ˜¯ä¼˜åŒ–äº†è®¡ç®—è¿‡ç¨‹ä¸­çš„è®¿å­˜ï¼ˆHBMï¼‰çš„è¿‡ç¨‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹æ ‡å‡†Attentionçš„è®¡ç®—è®¿å­˜ï¼š

![](img/Pasted%20image%2020240424194349.png)

é¦–å…ˆï¼Œä»HBMä¸­è¯»å–å®Œæ•´çš„Qå’ŒKçŸ©é˜µï¼ˆæ¯ä¸ªå¤§å°ä¸ºN x dï¼‰ï¼Œè®¡ç®—ç‚¹ç§¯å¾—åˆ°ç›¸ä¼¼åº¦å¾—åˆ†Sï¼ˆå¤§å°ä¸ºN x Nï¼‰ï¼Œéœ€è¦è¿›è¡ŒO(Nd + N^2)æ¬¡HBMè®¿é—®ã€‚

å…¶æ¬¡ï¼Œè®¡ç®—æ³¨æ„åŠ›æƒé‡Pï¼ˆå¤§å°ä¸ºN x Nï¼‰æ—¶ï¼Œéœ€è¦å¯¹Sè¿›è¡Œsoftmaxæ“ä½œï¼Œè¿™éœ€è¦è¿›è¡ŒO(N^2)æ¬¡HBMè®¿é—®ã€‚

æœ€åï¼Œå°†æ³¨æ„åŠ›æƒé‡På’Œå€¼å‘é‡Vï¼ˆæ¯ä¸ªå¤§å°ä¸ºN x dï¼‰åŠ æƒæ±‚å’Œå¾—åˆ°è¾“å‡ºå‘é‡Oï¼ˆå¤§å°ä¸ºN x dï¼‰æ—¶ï¼Œéœ€è¦è¿›è¡ŒO(Nd)æ¬¡HBMè®¿é—®ã€‚

**å› æ­¤ï¼Œæ ‡å‡† Attention ç®—æ³•çš„æ€»HBMè®¿é—®æ¬¡æ•°ä¸ºO(Nd + N^2)ã€‚å½“Næ¯”è¾ƒå¤§æ—¶ï¼Œæ€»çš„HBMè®¿é—®æ¬¡æ•°å¯èƒ½ä¼šæ¯”è¾ƒæ˜‚è´µã€‚**

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œæ ‡å‡†Attentionç®—æ³•åœ¨GPUå†…å­˜åˆ†çº§å­˜å‚¨çš„æ¶æ„ä¸‹ï¼Œ**å­˜åœ¨ä»¥ä¸‹ç¼ºé™·**ï¼š

- **è¿‡å¤šå¯¹HBMçš„è®¿é—®ï¼Œå¦‚Sã€Péœ€è¦åœ¨å­˜å…¥HMBååˆç«‹å³è¢«è®¿é—®ï¼ŒHBMå¸¦å®½è¾ƒä½ï¼Œä»è€Œå¯¼è‡´ç®—æ³•æ€§èƒ½å—é™**
- **Sã€Péœ€è¦å ç”¨O(N^2)çš„å­˜å‚¨ç©ºé—´ï¼Œæ˜¾å­˜å ç”¨è¾ƒé«˜**

**åŸºäºä¹‹å‰çš„æ€è·¯ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„å®ç°æ–¹å¼ï¼š**

1. ä¹‹æ‰€ä»¥å­˜åœ¨å¤§é‡çš„è®¿å­˜HBMï¼Œä¸€ä¸ªåŸå› æ˜¯åœ¨Attentionçš„è®¡ç®—ä¸­å­˜åœ¨ä¸‰ä¸ªkernelï¼Œæ¯ä¸ªkernelçš„è®¡ç®—è¿‡ç¨‹éƒ½å­˜åœ¨ä»HBMè¯»å–æ•°æ®ï¼Œè®¡ç®—å®Œæˆåè¿˜è¦å†™å›HBMã€‚å¦‚æœæˆ‘ä»¬å°†ä¸‰ä¸ªKernelèåˆä¸ºä¸€ä¸ªï¼Œåˆ™å°±å¯ä»¥å‡å°‘éƒ¨åˆ†çš„è®¿é—®HBMçš„æ¬¡æ•°ã€‚
2. åœ¨è®¡ç®—è¿‡ç¨‹ä¸­è¦å°½é‡çš„åˆ©ç”¨SRAMè¿›è¡Œè®¡ç®—ï¼Œé¿å…è®¿é—®HBMæ“ä½œã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬éƒ½çŸ¥é“è™½ç„¶SRAMçš„å¸¦å®½è¾ƒå¤§ï¼Œä½†å…¶è®¡ç®—å¯å­˜å‚¨çš„æ•°æ®é‡è¾ƒå°ã€‚å¦‚æœæˆ‘ä»¬é‡‡å–â€œåˆ†æ²»â€çš„ç­–ç•¥å°†æ•°æ®è¿›è¡ŒTillingå¤„ç†ï¼Œæ”¾è¿›SRAMä¸­è¿›è¡Œè®¡ç®—ï¼Œç”±äºSRAMè¾ƒå°ï¼Œå½“sequence lengthè¾ƒå¤§æ—¶ï¼Œsequenceä¼šè¢«æˆªæ–­ï¼Œä»è€Œå¯¼è‡´æ ‡å‡†çš„SoftMaxæ— æ³•æ­£å¸¸å·¥ä½œã€‚

**é‚£ä¹ˆflashAttentionæ˜¯å¦‚ä½•è¿›è¡Œå®ç°çš„å‘¢ï¼Ÿ**

**Flash attentionåŸºæœ¬ä¸Šå¯ä»¥å½’ç»“ä¸ºä¸¤ä¸ªä¸»è¦ç‚¹:**

1. **Tiling (åœ¨å‘å‰å’Œå‘åä¼ é€’æ—¶ä½¿ç”¨)-åŸºæœ¬ä¸Šå°†NxN softmax/scoresçŸ©é˜µåˆ†å—æˆå—ã€‚**
2. **Recomputation (é‡ç®—ï¼Œä»…åœ¨å‘åä¼ é€’ä¸­ä½¿ç”¨)**

**Tilingï¼ˆå¹³é“ºï¼‰ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†åŸå§‹çš„æ³¨æ„åŠ›çŸ©é˜µåˆ†è§£æˆæ›´å°çš„å­çŸ©é˜µï¼Œç„¶ååˆ†åˆ«å¯¹è¿™äº›å­çŸ©é˜µè¿›è¡Œè®¡ç®—ï¼Œåªè¦è¿™ä¸ªå­çŸ©é˜µçš„å¤§å°å¯ä»¥åœ¨SRAMå†…å­˜æ”¾ï¼Œé‚£ä¹ˆä¸å°±å¯ä»¥åœ¨è®¡ç®—è¿‡ç¨‹ä¸­åªè®¿é—®SRAMäº†ã€‚**

ç„¶è€Œåœ¨Attentionä¸­softmaxéœ€è¦å°†æ‰€æœ‰çš„åˆ—è€¦åˆåœ¨ä¸€èµ·è®¡ç®—ï¼Œå¦‚ä½•è§£å†³å‘¢ï¼Ÿ

**flashAttentionæå‡ºäº†åˆ†å—SoftMaxç®—æ³•ï¼Œç¡®ä¿äº†æ•´ä¸ªFlash Attentionçš„æ­£ç¡®æ€§ï¼Œè¿™ä¹Ÿæ˜¯æ•´ä¸ªflash attentionçš„æ ¸å¿ƒï¼Œä¸‹é¢æˆ‘ä»¬ä¼šç€é‡ä»‹ç»ã€‚**

**Recomputation (é‡ç®—ï¼‰åœ¨æ·±åº¦å­¦ä¹ ä¼˜åŒ–ä¸­çš„è€æ¦‚å¿µäº†ï¼Œå®ƒæ˜¯ä¸€ç§ç®—åŠ›æ¢å†…å­˜çš„æŠŠæˆ**ï¼Œå°±æ˜¯ä¸è¦å­˜å‚¨é‚£ä¹ˆå¤šæ¢¯åº¦å’Œæ¯ä¸€å±‚çš„æ­£å‘ä¼ æ’­çš„ä¸­é—´çŠ¶æ€ï¼Œè€Œæ˜¯åœ¨è®¡ç®—åˆ°åå‘æŸä¸€å±‚çš„æ—¶å€™å†ä¸´æ—¶ä»å¤´å¼€å§‹é‡ç®—æ­£å‘ä¼ æ’­çš„ä¸­é—´çŠ¶æ€ã€‚

ä¸‹é¢ä¸ºå…¶ä¸»è¦çš„ç®—æ³•å®ç°ï¼š

![](https://picx.zhimg.com/v2-ed43e58b685cef2860dd46b9eb602315_1440w.jpg)

### **æ­¥éª¤ä¸€ï¼šè®¡ç®—åˆ†å­å—çš„å¤§å°**

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è·å–GPUç¡¬ä»¶SRAMçš„å¤§å°ï¼Œæˆ‘ä»¬å‡è®¾ä¸ºMã€‚ä¸ºäº†è®©Qã€Kã€Våœ¨è®¡ç®—ä¸­å¯ä»¥å­˜æ”¾åœ¨SRAMä¸­ï¼Œæˆ‘ä»¬éœ€è¦è®¾å®šåˆ†å—çš„å¤§å°å°ºå¯¸ã€‚

å…¶æ¬¡ï¼Œåœ¨SRAMä¸Šéœ€è¦å­˜åœ¨çš„æ•°æ®åŒ…æ‹¬ï¼ŒQå­å—ï¼ŒKå­å—ï¼ŒVå­å—ï¼Œå…¶æ¬¡è¿˜åº”åŒ…æ‹¬è®¡ç®—è¿‡ç¨‹ä¸­çš„ä¸­é—´è¾“å‡ºOï¼ŒOçš„å¤§å°åº”è¯¥ä¸Qã€Kã€Vå­å—å¤§å°ä¸€è‡´ã€‚

![](https://pica.zhimg.com/v2-1d5587d7b25162195e01ffe76e371e12_1440w.jpg)

æ‰€ä»¥ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è®¡ç®—å‡ºå­å—çš„åˆ—å¤§å°Bc =[M/4d]ï¼Œ dä¸ºçŸ©é˜µç»´åº¦ã€‚

**å½“ç„¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢çš„è®¾ç½®å­å—çš„å¤§å°å¹¶éå”¯ä¸€çš„ï¼Œåªæœ‰ä¿è¯å­å—å¤§å°ä¸è¶…è¿‡SRAMçš„å¤§å°å³å¯ã€‚**

### **æ­¥éª¤äºŒï¼šåˆå§‹åŒ–è¾“å‡ºçŸ©é˜µO**

![](https://pic2.zhimg.com/v2-eb5daecd41957448d9ffa247e8c78253_1440w.jpg)

ä¸ºSRAMä¸Šçš„è¾“å‡ºOçŸ©é˜µèµ‹å€¼ä¸ºå…¨0ï¼Œå®ƒå°†ä½œä¸ºä¸€ä¸ªç´¯åŠ å™¨ä¿å­˜softmaxçš„ç´¯ç§¯åˆ†æ¯ï¼Œlä¹Ÿç±»ä¼¼ã€‚mç”¨äºè®°å½•æ¯ä¸€è¡Œè¡Œæœ€å¤§åˆ†æ•°ï¼Œå…¶åˆå§‹åŒ–ä¸º-infã€‚

**è¿™ä¸€æ­¥å±äºç»†èŠ‚é—®é¢˜ï¼Œå½“ç„¶è¿™å—ä¹Ÿæ˜¯åç»­å­˜åœ¨å¯ä¼˜åŒ–çš„æ“ä½œï¼ˆè§v2ï¼‰**ã€‚

### **æ­¥éª¤ä¸‰ï¼šåˆ‡åˆ†å­å—**

æŒ‰æ­¥éª¤ä¸€ä¸­çš„å—å¤§å°å°†Q, Kå’ŒVåˆ†æˆå—ã€‚

åŒæ—¶å°†å°†O, l, måˆ†å‰²æˆå—(ä¸Qçš„å—å¤§å°ç›¸åŒ)ã€‚

![](https://pic1.zhimg.com/v2-01978aa589029d666f2f765b4f30f546_1440w.jpg)

å°†Qåˆ’åˆ†æˆTrä¸ªBolckï¼ŒKã€Våˆ’åˆ†æˆTcä¸ªBlockï¼Œåˆå§‹åŒ– attention output Oï¼Œå¹¶åˆ’åˆ†æˆTrä¸ªBlockã€‚

### **æ­¥éª¤å››ï¼šå¤–å¾ªç¯åŠ è½½Kã€Vå†…å¾ªç¯åŠ è½½Qå­å—**

![](https://pic1.zhimg.com/v2-7dee7cd57881fdd237db6da70c0d701c_1440w.jpg)

ä¸Šå›¾å®Œç¾è§£é‡Šäº†è¿™ä¸ªå¾ªç¯è¿‡ç¨‹ï¼Œ

1. **å¤–å¾ªç¯ï¼šå¯¹äºæ¯ä¸€ä¸ªBlock Keyå’ŒValueï¼Œä»HBMåŠ è½½è¿›SRAM**
2. **å†…å¾ªç¯ï¼šå¯¹äºæ¯ä¸ªBlock Queryï¼ŒOi, li, miï¼Œä»HBMåŠ è½½è¿›SRAM**
3. **åœ¨SRAMä¸Šå®ŒæˆBlock Sçš„è®¡ç®—**

![](https://picx.zhimg.com/v2-7e0d8dd6c76db2ff830e01a2d33dcd15_1440w.jpg)

**è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼ŒOi, li, miå…¶ä¸­å­˜å‚¨çš„å¯èƒ½æ˜¯ä¸Šä¸€ä¸ªå¾ªç¯è®¡ç®—çš„ä¸­é—´ç»“æœã€‚**

### **æ­¥éª¤äº”ï¼šå®ç°åˆ†å—SoftMaxç®—æ³•**

è¿™é‡Œå°±è¦å¤šæ‰¯ä¸€ç‚¹äº†ï¼Œä»å…¬å¼ä¸Šçœ‹ï¼Œè¿™é‡Œå’ŒåŸæ¥Attention SoftMaxæœ‰äº›åŒºåˆ«ï¼Œä¸è¿‡æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ã€‚

**ä¸‹é¢æˆ‘ä»¬é¦–å…ˆè¯´æ˜æ ‡å‡†SoftMaxæ˜¯å¦‚ä½•è®¡ç®—çš„ï¼Ÿ**

å¯¹äºå‘é‡[x1, x2, â€¦, xd], åŸç”Ÿsoftmaxçš„è®¡ç®—è¿‡ç¨‹å¦‚ä¸‹ï¼š

![](https://pic1.zhimg.com/v2-ad96ebc3018093a90b83c52f1cf72c9c_1440w.jpg)

åœ¨å®é™…ç¡¬ä»¶ä¸­ï¼Œå› ä¸ºæµ®ç‚¹æ•°è¡¨ç¤ºçš„èŒƒå›´æ˜¯æœ‰é™çš„ï¼Œå¯¹äºfloat32å’Œbfloat16æ¥è¯´ï¼Œå½“xâ‰¥89æ—¶ï¼Œexp(x)å°±ä¼šå˜æˆinfï¼Œå‘ç”Ÿæ•°æ®ä¸Šæº¢çš„é—®é¢˜ã€‚

ä¸ºäº†ç¡®ä¿æ•°å€¼è®¡ç®—çš„ç¨³å®šæ€§ï¼Œé¿å…æº¢å‡ºé—®é¢˜ï¼Œé€šå¸¸é‡‡ç”¨ä¸€ç§ç§°ä¸ºâ€œsafe softmaxâ€çš„è®¡ç®—ç­–ç•¥ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œé€šè¿‡å‡å»æœ€å¤§å€¼æ¥ç¼©æ”¾è¾“å…¥æ•°æ®ï¼Œä»¥ä¿è¯æ•°å€¼çš„ç›¸å¯¹ç¨³å®šæ€§ã€‚

æ‰€ä»¥è¯´ï¼Œç°æœ‰æ‰€æœ‰çš„æ·±åº¦å­¦ä¹ æ¡†æ¶ä¸­éƒ½é‡‡ç”¨äº†â€œsafe softmaxâ€è¿™ç§è®¡ç®—æ–¹å¼ï¼Œå…¶è®¡ç®—å…¬å¼ä¸ºå¦‚ä¸‹ã€‚

![](https://pica.zhimg.com/v2-926c0f72e37bd3120a82645189ee50ea_1440w.jpg)

**è®¡ç®—ä¸¾ä¾‹ï¼š**

![](https://pic4.zhimg.com/v2-6457e175cfa3f17abbc31b9350fd5eaf_1440w.jpg)

ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œé¦–å…ˆåœ¨åˆ†å­ä¸Šâ€œsafe softmaxâ€éœ€è¦è·å–å½“å‰åŒºé—´çš„æœ€å¤§å€¼æ¥ç¼©æ”¾è¾“å…¥æ•°æ®ï¼Œè€Œåœ¨åˆ†æ¯ä¸Šéœ€è¦ç´¯åŠ æ‰€æœ‰çš„åˆ†å­f(a)ã€‚

ç”±äºflashAttentionå·²ç»é‡‡å–äº†åˆ†å—è®¡ç®—çš„ç­–ç•¥ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨è®¡ç®—softmaxæ—¶ï¼Œå¹¶ä¸èƒ½æ‹¿åˆ°æ‰€æœ‰æ•°æ®åˆ—çš„æœ€å¤§å€¼å’Œå…¨éƒ¨f(a)çš„å’Œã€‚

**é‚£ä¹ˆflashAttentionæ˜¯å¦‚ä½•å®ç°åˆ†å—softmaxçš„å‘¢ï¼Ÿ**

è™½ç„¶softmaxä¸Kçš„åˆ—æ˜¯è€¦åˆçš„ï¼Œä½†å¦‚æœåˆ†å¼€è®¡ç®—æ¯ä¸ªå­å—çš„softmaxå†å°†æœ€åçš„ç»“æœè¿›è¡Œæ”¶é›†è½¬æ¢æ˜¯å¦å¯ä»¥ç­‰ä»·å‘¢ï¼Ÿä¸‹é¢æˆ‘ä»¬çœ‹çœ‹åŸç‰ˆçš„è¯æ˜å…¬å¼ï¼š

4. å‡å¦‚æœ‰åˆ‡ç‰‡å‘é‡x = [x^(1), x^(2)]ï¼Œåˆ‡ç‰‡åsoftmax çš„è®¡ç®—æ–¹å¼ï¼š

![](https://pic1.zhimg.com/v2-c43e3e53b9e10af3d9e50d6f8b5f14ee_1440w.jpg)

5. update m(x)ï¼Œæ ¹æ®æ›´æ–°åçš„m(x)ï¼Œæ ¹æ®ä¸Šä¸€æ­¥è®¡ç®—ç»“æœé‡æ–°è®¡ç®— f(x), l(x)ã€‚

å‡è®¾å­˜åœ¨x^(3), é‚£ä¹ˆä¾¿å¯ä»¥å°†x^(1)å’Œx^(2)åˆå¹¶æˆä¸€ä¸ªåºåˆ—ï¼Œé‡å¤æ­¥éª¤1å³å¯ã€‚

**è®¡ç®—ä¸¾ä¾‹ï¼š**

![](https://pic3.zhimg.com/v2-71d83d638f7895abbc41f6191b6525c2_1440w.jpg)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯ä»¥åˆ©ç”¨GPUå¤šçº¿ç¨‹åŒæ—¶å¹¶è¡Œè®¡ç®—å¤šä¸ªblockçš„softmaxã€‚

å¯è§é€šè¿‡ä¸Šè¿°çš„è½¬æ¢å¯çŸ¥ï¼Œsoftmaxä¸åˆ†å—softmaxæ˜¯åœ¨æ•°å­¦ä¸Šæ˜¯ç­‰ä»·çš„å…³ç³»ã€‚ä¸è¿‡ç”±äºçœŸå®è®¡ç®—ä¸­æ¬¡æ•°å˜å¤šï¼Œç²¾åº¦ä¸Šä¹Ÿå¯èƒ½å­˜åœ¨ä¸€å®šä¸¢å¤±ã€‚

![](https://pic1.zhimg.com/v2-1dbe609b903a85d249467112554896ee_1440w.jpg)

**æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ä¸Šè¿°ä»£ç åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ**

é¦–å…ˆï¼Œæ ¹æ®ä¸Šä¸€æ­¥è®¡ç®—çš„å­å—Sijï¼Œæ¥è®¡ç®—å½“å‰å—çš„è¡Œæœ€å¤§å€¼mijï¼Œå½“å‰å—Pij(å³softmaxçš„åˆ†å­)ï¼Œlijä¸ºPijçš„ç´¯ç§¯å€¼ã€‚

å…¶æ¬¡ï¼Œè®¡ç®—å­å—ä¸å­å—é—´çš„æœ€å¤§å€¼m^new å’Œå¤šä¸ªå­å—çš„Pijçš„ç´¯ç§¯å€¼l^newã€‚

æœ€åï¼Œæ ¹æ®softmaxå…¬å¼è®¡ç®—æœ€ç»ˆçš„softmaxï¼Œç»ç»“æœå†™åˆ°SRAMçš„Oiä¸­ï¼Œå¹¶å†™å‡ºåˆ°HBM, åŒæ—¶å°†æœ€åçš„æœ€åçš„l^newèµ‹å€¼ç»™liå†™å‡ºåˆ°HBM, m^newèµ‹å€¼åˆ°miå†™å‡ºåˆ°HBMã€‚

å¼€å§‹ä¸‹ä¸€è½®å¾ªç¯ã€‚

åˆ°æ­¤å‰å‘è®¡ç®—å°±ç®—å®Œæˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾æ¥æ€»ç»“ä¸‹flashAttentionçš„å‰å‘è®¡ç®—è¿‡ç¨‹ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šè§£é‡Šäº†ã€‚

![](https://pic1.zhimg.com/v2-f9a22376c90d25a0fe0607217ac40998_1440w.jpg)

### **æ­¥éª¤å…­ï¼šåå‘è®¡ç®—**

**ä»ä¸Šé¢çš„å‰å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å‰å‘è¿‡ç¨‹ä¸­åªå°†Oi, li, miå†™å‡ºåˆ°äº†HBMï¼Œå¹¶æ²¡æœ‰ä¿å­˜Så’ŒPã€‚**

é‚£ä¹ˆåå‘çš„é‡ç®—æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ

6. å‰å‘è¿‡ç¨‹ä¼šä¿ç•™Qï¼ŒKï¼ŒVï¼ŒOï¼Œ lï¼Œ måœ¨HBMä¸­ï¼ŒdOç”±åå‘è®¡ç®—å¾—å€’åï¼ŒæŒ‰ç…§å‰å‘ç›¸åŒçš„åˆ†å—æ¨¡å¼é‡æ–°åˆ†å—ã€‚
7. åˆå§‹åŒ–dQï¼ŒdKï¼ŒdVä¸ºå…¨0çŸ©é˜µï¼Œå¹¶æŒ‰ç…§å¯¹ç­‰Qï¼ŒKï¼ŒVçš„åˆ†å‰²æ–¹å¼åˆ†å‰²dQï¼ŒdKï¼ŒdVã€‚
8. åˆ†åˆ«ä»HBMä¸­Load K V block on SRAMï¼Œå†Load Q block on SRAMã€‚æ ¹æ®å‰å‘è¿‡ç¨‹é‡æ–°è®¡ç®—å¯¹åº”blockçš„Så’ŒPï¼›æŒ‰åˆ†å—çŸ©é˜µçš„æ–¹å¼åˆ†åˆ«è®¡ç®—å¯¹åº”æ¢¯åº¦ã€‚
9. å®Œæˆå‚æ•°æ›´æ–°ã€‚

æœ€ç»ˆå¯ä»¥çœ‹åˆ°ï¼Œåœ¨å°†ä¸‰ä¸ªkernelè¿›è¡Œåˆå¹¶åï¼ŒflashAttention v1å®ç°äº†ä¸­é—´è®¡ç®—å®Œå…¨åŸºäºSRAMçš„ç›®çš„ã€‚

å½“ç„¶è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä»”ç»†åˆ†æä¾ç„¶æ˜¯å­˜åœ¨ä¸€äº›å¯ä¼˜åŒ–çš„ç‚¹çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯flashAttention v2å’Œv3çš„å·¥ä½œäº†ã€‚

## **flashAttentionæ€§èƒ½åˆ†æ**

flashAttentionæ˜¯è½¯ç¡¬ä¸€ä½“ä¼˜åŒ–çš„ä¼˜ç§€æ¡ˆä¾‹ï¼Œå°±åƒå®ƒä¸¥é‡ä¾èµ–äºGPUæ¶æ„A100ä»¥ä¸Šçš„ç¡¬ä»¶ä¸€æ ·ã€‚

å½“ç„¶å¦‚æœä½ çš„ç¡¬ä»¶å’ŒNvidiaæ¶æ„ç±»ä¼¼å¯ä»¥é€šè¿‡ç®—å­é‡å†™é€‚é…åˆ°å…¶ä»–ç¡¬ä»¶ä¸Šï¼Œä½†ä¸å¾—ä¸è¯´çš„æ˜¯flashAttentionç®—æ³•æ˜¯ä¸“ä¸ºNvidiaç¡¬ä»¶ç‰¹ç‚¹è€Œè®¾è®¡çš„ã€‚

ç°åœ¨flashAttentionå¾ˆå¤šå®ç°åˆ©ç”¨ç‡TensorCoreå’Œä½ç²¾åº¦è¿›è¡Œç»‘å®šï¼Œå†åŠ ä¸ŠåŸæ¥å®ç°è®¡ç®—è½¬æ¢è¿‡ç¨‹ä¸­çš„ä¸¢å¤±ï¼Œåœ¨ç²¾åº¦ä¸Šå¯èƒ½å­˜åœ¨ä¸€å®šçš„æŸå¤±ã€‚

é‚£ä¹ˆFlashAttentionåˆ°åº•èŠ‚çœäº†å¤šå°‘æ¬¡è®¿å­˜æ¬¡æ•°å‘¢ï¼Ÿ

æˆ‘ä»¬æ¥è®¡ç®—ä¸‹ï¼š

**é¦–å…ˆï¼ŒKï¼ŒV ï¼ˆNxdï¼‰çš„æ¯ä¸ªblockéƒ½éœ€è¦Load è¿›SRAMï¼Œå› æ­¤è¯¥è¿‡ç¨‹çš„HBMè®¿é—®æ¬¡æ•°ä¸ºO(Nxd)ã€‚  
å…¶æ¬¡ï¼ŒQä¹Ÿéœ€è¦åˆ†block Loadè¿›SRAMï¼Œè¯¥è¿‡ç¨‹ä¸€å…±æŒç»­å¤–å¾ªç¯Tcæ¬¡ï¼Œå› æ­¤è¯¥è¿‡ç¨‹çš„HBMè®¿é—®æ¬¡æ•°ä¸ºO(TcNd)  
æœ€åï¼Œè€ŒTc=N/(Bc)=4Nd/M(å‘ä¸Šå–æ•´)ã€‚å› æ­¤flash attentionçš„HBMè®¿é—®æ¬¡æ•°ä¸ºO(N^2d^2/M)**

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€æ®µè€ç‰ˆæœ¬çš„flashAttentionçš„å®ç°æºç ï¼š

![](https://pica.zhimg.com/v2-95232353531db08b96101b063895338c_1440w.jpg)

## FlashAttentionV2

ç°åœ¨å¹¿æ³›åº”ç”¨çš„ä¸»è¦æ˜¯FlashAttention-2**:**Â Faster Attention with Better Parallelism and Work Partitioningï¼ŒFlashAttention-2å¯¹æ¯”FlashAttention-1ï¼Œä¸»è¦æ˜¯åšäº†ä¸€äº›å·¥ç¨‹ä¸Šçš„ä¼˜åŒ–ï¼Œå…³äºTilingå’ŒRecomputeçš„æ ¸å¿ƒæ€è·¯ï¼Œå’ŒFlashAttention-1æ˜¯ä¸€è‡´çš„ã€‚ä¼¼ä¹ä¹Ÿæ²¡çœ‹åˆ°FA2çš„è®ºæ–‡æŠ•åˆ°é¡¶ä¼šï¼Œåªæ˜¯æŒ‚äº†arxivï¼ˆåæ§½...è€Œä¸”çœŸçš„æœ‰äº›é”™è¯¯çš„å…¬å¼åæ¥ä¼¼ä¹å°±ä¸€ç›´æ²¡ä¿®...ï¼‰æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ç»§ç»­çœ‹ä¸‹FlashAttention-2éƒ½åšäº†å“ªäº›ä¼˜åŒ–ã€‚ä¼˜åŒ–ç‚¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ï¼š

> 1. å‡å°‘å¤§é‡ématmulçš„å†—ä½™è®¡ç®—ï¼Œå¢åŠ Tensor Coresè¿ç®—æ¯”ä¾‹  
> 2. forward pass/backward passå‡å¢åŠ seqlenç»´åº¦çš„å¹¶è¡Œï¼Œforward passäº¤æ›¿Q,K,Vå¾ªç¯é¡ºåº  
> 3. æ›´å¥½çš„Warp Partitioningç­–ç•¥ï¼Œé¿å…Split-Kï¼ˆæ„Ÿè§‰è¿™éƒ¨åˆ†æ˜¯ä¸ºäº†æ•…äº‹å®Œæ•´åŠ ä¸Šçš„...ï¼‰

## FlashAttention V3: æ¯”V2æ›´å¿«ã€æ”¯æŒHopper FP8

FlashAttention V3æœ€è¿‘æ­£å¼å‘å¸ƒï¼ŒFP16æ¯”FA2æ›´å¿«ï¼Œæ”¯æŒHopper FP8ã€‚

ä¼˜åŒ–æœ€æ–° Hopperï¼ˆH100ï¼‰æ¶æ„ä¸Šå¯¹ FP8 å’Œ Tensor Core çš„æ”¯æŒ

## å‚è€ƒèµ„æ–™

[Flash AttentionåŸç†è¯¦è§£(å«ä»£ç è®²è§£) - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/676655352)

[flash attention V1 V2 V3 V4 å¦‚ä½•åŠ é€Ÿ attention - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/685020608)

[ [Attentionä¼˜åŒ–][2wå­—]ğŸ”¥åŸç†ç¯‡: ä»Online-Softmaxåˆ°FlashAttention V1/V2/V3](https://zhuanlan.zhihu.com/p/668888063)

[é€šä¿—æ˜“æ‡‚èŠflashAttentionçš„åŠ é€ŸåŸç†](https://zhuanlan.zhihu.com/p/672698614)

[FlashAttention çš„é€Ÿåº¦ä¼˜åŒ–åŸç†æ˜¯æ€æ ·çš„ï¼Ÿ](https://www.zhihu.com/question/611236756/answer/3132304304)

