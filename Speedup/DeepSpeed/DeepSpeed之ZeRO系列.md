## DeepSpeedé›†æˆ

DeepSpeedæ”¯æŒ

1. ä¼˜åŒ–å™¨çŠ¶æ€åˆ†åŒºï¼ˆZeRO stage 1ï¼‰
2. æ¢¯åº¦åˆ†åŒºï¼ˆZeRO stage 2ï¼‰
3. å‚æ•°åˆ†åŒºï¼ˆZeRO stage 3ï¼‰
4. è‡ªå®šä¹‰æ··åˆç²¾åº¦è®­ç»ƒå¤„ç†
5. ä¸€ç³»åˆ—åŸºäºCUDAæ‰©å±•çš„å¿«é€Ÿä¼˜åŒ–å™¨
6. ZeRO-Offload åˆ° CPU å’Œ NVMe

ZeRO-Offloadæœ‰å…¶è‡ªå·±çš„ä¸“é—¨è®ºæ–‡ï¼š[ZeRO-Offload: Democratizing Billion-Scale Model Training](https://arxiv.org/abs/2101.06840)ã€‚è€ŒNVMeæ”¯æŒåœ¨è®ºæ–‡[ZeRO-Infinity: Breaking the GPU Memory Wall for Extreme Scale Deep Learning](https://arxiv.org/abs/2104.07857)ä¸­è¿›è¡Œäº†æè¿°ã€‚

DeepSpeed ZeRO-2ä¸»è¦ç”¨äºè®­ç»ƒï¼Œå› ä¸ºå®ƒçš„ç‰¹æ€§å¯¹æ¨ç†æ²¡æœ‰ç”¨å¤„ã€‚

DeepSpeed ZeRO-3ä¹Ÿå¯ä»¥ç”¨äºæ¨ç†ï¼Œå› ä¸ºå®ƒå…è®¸å°†å•ä¸ªGPUæ— æ³•åŠ è½½çš„å¤§æ¨¡å‹åŠ è½½åˆ°å¤šä¸ªGPUä¸Šã€‚

ğŸ¤— Transformersé€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼é›†æˆäº†[DeepSpeed](https://github.com/microsoft/DeepSpeed)ï¼š

1. é€šè¿‡`Trainer`é›†æˆæ ¸å¿ƒçš„DeepSpeedåŠŸèƒ½ã€‚è¿™æ˜¯ä¸€ç§â€œä¸ºæ‚¨å®Œæˆä¸€åˆ‡â€å¼çš„é›†æˆ - æ‚¨åªéœ€æä¾›è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æˆ–ä½¿ç”¨æˆ‘ä»¬çš„æ¨¡æ¿é…ç½®æ–‡ä»¶ã€‚æœ¬æ–‡æ¡£çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½é›†ä¸­åœ¨è¿™ä¸ªåŠŸèƒ½ä¸Šã€‚
2. å¦‚æœæ‚¨ä¸ä½¿ç”¨`Trainer`å¹¶å¸Œæœ›åœ¨è‡ªå·±çš„Trainerä¸­é›†æˆDeepSpeedï¼Œé‚£ä¹ˆåƒ`from_pretrained`å’Œ`from_config`è¿™æ ·çš„æ ¸å¿ƒåŠŸèƒ½å‡½æ•°å°†åŒ…æ‹¬ZeRO stage 3åŠä»¥ä¸Šçš„DeepSpeedçš„åŸºç¡€éƒ¨åˆ†ï¼Œå¦‚`zero.Init`ã€‚è¦åˆ©ç”¨æ­¤åŠŸèƒ½ï¼Œè¯·é˜…è¯»æœ‰å…³[éTrainer DeepSpeedé›†æˆ](https://huggingface.co/docs/transformers/zh/main_classes/deepspeed#nontrainer-deepspeed-integration)çš„æ–‡æ¡£ã€‚

é›†æˆçš„å†…å®¹ï¼š

è®­ç»ƒï¼š

1. DeepSpeed ZeROè®­ç»ƒæ”¯æŒå®Œæ•´çš„ZeRO stages 1ã€2å’Œ3ï¼Œä»¥åŠZeRO-Infinityï¼ˆCPUå’ŒNVMe offloadï¼‰ã€‚

æ¨ç†ï¼š

2. DeepSpeed ZeROæ¨ç†æ”¯æŒZeRO stage 3å’ŒZeRO-Infinityã€‚å®ƒä½¿ç”¨ä¸è®­ç»ƒç›¸åŒçš„ZeROåè®®ï¼Œä½†ä¸ä½¿ç”¨ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡è°ƒåº¦å™¨ï¼Œåªæœ‰stage 3ä¸æ¨ç†ç›¸å…³ã€‚æ›´å¤šè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…ï¼š[zero-inference](https://huggingface.co/docs/transformers/zh/main_classes/deepspeed#zero-inference)ã€‚

æ­¤å¤–è¿˜æœ‰DeepSpeedæ¨ç† - è¿™æ˜¯ä¸€ç§å®Œå…¨ä¸åŒçš„æŠ€æœ¯ï¼Œå®ƒä½¿ç”¨å¼ é‡å¹¶è¡Œè€Œä¸æ˜¯ZeROï¼ˆå³å°†æ¨å‡ºï¼‰ã€‚

## ä¸ºä»€ä¹ˆéœ€è¦å•GPUå¯åŠ¨

```python
deepspeed --num_gpus=1 examples/pytorch/translation/run_translation.py \
--deepspeed tests/deepspeed/ds_config_zero2.json \
--model_name_or_path google-t5/t5-small --per_device_train_batch_size 1 \
--output_dir output_dir --overwrite_output_dir --fp16 \
--do_train --max_train_samples 500 --num_train_epochs 1 \
--dataset_name wmt16 --dataset_config "ro-en" \
--source_lang en --target_lang ro
```

ä¸ºä»€ä¹ˆè¦åœ¨ä»…ä½¿ç”¨ä¸€å¼  GPU çš„æƒ…å†µä¸‹ä½¿ç”¨ DeepSpeed å‘¢ï¼Ÿ

1. å®ƒå…·æœ‰ ZeRO-offload åŠŸèƒ½ï¼Œå¯ä»¥å°†ä¸€äº›è®¡ç®—å’Œå†…å­˜å§”æ‰˜ç»™ä¸»æœºçš„ CPU å’Œ å†…å­˜ï¼Œä»è€Œä¸ºæ¨¡å‹çš„éœ€æ±‚ä¿ç•™æ›´å¤š GPU èµ„æº - ä¾‹å¦‚æ›´å¤§çš„æ‰¹å¤„ç†å¤§å°ï¼Œæˆ–å¯ç”¨æ­£å¸¸æƒ…å†µä¸‹æ— æ³•å®¹çº³çš„éå¸¸å¤§æ¨¡å‹ã€‚
2. å®ƒæä¾›äº†æ™ºèƒ½çš„ GPU å†…å­˜ç®¡ç†ç³»ç»Ÿï¼Œæœ€å°åŒ–å†…å­˜ç¢ç‰‡ï¼Œè¿™å†æ¬¡å…è®¸æ‚¨å®¹çº³æ›´å¤§çš„æ¨¡å‹å’Œæ•°æ®æ‰¹æ¬¡ã€‚

è™½ç„¶æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºé…ç½®ï¼Œä½†åœ¨å•ä¸ª GPU ä¸Šé€šè¿‡ DeepSpeed å®ç°å·¨å¤§æ€§èƒ½æå‡çš„å…³é”®æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­è‡³å°‘æœ‰ä»¥ä¸‹é…ç½®ï¼š

{
  "zero_optimization": {
     "stage": 2,
     "offload_optimizer": {
         "device": "cpu",
         "pin_memory": true
     },
     "allgather_partitions": true,
     "allgather_bucket_size": 2e8,
     "reduce_scatter": true,
     "reduce_bucket_size": 2e8,
     "overlap_comm": true,
     "contiguous_gradients": true
  }
}

è¿™ä¼šå¯ç”¨`optimizer offload`Â å’Œä¸€äº›å…¶ä»–é‡è¦åŠŸèƒ½ã€‚æ‚¨å¯ä»¥å°è¯•ä¸åŒçš„bufferå¤§å°

æ³¨æ„ï¼š

- å¦‚æœæ‚¨éœ€è¦åœ¨ç‰¹å®šçš„ GPU ä¸Šè¿è¡Œï¼Œè€Œä¸æ˜¯ GPU 0ï¼Œåˆ™æ— æ³•ä½¿ç”¨Â `CUDA_VISIBLE_DEVICES`Â æ¥é™åˆ¶å¯ç”¨ GPU çš„å¯è§èŒƒå›´ã€‚ç›¸åï¼Œæ‚¨å¿…é¡»ä½¿ç”¨ä»¥ä¸‹è¯­æ³•ï¼š
    
    Copied
    
    deepspeed --include localhost:1 examples/pytorch/translation/run_translation.py ...
    
    åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å‘Šè¯‰ DeepSpeed ä½¿ç”¨ GPU 1ï¼ˆç¬¬äºŒä¸ª GPUï¼‰ã€‚
    

## ZeRO

[Zero Redundancy Optimizer (ZeRO)](https://www.deepspeed.ai/tutorials/zero/)Â æ˜¯ DeepSpeed çš„å·¥ä½œæ ¸å¿ƒã€‚å®ƒæ”¯æŒ3ä¸ªä¸åŒçº§åˆ«ï¼ˆstagesï¼‰çš„ä¼˜åŒ–ã€‚Stage 1 å¯¹äºæ‰©å±•æ€§æ¥è¯´ä¸æ˜¯å¾ˆæœ‰è¶£ï¼Œå› æ­¤æœ¬æ–‡æ¡£é‡ç‚¹å…³æ³¨Stage 2å’ŒStage 3ã€‚Stage 3é€šè¿‡æœ€æ–°çš„ ZeRO-Infinity è¿›ä¸€æ­¥æ”¹è¿›ã€‚ä½ å¯ä»¥åœ¨ DeepSpeed æ–‡æ¡£ä¸­æ‰¾åˆ°æ›´è¯¦ç»†çš„ä¿¡æ¯ã€‚

é…ç½®æ–‡ä»¶çš„Â `zero_optimization`Â éƒ¨åˆ†æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼ˆ[æ–‡æ¡£](https://www.deepspeed.ai/docs/config-json/#zero-optimizations-for-fp16-training)ï¼‰ï¼Œå› ä¸ºåœ¨è¿™é‡Œæ‚¨å®šä¹‰äº†è¦å¯ç”¨å“ªäº› ZeRO stages ä»¥åŠå¦‚ä½•é…ç½®å®ƒä»¬ã€‚æ‚¨å¯ä»¥åœ¨ DeepSpeed æ–‡æ¡£ä¸­æ‰¾åˆ°æ¯ä¸ªå‚æ•°çš„è§£é‡Šã€‚

### offload_optimizer å’Œ offload_param 

1. offload_optimizer:
   - è¿™ä¸ªé€‰é¡¹ä¸»è¦æŒ‡çš„æ˜¯å°†ä¼˜åŒ–å™¨çŠ¶æ€å¸è½½åˆ°CPUã€‚
   - ä¼˜åŒ–å™¨çŠ¶æ€åŒ…æ‹¬è¯¸å¦‚åŠ¨é‡ã€æ–¹å·®ç­‰ï¼Œè¿™å–å†³äºæ‰€ä½¿ç”¨çš„ä¼˜åŒ–å™¨ï¼ˆå¦‚Adamã€AdamWç­‰ï¼‰ã€‚
   - ä¹ŸåŒ…æ‹¬æ¢¯åº¦ï¼Œå› ä¸ºä¼˜åŒ–å™¨éœ€è¦ä½¿ç”¨æ¢¯åº¦æ¥æ›´æ–°å‚æ•°ã€‚

2. offload_param:
   - è¿™ä¸ªé€‰é¡¹æŒ‡çš„æ˜¯å°†æ¨¡å‹å‚æ•°å¸è½½åˆ°CPUã€‚
   - æ¨¡å‹å‚æ•°æ˜¯æŒ‡ç¥ç»ç½‘ç»œçš„æƒé‡å’Œåç½®ã€‚

æ›´è¯¦ç»†çš„è§£é‡Šï¼š

- offload_optimizer:
  - å½“å¯ç”¨æ—¶ï¼Œä¼˜åŒ–å™¨çš„çŠ¶æ€ï¼ˆå¦‚Adamä¼˜åŒ–å™¨ä¸­çš„ä¸€é˜¶çŸ©å’ŒäºŒé˜¶çŸ©ï¼‰ä¼šå­˜å‚¨åœ¨CPUå†…å­˜ä¸­ã€‚
  - åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæ¢¯åº¦ä¼šå…ˆåœ¨GPUä¸Šè®¡ç®—ï¼Œç„¶åä¼ è¾“åˆ°CPUã€‚
  - å‚æ•°æ›´æ–°åœ¨CPUä¸Šè¿›è¡Œï¼Œç„¶åæ›´æ–°åçš„å‚æ•°å†ä¼ å›GPUã€‚

- offload_param:
  - å½“å¯ç”¨æ—¶ï¼Œæ¨¡å‹çš„å‚æ•°åœ¨ä¸éœ€è¦æ—¶ä¼šå­˜å‚¨åœ¨CPUå†…å­˜ä¸­ã€‚
  - åœ¨å‰å‘ä¼ æ’­æ—¶ï¼Œéœ€è¦ç”¨åˆ°çš„å‚æ•°ä¼šä»CPUä¼ è¾“åˆ°GPUã€‚
  - åœ¨åå‘ä¼ æ’­å®Œæˆåï¼Œå‚æ•°åˆä¼šè¢«ç§»å›CPUã€‚

è¿™ä¸¤ä¸ªé€‰é¡¹çš„ä¸»è¦åŒºåˆ«ï¼š
- offload_optimizer ä¸»è¦å½±å“è®­ç»ƒè¿‡ç¨‹ä¸­ä¼˜åŒ–å™¨ç›¸å…³çš„å†…å­˜ä½¿ç”¨ã€‚
- offload_param ç›´æ¥å½±å“æ¨¡å‹å‚æ•°çš„å­˜å‚¨ä½ç½®ï¼Œå¯èƒ½å¯¹æ¨ç†å’Œè®­ç»ƒéƒ½æœ‰å½±å“ã€‚

ä½¿ç”¨è¿™äº›é€‰é¡¹å¯ä»¥æ˜¾è‘—å‡å°‘GPUå†…å­˜çš„ä½¿ç”¨ï¼Œä½†å¯èƒ½ä¼šå¢åŠ CPU-GPUä¹‹é—´çš„æ•°æ®ä¼ è¾“ï¼Œä»è€Œå½±å“è®­ç»ƒé€Ÿåº¦ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨æ—¶éœ€è¦æƒè¡¡å†…å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦ã€‚

åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé¦–å…ˆå°è¯• offload_optimizer å¯èƒ½å°±è¶³å¤Ÿäº†ã€‚å¦‚æœGPUå†…å­˜ä»ç„¶ä¸è¶³ï¼Œå†è€ƒè™‘ä½¿ç”¨ offload_paramã€‚

é€šè¿‡å°†Â `pin_memory`Â è®¾ç½®ä¸ºÂ `true`Â å¯ç”¨å›ºå®šå†…å­˜ã€‚æ­¤åŠŸèƒ½ä¼šä»¥å‡å°‘å¯ç”¨äºå…¶ä»–è¿›ç¨‹çš„å†…å­˜ä¸ºä»£ä»·æ¥æé«˜ååé‡ã€‚å›ºå®šå†…å­˜è¢«åˆ†é…ç»™ç‰¹å®šè¯·æ±‚å®ƒçš„è¿›ç¨‹ï¼Œé€šå¸¸æ¯”æ™®é€š CPU å†…å­˜è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚

### ZeRO-2 é…ç½®

```
{
    "zero_optimization": {
        "stage": 2,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "allgather_partitions": true,
        "allgather_bucket_size": 5e8,
        "overlap_comm": true,
        "reduce_scatter": true,
        "reduce_bucket_size": 5e8,
        "contiguous_gradients": true
    }
}
```

**æ€§èƒ½è°ƒä¼˜ï¼š**

- å¯ç”¨Â `offload_optimizer`Â åº”è¯¥å‡å°‘ GPU å†…å­˜ä½¿ç”¨ï¼ˆéœ€è¦Â `"stage": 2`ï¼‰ã€‚
- `"overlap_comm": true`Â é€šè¿‡å¢åŠ  GPU å†…å­˜ä½¿ç”¨æ¥é™ä½all-reduce çš„å»¶è¿Ÿã€‚Â `overlap_comm`Â ä½¿ç”¨äº†Â `allgather_bucket_size`Â å’ŒÂ `reduce_bucket_size`Â å€¼çš„4.5å€ã€‚å› æ­¤ï¼Œå¦‚æœå®ƒä»¬è®¾ç½®ä¸ºÂ `5e8`ï¼Œè¿™å°†éœ€è¦ä¸€ä¸ª9GBçš„å†…å­˜å ç”¨ï¼ˆ`5e8 x 2Bytes x 2 x 4.5`ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨çš„ GPU å†…å­˜ä¸º8GBæˆ–æ›´å°ï¼Œä¸ºäº†é¿å…å‡ºç°OOMé”™è¯¯ï¼Œæ‚¨éœ€è¦å°†è¿™äº›å‚æ•°å‡å°åˆ°çº¦Â `2e8`ï¼Œè¿™å°†éœ€è¦3.6GBã€‚å¦‚æœæ‚¨çš„ GPU å®¹é‡æ›´å¤§ï¼Œå½“æ‚¨å¼€å§‹é‡åˆ°OOMæ—¶ï¼Œä½ å¯èƒ½ä¹Ÿéœ€è¦è¿™æ ·åšã€‚
- å½“å‡å°è¿™äº›buffersæ—¶ï¼Œæ‚¨ä»¥æ›´æ…¢çš„é€šä¿¡é€Ÿåº¦æ¥æ¢å–æ›´å¤šçš„ GPU å†…å­˜ã€‚bufferså¤§å°è¶Šå°ï¼Œé€šä¿¡é€Ÿåº¦è¶Šæ…¢ï¼ŒGPU å¯ç”¨äºå…¶ä»–ä»»åŠ¡çš„å†…å­˜å°±è¶Šå¤šã€‚å› æ­¤ï¼Œå¦‚æœæ›´å¤§çš„æ‰¹å¤„ç†å¤§å°å¾ˆé‡è¦ï¼Œé‚£ä¹ˆç¨å¾®å‡æ…¢è®­ç»ƒæ—¶é—´å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æƒè¡¡ã€‚

æ­¤å¤–ï¼Œ`deepspeed==0.4.4`Â æ·»åŠ äº†ä¸€ä¸ªæ–°é€‰é¡¹Â `round_robin_gradients`ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ç”¨ï¼š

{
    "zero_optimization": {
        "round_robin_gradients": true
    }
}

è¿™æ˜¯ä¸€ä¸ªç”¨äº CPU offloading çš„stage 2ä¼˜åŒ–ï¼Œé€šè¿‡ç»†ç²’åº¦æ¢¯åº¦åˆ†åŒºåœ¨ ranks ä¹‹é—´å¹¶è¡Œå¤åˆ¶åˆ° CPU å†…å­˜ï¼Œä»è€Œå®ç°äº†æ€§èƒ½çš„æå‡ã€‚æ€§èƒ½ä¼˜åŠ¿éšç€æ¢¯åº¦ç´¯ç§¯æ­¥éª¤ï¼ˆåœ¨ä¼˜åŒ–å™¨æ­¥éª¤ä¹‹é—´è¿›è¡Œæ›´å¤šå¤åˆ¶ï¼‰æˆ– GPU æ•°é‡ï¼ˆå¢åŠ å¹¶è¡Œæ€§ï¼‰å¢åŠ è€Œå¢åŠ ã€‚

### ZeRO-3 é…ç½®

```
{
    "zero_optimization": {
        "stage": 3,
        "offload_optimizer": {
            "device": "cpu",
            "pin_memory": true
        },
        "offload_param": {
            "device": "cpu",
            "pin_memory": true
        },
        "overlap_comm": true,
        "contiguous_gradients": true,
        "sub_group_size": 1e9,
        "reduce_bucket_size": "auto",
        "stage3_prefetch_bucket_size": "auto",
        "stage3_param_persistence_threshold": "auto",
        "stage3_max_live_parameters": 1e9,
        "stage3_max_reuse_distance": 1e9,
        "stage3_gather_16bit_weights_on_model_save": true
    }
}
```

å¦‚æœæ‚¨å› ä¸ºä½ çš„æ¨¡å‹æˆ–æ¿€æ´»å€¼è¶…è¿‡ GPU å†…å­˜è€Œé‡åˆ°OOMé—®é¢˜ï¼Œå¹¶ä¸”æ‚¨æœ‰æœªä½¿ç”¨çš„ CPU å†…å­˜ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨Â `"device": "cpu"`Â å°†ä¼˜åŒ–å™¨çŠ¶æ€å’Œå‚æ•°å¸è½½åˆ° CPU å†…å­˜ä¸­ï¼Œæ¥è§£å†³è¿™ä¸ªé™åˆ¶ã€‚å¦‚æœæ‚¨ä¸æƒ³å¸è½½åˆ° CPU å†…å­˜ï¼Œå¯ä»¥åœ¨Â `device`Â æ¡ç›®ä¸­ä½¿ç”¨Â `none`Â ä»£æ›¿Â `cpu`ã€‚å°†ä¼˜åŒ–å™¨çŠ¶æ€å¸è½½åˆ° NVMe ä¸Šä¼šåœ¨åé¢è¿›ä¸€æ­¥è®¨è®ºã€‚

é€šè¿‡å°†Â `pin_memory`Â è®¾ç½®ä¸ºÂ `true`Â å¯ç”¨å›ºå®šå†…å­˜ã€‚æ­¤åŠŸèƒ½ä¼šä»¥å‡å°‘å¯ç”¨äºå…¶ä»–è¿›ç¨‹çš„å†…å­˜ä¸ºä»£ä»·æ¥æé«˜ååé‡ã€‚å›ºå®šå†…å­˜è¢«åˆ†é…ç»™ç‰¹å®šè¯·æ±‚å®ƒçš„è¿›ç¨‹ï¼Œé€šå¸¸æ¯”æ™®é€š CPU å†…å­˜è®¿é—®é€Ÿåº¦æ›´å¿«ã€‚

**æ€§èƒ½è°ƒä¼˜ï¼š**

- `stage3_max_live_parameters`:Â `1e9`
- `stage3_max_reuse_distance`:Â `1e9`

å¦‚æœé‡åˆ°OOMé—®é¢˜ï¼Œè¯·å‡å°Â `stage3_max_live_parameters`Â å’ŒÂ `stage3_max_reuse_distance`ã€‚å®ƒä»¬å¯¹æ€§èƒ½çš„å½±å“åº”è¯¥å¾ˆå°ï¼Œé™¤éæ‚¨æ­£åœ¨è¿›è¡Œæ¿€æ´»å€¼checkpointingã€‚`1e9`Â å¤§çº¦ä¼šæ¶ˆè€— ~2GBã€‚å†…å­˜ç”±Â `stage3_max_live_parameters`Â å’ŒÂ `stage3_max_reuse_distance`Â å…±äº«ï¼Œæ‰€ä»¥å®ƒä¸æ˜¯å åŠ çš„ï¼Œè€Œæ˜¯æ€»å…±2GBã€‚

`stage3_max_live_parameters`Â æ˜¯åœ¨ä»»ä½•ç»™å®šæ—¶é—´è¦åœ¨ GPU ä¸Šä¿ç•™å¤šå°‘ä¸ªå®Œæ•´å‚æ•°çš„ä¸Šé™ã€‚â€œreuse distanceâ€ æ˜¯æˆ‘ä»¬ç”¨æ¥ç¡®å®šå‚æ•°åœ¨å°†æ¥ä½•æ—¶ä¼šå†æ¬¡ä½¿ç”¨çš„åº¦é‡æ ‡å‡†ï¼Œæˆ‘ä»¬ä½¿ç”¨Â `stage3_max_reuse_distance`Â æ¥å†³å®šæ˜¯ä¸¢å¼ƒå‚æ•°è¿˜æ˜¯ä¿ç•™å‚æ•°ã€‚å¦‚æœä¸€ä¸ªå‚æ•°åœ¨ä¸ä¹…çš„å°†æ¥ï¼ˆå°äºÂ `stage3_max_reuse_distance`ï¼‰å°†è¢«å†æ¬¡ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å…¶ä¿ç•™ä»¥å‡å°‘é€šä¿¡å¼€é”€ã€‚è¿™åœ¨å¯ç”¨æ¿€æ´»å€¼checkpoingæ—¶éå¸¸æœ‰ç”¨ï¼Œå…¶ä¸­æˆ‘ä»¬ä»¥å•å±‚ç²’åº¦è¿›è¡Œå‰å‘é‡è®¡ç®—å’Œåå‘ä¼ æ’­ï¼Œå¹¶å¸Œæœ›åœ¨åå‘ä¼ æ’­æœŸé—´ä¿ç•™å‰å‘é‡è®¡ç®—ä¸­çš„å‚æ•°ã€‚

ä»¥ä¸‹é…ç½®å€¼å–å†³äºæ¨¡å‹çš„éšè—å¤§å°ï¼š

- `reduce_bucket_size`:Â `hidden_size*hidden_size`
- `stage3_prefetch_bucket_size`:Â `0.9 * hidden_size * hidden_size`
- `stage3_param_persistence_threshold`:Â `10 * hidden_size`

å› æ­¤ï¼Œå°†è¿™äº›å€¼è®¾ç½®ä¸ºÂ `auto`ï¼Œ`Trainer`Â å°†è‡ªåŠ¨åˆ†é…æ¨èçš„å‚æ•°å€¼ã€‚å½“ç„¶ï¼Œå¦‚æœæ‚¨æ„¿æ„ï¼Œä¹Ÿå¯ä»¥æ˜¾å¼è®¾ç½®è¿™äº›å€¼ã€‚

`stage3_gather_16bit_weights_on_model_save`Â åœ¨æ¨¡å‹ä¿å­˜æ—¶å¯ç”¨æ¨¡å‹çš„ fp16 æƒé‡æ•´åˆã€‚å¯¹äºå¤§æ¨¡å‹å’Œå¤šä¸ª GPUï¼Œæ— è®ºæ˜¯åœ¨å†…å­˜è¿˜æ˜¯é€Ÿåº¦æ–¹é¢ï¼Œè¿™éƒ½æ˜¯ä¸€é¡¹æ˜‚è´µçš„æ“ä½œã€‚ç›®å‰å¦‚æœè®¡åˆ’æ¢å¤è®­ç»ƒï¼Œè¿™æ˜¯å¿…éœ€çš„ã€‚è¯·æ³¨æ„æœªæ¥çš„æ›´æ–°å¯èƒ½ä¼šåˆ é™¤æ­¤é™åˆ¶å¹¶è®©ä½¿ç”¨æ›´åŠ çµæ´»ã€‚

å¦‚æœæ‚¨ä» ZeRO-2 é…ç½®è¿ç§»ï¼Œè¯·æ³¨æ„Â `allgather_partitions`ã€`allgather_bucket_size`Â å’ŒÂ `reduce_scatter`Â é…ç½®å‚æ•°åœ¨ ZeRO-3 ä¸­ä¸è¢«ä½¿ç”¨ã€‚å¦‚æœä¿ç•™è¿™äº›é…ç½®æ–‡ä»¶ï¼Œå®ƒä»¬å°†è¢«å¿½ç•¥ã€‚

- `sub_group_size`:Â `1e9`

`sub_group_size`Â æ§åˆ¶åœ¨ä¼˜åŒ–å™¨æ­¥éª¤æœŸé—´æ›´æ–°å‚æ•°çš„ç²’åº¦ã€‚å‚æ•°è¢«åˆ†ç»„åˆ°å¤§å°ä¸ºÂ `sub_group_size`Â çš„æ¡¶ä¸­ï¼Œæ¯ä¸ªæ¡¶é€ä¸ªæ›´æ–°ã€‚åœ¨ ZeRO-Infinity ä¸­ä¸ NVMe offloadä¸€èµ·ä½¿ç”¨æ—¶ï¼Œ`sub_group_size`Â æ§åˆ¶äº†åœ¨ä¼˜åŒ–å™¨æ­¥éª¤æœŸé—´åœ¨ NVMe å’Œ CPU å†…å­˜ä¹‹é—´ç§»åŠ¨æ¨¡å‹çŠ¶æ€çš„ç²’åº¦ã€‚è¿™å¯ä»¥é˜²æ­¢éå¸¸å¤§çš„æ¨¡å‹è€—å°½ CPU å†…å­˜ã€‚

å½“ä¸ä½¿ç”¨ NVMe offloadæ—¶ï¼Œå¯ä»¥å°†Â `sub_group_size`Â ä¿ç•™ä¸ºå…¶é»˜è®¤å€¼Â _1e9_ã€‚åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦æ›´æ”¹å…¶é»˜è®¤å€¼ï¼š

1. åœ¨ä¼˜åŒ–å™¨æ­¥éª¤ä¸­é‡åˆ°OOMï¼šå‡å°Â `sub_group_size`Â ä»¥å‡å°‘ä¸´æ—¶buffersçš„å†…å­˜åˆ©ç”¨
2. ä¼˜åŒ–å™¨æ­¥éª¤èŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼šå¢åŠ Â `sub_group_size`Â ä»¥æé«˜ç”±äºå¢åŠ çš„æ•°æ®buffersè€Œå¯¼è‡´çš„å¸¦å®½åˆ©ç”¨ç‡ã€‚

### ZeRO-0 é…ç½®

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å°† Stage 0 å’Œ 1 æ”¾åœ¨æœ€åï¼Œå› ä¸ºå®ƒä»¬å¾ˆå°‘ä½¿ç”¨ã€‚

Stage 0 ç¦ç”¨äº†æ‰€æœ‰ç±»å‹çš„åˆ†ç‰‡ï¼Œåªæ˜¯å°† DeepSpeed ä½œä¸º DDP ä½¿ç”¨ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å¯ç”¨ï¼š

{
    "zero_optimization": {
        "stage": 0
    }
}

è¿™å°†å®è´¨ä¸Šç¦ç”¨ ZeROï¼Œè€Œæ— éœ€æ›´æ”¹å…¶ä»–ä»»ä½•å†…å®¹ã€‚

### ZeRO-1 é…ç½®

Stage 1 ç­‰åŒäº Stage 2 å‡å»æ¢¯åº¦åˆ†ç‰‡ã€‚æ‚¨å¯ä»¥å°è¯•ä½¿ç”¨ä»¥ä¸‹é…ç½®ï¼Œä»…å¯¹ä¼˜åŒ–å™¨çŠ¶æ€è¿›è¡Œåˆ†ç‰‡ï¼Œä»¥ç¨å¾®åŠ é€Ÿï¼š

Copied

{
    "zero_optimization": {
        "stage": 1
    }
}

## NVMe æ”¯æŒ

ZeRO-Infinity é€šè¿‡ä½¿ç”¨ NVMe å†…å­˜æ‰©å±• GPU å’Œ CPU å†…å­˜ï¼Œä»è€Œå…è®¸è®­ç»ƒéå¸¸å¤§çš„æ¨¡å‹ã€‚ç”±äºæ™ºèƒ½åˆ†åŒºå’Œå¹³é“ºç®—æ³•ï¼Œåœ¨offloadæœŸé—´æ¯ä¸ª GPU éœ€è¦å‘é€å’Œæ¥æ”¶éå¸¸å°é‡çš„æ•°æ®ï¼Œå› æ­¤ NVMe è¢«è¯æ˜é€‚ç”¨äºè®­ç»ƒè¿‡ç¨‹ä¸­æä¾›æ›´å¤§çš„æ€»å†…å­˜æ± ã€‚ZeRO-Infinity éœ€è¦å¯ç”¨ ZeRO-3ã€‚

ä»¥ä¸‹é…ç½®ç¤ºä¾‹å¯ç”¨ NVMe æ¥offloadä¼˜åŒ–å™¨çŠ¶æ€å’Œå‚æ•°ï¼š

{
    "zero_optimization": {
        "stage": 3,
        "offload_optimizer": {
            "device": "nvme",
            "nvme_path": "/local_nvme",
            "pin_memory": true,
            "buffer_count": 4,
            "fast_init": false
        },
        "offload_param": {
            "device": "nvme",
            "nvme_path": "/local_nvme",
            "pin_memory": true,
            "buffer_count": 5,
            "buffer_size": 1e8,
            "max_in_cpu": 1e9
        },
        "aio": {
            "block_size": 262144,
            "queue_depth": 32,
            "thread_count": 1,
            "single_submit": false,
            "overlap_events": true
        },
        "overlap_comm": true,
        "contiguous_gradients": true,
        "sub_group_size": 1e9,
        "reduce_bucket_size": "auto",
        "stage3_prefetch_bucket_size": "auto",
        "stage3_param_persistence_threshold": "auto",
        "stage3_max_live_parameters": 1e9,
        "stage3_max_reuse_distance": 1e9,
        "stage3_gather_16bit_weights_on_model_save": true
    },
}

æ‚¨å¯ä»¥é€‰æ‹©å°†ä¼˜åŒ–å™¨çŠ¶æ€å’Œå‚æ•°éƒ½å¸è½½åˆ° NVMeï¼Œä¹Ÿå¯ä»¥åªé€‰æ‹©å…¶ä¸­ä¸€ä¸ªï¼Œæˆ–è€…éƒ½ä¸é€‰æ‹©ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨æœ‰å¤§é‡çš„ CPU å†…å­˜å¯ç”¨ï¼Œåªå¸è½½åˆ° CPU å†…å­˜è®­ç»ƒé€Ÿåº¦ä¼šæ›´å¿«ï¼ˆæç¤ºï¼šâ€œdeviceâ€: â€œcpuâ€ï¼‰ã€‚

è¿™æ˜¯æœ‰å…³å¸è½½Â [ä¼˜åŒ–å™¨çŠ¶æ€](https://www.deepspeed.ai/docs/config-json/#optimizer-offloading)Â å’ŒÂ [å‚æ•°](https://www.deepspeed.ai/docs/config-json/#parameter-offloading)Â çš„å®Œæ•´æ–‡æ¡£ã€‚

ç¡®ä¿æ‚¨çš„Â `nvme_path`Â å®é™…ä¸Šæ˜¯ä¸€ä¸ª NVMeï¼Œå› ä¸ºå®ƒä¸æ™®é€šç¡¬ç›˜æˆ– SSD ä¸€èµ·å·¥ä½œï¼Œä½†é€Ÿåº¦ä¼šæ…¢å¾—å¤šã€‚å¿«é€Ÿå¯æ‰©å±•çš„è®­ç»ƒæ˜¯æ ¹æ®ç°ä»£ NVMe ä¼ è¾“é€Ÿåº¦è®¾è®¡çš„ï¼ˆæˆªè‡³æœ¬æ–‡æ’°å†™æ—¶ï¼Œå¯ä»¥è¾¾åˆ° ~3.5GB/s è¯»å–ï¼Œ~3GB/s å†™å…¥çš„å³°å€¼é€Ÿåº¦ï¼‰ã€‚

ä¸ºäº†æ‰¾å‡ºæœ€ä½³çš„Â `aio`Â é…ç½®å—ï¼Œæ‚¨å¿…é¡»åœ¨ç›®æ ‡è®¾ç½®ä¸Šè¿è¡Œä¸€ä¸ªåŸºå‡†æµ‹è¯•ï¼Œå…·ä½“æ“ä½œè¯·å‚è§[è¯´æ˜](https://github.com/microsoft/DeepSpeed/issues/998)ã€‚

### ZeRO-2 å’Œ ZeRO-3 æ€§èƒ½å¯¹æ¯”

å¦‚æœå…¶ä»–ä¸€åˆ‡éƒ½é…ç½®ç›¸åŒï¼ŒZeRO-3 å¯èƒ½æ¯” ZeRO-2 æ…¢ï¼Œå› ä¸ºå‰è€…é™¤äº† ZeRO-2 çš„æ“ä½œå¤–ï¼Œè¿˜å¿…é¡»æ”¶é›†æ¨¡å‹æƒé‡ã€‚å¦‚æœ ZeRO-2 æ»¡è¶³æ‚¨çš„éœ€æ±‚ï¼Œè€Œä¸”æ‚¨ä¸éœ€è¦æ‰©å±•åˆ°å‡ ä¸ª GPU ä»¥ä¸Šï¼Œé‚£ä¹ˆæ‚¨å¯ä»¥é€‰æ‹©ç»§ç»­ä½¿ç”¨å®ƒã€‚é‡è¦çš„æ˜¯è¦ç†è§£ï¼ŒZeRO-3 ä»¥é€Ÿåº¦ä¸ºä»£ä»·å®ç°äº†æ›´é«˜çš„å¯æ‰©å±•æ€§ã€‚

å¯ä»¥è°ƒæ•´ ZeRO-3 é…ç½®ä½¿å…¶æ€§èƒ½æ¥è¿‘ ZeRO-2ï¼š

- å°†Â `stage3_param_persistence_threshold`Â è®¾ç½®ä¸ºä¸€ä¸ªéå¸¸å¤§çš„æ•°å­— - å¤§äºæœ€å¤§çš„å‚æ•°ï¼Œä¾‹å¦‚Â `6 * hidden_size * hidden_size`ã€‚è¿™å°†ä¿ç•™å‚æ•°åœ¨ GPU ä¸Šã€‚
- å…³é—­Â `offload_params`ï¼Œå› ä¸º ZeRO-2 æ²¡æœ‰è¿™ä¸ªé€‰é¡¹ã€‚

å³ä½¿ä¸æ›´æ”¹Â `stage3_param_persistence_threshold`ï¼Œä»…å°†Â `offload_params`Â å…³é—­ï¼Œæ€§èƒ½å¯èƒ½ä¼šæ˜¾è‘—æé«˜ã€‚å½“ç„¶ï¼Œè¿™äº›æ›´æ”¹å°†å½±å“æ‚¨å¯ä»¥è®­ç»ƒçš„æ¨¡å‹çš„å¤§å°ã€‚å› æ­¤ï¼Œè¿™äº›æ›´æ”¹å¯æ ¹æ®éœ€æ±‚å¸®åŠ©æ‚¨åœ¨å¯æ‰©å±•æ€§å’Œé€Ÿåº¦ä¹‹é—´è¿›è¡Œæƒè¡¡ã€‚

### å¦‚ä½•é€‰æ‹©æœ€ä½³æ€§èƒ½çš„ZeRO Stageå’Œ offloads

é€šå¸¸ï¼Œä»¥ä¸‹è§„åˆ™é€‚ç”¨ï¼š

- é€Ÿåº¦æ–¹é¢ï¼ˆå·¦è¾¹æ¯”å³è¾¹å¿«ï¼‰
    
    stage 0ï¼ˆDDPï¼‰ > stage 1 > stage 2 > stage 2 + offload > stage 3 > stage3 + offload
    
- GPUå†…å­˜ä½¿ç”¨æ–¹é¢ï¼ˆå³è¾¹æ¯”å·¦è¾¹æ›´èŠ‚çœGPUå†…å­˜ï¼‰
    
    stage 0ï¼ˆDDPï¼‰ < stage 1 < stage 2 < stage 2 + offload < stage 3 < stage 3 + offload
    

æ‰€ä»¥ï¼Œå½“æ‚¨å¸Œæœ›åœ¨å°½é‡ä½¿ç”¨è¾ƒå°‘æ•°é‡çš„GPUçš„åŒæ—¶è·å¾—æœ€å¿«çš„æ‰§è¡Œé€Ÿåº¦æ—¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œã€‚æˆ‘ä»¬ä»æœ€å¿«çš„æ–¹æ³•å¼€å§‹ï¼Œå¦‚æœé‡åˆ°GPUå†…å­˜æº¢å‡ºï¼Œç„¶ååˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªé€Ÿåº¦è¾ƒæ…¢ä½†ä½¿ç”¨çš„GPUå†…å­˜æ›´å°‘çš„æ–¹æ³•ã€‚ä»¥æ­¤ç±»æ¨ã€‚

é¦–å…ˆï¼Œå°†æ‰¹é‡å¤§å°è®¾ç½®ä¸º1ï¼ˆæ‚¨å§‹ç»ˆå¯ä»¥ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯æ¥è·å¾—ä»»ä½•æ‰€éœ€çš„æœ‰æ•ˆæ‰¹é‡å¤§å°ï¼‰ã€‚

1. å¯ç”¨Â `--gradient_checkpointing 1`ï¼ˆHF Trainerï¼‰æˆ–ç›´æ¥Â `model.gradient_checkpointing_enable()`Â - å¦‚æœå‘ç”ŸOOMï¼ˆOut of Memoryï¼‰ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
2. é¦–å…ˆå°è¯• ZeRO stage 2ã€‚å¦‚æœå‘ç”ŸOOMï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
3. å°è¯• ZeRO stage 2 +Â `offload_optimizer`Â - å¦‚æœå‘ç”ŸOOMï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
4. åˆ‡æ¢åˆ° ZeRO stage 3 - å¦‚æœå‘ç”ŸOOMï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
5. å¯ç”¨Â `offload_param`Â åˆ°Â `cpu`Â - å¦‚æœå‘ç”ŸOOMï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
6. å¯ç”¨Â `offload_optimizer`Â åˆ°Â `cpu`Â - å¦‚æœå‘ç”ŸOOMï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚
7. å¦‚æœä»ç„¶æ— æ³•é€‚åº”æ‰¹é‡å¤§å°ä¸º1ï¼Œè¯·é¦–å…ˆæ£€æŸ¥å„ç§é»˜è®¤å€¼å¹¶å°½å¯èƒ½é™ä½å®ƒä»¬ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½¿ç”¨Â `generate`Â å¹¶ä¸”ä¸ä½¿ç”¨å®½æœç´¢æŸï¼Œå°†å…¶ç¼©å°ï¼Œå› ä¸ºå®ƒä¼šå ç”¨å¤§é‡å†…å­˜ã€‚
8. ç»å¯¹è¦ä½¿ç”¨æ··åˆåŠç²¾åº¦è€Œéfp32 - åœ¨AmpereåŠæ›´é«˜çš„GPUä¸Šä½¿ç”¨bf16ï¼Œåœ¨æ—§çš„GPUä½“ç³»ç»“æ„ä¸Šä½¿ç”¨fp16ã€‚
9. å¦‚æœä»ç„¶å‘ç”ŸOOMï¼Œå¯ä»¥æ·»åŠ æ›´å¤šç¡¬ä»¶æˆ–å¯ç”¨ZeRO-Infinity - å³åˆ‡æ¢Â `offload_param`Â å’ŒÂ `offload_optimizer`Â åˆ°Â `nvme`ã€‚æ‚¨éœ€è¦ç¡®ä¿å®ƒæ˜¯éå¸¸å¿«çš„NVMeã€‚ä½œä¸ºè¶£é—»ï¼Œæˆ‘æ›¾ç»èƒ½å¤Ÿåœ¨ä¸€ä¸ªå°å‹GPUä¸Šä½¿ç”¨BLOOM-176Bè¿›è¡Œæ¨ç†ï¼Œä½¿ç”¨äº†ZeRO-Infinityï¼Œå°½ç®¡é€Ÿåº¦éå¸¸æ…¢ã€‚ä½†å®ƒå¥æ•ˆäº†ï¼

å½“ç„¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥æŒ‰ç›¸åçš„é¡ºåºè¿›è¡Œè¿™äº›æ­¥éª¤ï¼Œä»æœ€èŠ‚çœGPUå†…å­˜çš„é…ç½®å¼€å§‹ï¼Œç„¶åé€æ­¥åå‘è¿›è¡Œï¼Œæˆ–è€…å°è¯•è¿›è¡ŒäºŒåˆ†æ³•ã€‚

ä¸€æ—¦æ‚¨çš„æ‰¹é‡å¤§å°ä¸º1ä¸ä¼šå¯¼è‡´OOMï¼Œå°±æµ‹é‡æ‚¨çš„æœ‰æ•ˆååé‡ã€‚

æ¥ä¸‹æ¥å°è¯•å°†æ‰¹é‡å¤§å°å¢åŠ åˆ°å°½å¯èƒ½å¤§ï¼Œå› ä¸ºæ‰¹é‡å¤§å°è¶Šå¤§ï¼ŒGPUçš„æ•ˆç‡è¶Šé«˜ï¼Œç‰¹åˆ«æ˜¯åœ¨å®ƒä»¬ä¹˜æ³•è¿ç®—çš„çŸ©é˜µå¾ˆå¤§æ—¶ã€‚

ç°åœ¨æ€§èƒ½ä¼˜åŒ–æ¸¸æˆå¼€å§‹äº†ã€‚æ‚¨å¯ä»¥å…³é—­ä¸€äº›offloadç‰¹æ€§ï¼Œæˆ–è€…é™ä½ZeRO stageï¼Œå¹¶å¢åŠ /å‡å°‘æ‰¹é‡å¤§å°ï¼Œå†æ¬¡æµ‹é‡æœ‰æ•ˆååé‡ã€‚åå¤å°è¯•ï¼Œç›´åˆ°æ»¡æ„ä¸ºæ­¢ã€‚

ä¸è¦èŠ±è´¹å¤ªå¤šæ—¶é—´ï¼Œä½†å¦‚æœæ‚¨å³å°†å¼€å§‹ä¸€ä¸ªä¸ºæœŸ3ä¸ªæœˆçš„è®­ç»ƒ - è¯·èŠ±å‡ å¤©æ—¶é—´æ‰¾åˆ°ååé‡æ–¹é¢æœ€æœ‰æ•ˆçš„è®¾ç½®ã€‚è¿™æ ·æ‚¨çš„è®­ç»ƒæˆæœ¬å°†æœ€ä½ï¼Œè€Œä¸”æ‚¨ä¼šæ›´å¿«åœ°å®Œæˆè®­ç»ƒã€‚åœ¨å½“å‰å¿«èŠ‚å¥çš„æœºå™¨å­¦ä¹ ä¸–ç•Œä¸­ï¼Œå¦‚æœæ‚¨èŠ±è´¹ä¸€ä¸ªé¢å¤–çš„æœˆä»½æ¥è®­ç»ƒæŸæ ·ä¸œè¥¿ï¼Œä½ å¾ˆå¯èƒ½ä¼šé”™è¿‡ä¸€ä¸ªé»„é‡‘æœºä¼šã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯æˆ‘åˆ†äº«çš„ä¸€ç§è§‚å¯Ÿï¼Œæˆ‘å¹¶ä¸æ˜¯åœ¨å‚¬ä¿ƒä½ ã€‚åœ¨å¼€å§‹è®­ç»ƒBLOOM-176Bä¹‹å‰ï¼Œæˆ‘èŠ±äº†2å¤©æ—¶é—´è¿›è¡Œè¿™ä¸ªè¿‡ç¨‹ï¼ŒæˆåŠŸå°†ååé‡ä»90 TFLOPsæé«˜åˆ°150 TFLOPsï¼è¿™ä¸€åŠªåŠ›ä¸ºæˆ‘ä»¬èŠ‚çœäº†ä¸€ä¸ªå¤šæœˆçš„è®­ç»ƒæ—¶é—´ã€‚

è¿™äº›æ³¨é‡Šä¸»è¦æ˜¯ä¸ºè®­ç»ƒæ¨¡å¼ç¼–å†™çš„ï¼Œä½†å®ƒä»¬åœ¨æ¨ç†ä¸­ä¹Ÿåº”è¯¥å¤§éƒ¨åˆ†é€‚ç”¨ã€‚ä¾‹å¦‚ï¼Œåœ¨æ¨ç†ä¸­ï¼ŒGradient Checkpointing æ˜¯æ— ç”¨çš„ï¼Œå› ä¸ºå®ƒåªåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æœ‰ç”¨ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå¦‚æœä½ æ­£åœ¨è¿›è¡Œå¤šGPUæ¨ç†å¹¶ä¸”ä¸ä½¿ç”¨Â [DeepSpeed-Inference](https://www.deepspeed.ai/tutorials/inference-tutorial/)ï¼Œ[Accelerate](https://huggingface.co/blog/bloom-inference-pytorch-scripts)Â åº”è¯¥æä¾›æ›´ä¼˜è¶Šçš„æ€§èƒ½ã€‚

å…¶ä»–ä¸æ€§èƒ½ç›¸å…³çš„å¿«é€Ÿæ³¨é‡Šï¼š

- å¦‚æœæ‚¨ä»å¤´å¼€å§‹è®­ç»ƒæŸä¸ªæ¨¡å‹ï¼Œè¯·å°½é‡ç¡®ä¿å¼ é‡çš„å½¢çŠ¶å¯ä»¥è¢«16æ•´é™¤ï¼ˆä¾‹å¦‚éšè—å±‚å¤§å°ï¼‰ã€‚å¯¹äºæ‰¹é‡å¤§å°ï¼Œè‡³å°‘å°è¯•å¯è¢«2æ•´é™¤ã€‚å¦‚æœæ‚¨æƒ³ä»GPUä¸­æŒ¤å–æ›´é«˜æ€§èƒ½ï¼Œè¿˜æœ‰ä¸€äº›ç¡¬ä»¶ç‰¹å®šçš„[waveå’Œtileé‡åŒ–](https://developer.nvidia.com/blog/optimizing-gpu-performance-tensor-cores/)çš„å¯æ•´é™¤æ€§ã€‚

## Activation Checkpointing æˆ– Gradient Checkpointing

Activation Checkpointingå’ŒGradient Checkpointingæ˜¯æŒ‡ç›¸åŒæ–¹æ³•çš„ä¸¤ä¸ªä¸åŒæœ¯è¯­ã€‚è¿™ç¡®å®è®©äººæ„Ÿåˆ°å›°æƒ‘ï¼Œä½†äº‹å®å°±æ˜¯è¿™æ ·ã€‚

- åœ¨æ ‡å‡†çš„åå‘ä¼ æ’­ä¸­ï¼Œéœ€è¦ä¿å­˜æ‰€æœ‰ä¸­é—´æ¿€æ´»å€¼ä»¥è®¡ç®—æ¢¯åº¦ã€‚åœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶ï¼Œåå‘ä¼ æ’­éœ€è¦è®¿é—®å‰å‘ä¼ æ’­æ—¶çš„ä¸­é—´æ¿€æ´»å€¼ï¼ˆå³ç¥ç»ç½‘ç»œæ¯ä¸€å±‚çš„è¾“å‡ºï¼‰ã€‚é€šå¸¸ï¼Œæ‰€æœ‰çš„æ¿€æ´»å€¼éƒ½ä¼šåœ¨å†…å­˜ä¸­ä¿å­˜ï¼Œä»¥ä¾¿åœ¨è®¡ç®—æ¢¯åº¦æ—¶ä½¿ç”¨ã€‚ç„¶è€Œï¼Œå½“æ¨¡å‹è¾ƒå¤§æ—¶ï¼Œè¿™ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†é•¿åºåˆ—æˆ–å¤§å‹æ‰¹æ¬¡æ—¶ã€‚
- Gradient Checkpointingé€šè¿‡åªä¿å­˜éƒ¨åˆ†ä¸­é—´ç»“æœï¼ˆæ£€æŸ¥ç‚¹ï¼‰ï¼Œå¹¶åœ¨éœ€è¦æ—¶é‡æ–°è®¡ç®—å…¶ä»–å€¼æ¥å‡å°‘å†…å­˜ä½¿ç”¨ã€‚

Gradient Checkpointingå…è®¸é€šè¿‡ç‰ºç‰²é€Ÿåº¦æ¥æ¢å–GPUå†…å­˜ï¼Œè¿™è¦ä¹ˆä½¿æ‚¨èƒ½å¤Ÿå…‹æœGPUå†…å­˜æº¢å‡ºï¼Œè¦ä¹ˆå¢åŠ æ‰¹é‡å¤§å°æ¥è·å¾—æ›´å¥½çš„æ€§èƒ½ã€‚

HF Transformers æ¨¡å‹å¯¹DeepSpeedçš„Activation Checkpointingä¸€æ— æ‰€çŸ¥ï¼Œå› æ­¤å¦‚æœå°è¯•åœ¨DeepSpeedé…ç½®æ–‡ä»¶ä¸­å¯ç”¨è¯¥åŠŸèƒ½ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿã€‚

å› æ­¤ï¼Œæ‚¨æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åˆ©ç”¨è¿™ä¸ªéå¸¸æœ‰ç›Šçš„åŠŸèƒ½ï¼š

1. å¦‚æœæ‚¨æƒ³ä½¿ç”¨ HF Transformers æ¨¡å‹ï¼Œä½ å¯ä»¥ä½¿ç”¨Â `model.gradient_checkpointing_enable()`Â æˆ–åœ¨ HF Trainer ä¸­ä½¿ç”¨Â `--gradient_checkpointing`ï¼Œå®ƒä¼šè‡ªåŠ¨ä¸ºæ‚¨å¯ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚åœ¨è¿™é‡Œä½¿ç”¨äº†Â `torch.utils.checkpoint`ã€‚
2. å¦‚æœæ‚¨ç¼–å†™è‡ªå·±çš„æ¨¡å‹å¹¶å¸Œæœ›ä½¿ç”¨DeepSpeedçš„Activation Checkpointingï¼Œå¯ä»¥ä½¿ç”¨[è§„å®šçš„API](https://deepspeed.readthedocs.io/en/latest/activation-checkpointing.html)ã€‚æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ HF Transformers çš„æ¨¡å‹ä»£ç ï¼Œå°†Â `torch.utils.checkpoint`Â æ›¿æ¢ä¸º DeepSpeed çš„APIã€‚åè€…æ›´çµæ´»ï¼Œå› ä¸ºå®ƒå…è®¸æ‚¨å°†å‰å‘æ¿€æ´»å€¼å¸è½½åˆ°CPUå†…å­˜ï¼Œè€Œä¸æ˜¯é‡æ–°è®¡ç®—å®ƒä»¬ã€‚

## Optimizer å’Œ Scheduler

åªè¦ä½ ä¸å¯ç”¨Â `offload_optimizer`ï¼Œæ‚¨å¯ä»¥æ··åˆä½¿ç”¨DeepSpeedå’ŒHuggingFaceçš„è°ƒåº¦å™¨å’Œä¼˜åŒ–å™¨ï¼Œä½†æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œå³ä¸è¦ä½¿ç”¨HuggingFaceè°ƒåº¦å™¨å’ŒDeepSpeedä¼˜åŒ–å™¨çš„ç»„åˆï¼š

|Combos|HF Scheduler|DS Scheduler|
|:--|:--|:--|
|HF Optimizer|Yes|Yes|
|DS Optimizer|No|Yes|

åœ¨å¯ç”¨Â `offload_optimizer`Â çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨éDeepSpeedä¼˜åŒ–å™¨ï¼Œåªè¦è¯¥ä¼˜åŒ–å™¨å…·æœ‰CPUå’ŒGPUçš„å®ç°ï¼ˆé™¤äº†LAMBï¼‰ã€‚

### Optimizer

DeepSpeedçš„ä¸»è¦ä¼˜åŒ–å™¨åŒ…æ‹¬Adamã€AdamWã€OneBitAdamå’ŒLambã€‚è¿™äº›ä¼˜åŒ–å™¨å·²ç»ä¸ZeROè¿›è¡Œäº†å½»åº•çš„æµ‹è¯•ï¼Œå› æ­¤å»ºè®®ä½¿ç”¨å®ƒä»¬ã€‚ç„¶è€Œï¼Œä¹Ÿå¯ä»¥å¯¼å…¥`torch`ä¸­çš„å…¶ä»–ä¼˜åŒ–å™¨ã€‚å®Œæ•´çš„æ–‡æ¡£åœ¨[è¿™é‡Œ](https://www.deepspeed.ai/docs/config-json/#optimizer-parameters)ã€‚

å½“ä¸DeepSpeedçš„CPU Adamä¼˜åŒ–å™¨ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œoffloadçš„æ•ˆæœæœ€å¥½ã€‚å¦‚æœæ‚¨æƒ³åœ¨offloadæ—¶ä½¿ç”¨ä¸åŒçš„ä¼˜åŒ–å™¨ï¼Œè‡ªÂ `deepspeed==0.8.3`Â èµ·ï¼Œæ‚¨è¿˜éœ€è¦æ·»åŠ ï¼š

{
   "zero_force_ds_cpu_optimizer": false
}

åˆ°é¡¶å±‚é…ç½®ä¸­ã€‚

### Scheduler

DeepSpeedæ”¯æŒ`LRRangeTest`ã€`OneCycle`ã€`WarmupLR`å’Œ`WarmupDecayLR`å­¦ä¹ ç‡è°ƒåº¦å™¨ã€‚å®Œæ•´æ–‡æ¡£åœ¨[è¿™é‡Œ](https://www.deepspeed.ai/docs/config-json/#scheduler-parameters)ã€‚

ä»¥ä¸‹æ˜¯ğŸ¤— Transformers å’Œ DeepSpeed ä¹‹é—´çš„è°ƒåº¦å™¨é‡å éƒ¨åˆ†ï¼š

- é€šè¿‡Â `--lr_scheduler_type constant_with_warmup`Â å®ç°Â `WarmupLR`
- é€šè¿‡Â `--lr_scheduler_type linear`Â å®ç°Â `WarmupDecayLR`ã€‚è¿™ä¹Ÿæ˜¯Â `--lr_scheduler_type`Â çš„é»˜è®¤å€¼ï¼Œå› æ­¤ï¼Œå¦‚æœä¸é…ç½®è°ƒåº¦å™¨ï¼Œè¿™å°†æ˜¯é»˜è®¤é…ç½®çš„è°ƒåº¦å™¨ã€‚

å¦‚æœåœ¨é…ç½®æ–‡ä»¶ä¸­ä¸é…ç½®Â `scheduler`Â æ¡ç›®ï¼Œ`Trainer`Â å°†ä½¿ç”¨Â `--lr_scheduler_type`ã€`--learning_rate`Â å’ŒÂ `--warmup_steps`Â æˆ–Â `--warmup_ratio`Â çš„å€¼æ¥é…ç½®å…¶ğŸ¤— Transformers ç‰ˆæœ¬ã€‚

## fp32ç²¾åº¦

DeepSpeedæ”¯æŒå®Œæ•´çš„fp32å’Œfp16æ··åˆç²¾åº¦ã€‚

ç”±äºfp16æ··åˆç²¾åº¦å…·æœ‰æ›´å°çš„å†…å­˜éœ€æ±‚å’Œæ›´å¿«çš„é€Ÿåº¦ï¼Œå”¯ä¸€ä¸ä½¿ç”¨å®ƒçš„æ—¶å€™æ˜¯å½“æ‚¨ä½¿ç”¨çš„æ¨¡å‹åœ¨è¿™ç§è®­ç»ƒæ¨¡å¼ä¸‹è¡¨ç°ä¸ä½³æ—¶ã€‚é€šå¸¸ï¼Œå½“æ¨¡å‹æ²¡æœ‰åœ¨fp16æ··åˆç²¾åº¦ä¸‹è¿›è¡Œé¢„è®­ç»ƒæ—¶ï¼ˆä¾‹å¦‚ï¼Œbf16é¢„è®­ç»ƒæ¨¡å‹ç»å¸¸å‡ºç°è¿™ç§æƒ…å†µï¼‰ï¼Œä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚è¿™æ ·çš„æ¨¡å‹å¯èƒ½ä¼šå‘ç”Ÿæº¢å‡ºæˆ–ä¸‹æº¢ï¼Œå¯¼è‡´Â `NaN`Â æŸå¤±ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆæ‚¨å°†å¸Œæœ›ä½¿ç”¨å®Œæ•´çš„fp32æ¨¡å¼ï¼Œé€šè¿‡æ˜¾å¼ç¦ç”¨é»˜è®¤å¯ç”¨çš„fp16æ··åˆç²¾åº¦æ¨¡å¼ï¼š

Copied

{
    "fp16": {
        "enabled": false,
    }
}

å¦‚æœæ‚¨ä½¿ç”¨åŸºäºAmpereæ¶æ„çš„GPUï¼ŒPyTorchç‰ˆæœ¬1.7åŠæ›´é«˜ç‰ˆæœ¬å°†è‡ªåŠ¨åˆ‡æ¢åˆ°ä½¿ç”¨æ›´é«˜æ•ˆçš„tf32æ ¼å¼è¿›è¡Œä¸€äº›æ“ä½œï¼Œä½†ç»“æœä»å°†ä»¥fp32æ ¼å¼å‘ˆç°ã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯å’ŒåŸºå‡†æµ‹è¯•ï¼Œè¯·å‚è§[TensorFloat-32(TF32) on Ampere devices](https://pytorch.org/docs/stable/notes/cuda.html#tensorfloat-32-tf32-on-ampere-devices)ã€‚å¦‚æœå‡ºäºæŸç§åŸå› æ‚¨ä¸å¸Œæœ›ä½¿ç”¨å®ƒï¼Œè¯¥æ–‡æ¡£åŒ…æ‹¬æœ‰å…³å¦‚ä½•ç¦ç”¨æ­¤è‡ªåŠ¨è½¬æ¢çš„è¯´æ˜ã€‚

åœ¨ğŸ¤— Trainerä¸­ï¼Œä½ å¯ä»¥ä½¿ç”¨Â `--tf32`Â æ¥å¯ç”¨å®ƒï¼Œæˆ–ä½¿ç”¨Â `--tf32 0`Â æˆ–Â `--no_tf32`Â æ¥ç¦ç”¨å®ƒã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨PyTorchçš„é»˜è®¤è®¾ç½®ã€‚

## NCCLé›†åˆ

åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæœ‰ä¸¤ç§æ•°æ®ç±»å‹ï¼š`dtype`å’Œç”¨äºé€šä¿¡æ”¶é›†æ“ä½œçš„`dtype`ï¼Œå¦‚å„ç§å½’çº¦å’Œæ”¶é›†/åˆ†æ•£æ“ä½œã€‚

æ‰€æœ‰çš„gather/scatteræ“ä½œéƒ½æ˜¯åœ¨æ•°æ®ç›¸åŒçš„`dtype`ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨bf16çš„è®­ç»ƒæ¨¡å¼ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨bf16ä¸­è¿›è¡Œgatheræ“ä½œ - gatheræ“ä½œæ˜¯éæŸå¤±æ€§çš„ã€‚

å„ç§reduceæ“ä½œå¯èƒ½ä¼šæ˜¯éå¸¸æŸå¤±æ€§çš„ï¼Œä¾‹å¦‚å½“æ¢¯åº¦åœ¨å¤šä¸ªgpuä¸Šå¹³å‡æ—¶ï¼Œå¦‚æœé€šä¿¡æ˜¯åœ¨fp16æˆ–bf16ä¸­è¿›è¡Œçš„ï¼Œé‚£ä¹ˆç»“æœå¯èƒ½æ˜¯æœ‰æŸå¤±æ€§çš„ - å› ä¸ºå½“åœ¨ä¸€ä¸ªä½ç²¾åº¦ä¸­æ·»åŠ å¤šä¸ªæ•°å­—æ—¶ï¼Œç»“æœå¯èƒ½ä¸æ˜¯ç²¾ç¡®çš„ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œbf16æ¯”fp16å…·æœ‰æ›´ä½çš„ç²¾åº¦ã€‚é€šå¸¸ï¼Œå½“å¹³å‡æ¢¯åº¦æ—¶ï¼ŒæŸå¤±æœ€å°ï¼Œè¿™äº›æ¢¯åº¦é€šå¸¸éå¸¸å°ã€‚å› æ­¤ï¼Œå¯¹äºåŠç²¾åº¦è®­ç»ƒï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œfp16è¢«ç”¨ä½œreductionæ“ä½œçš„é»˜è®¤å€¼ã€‚ä½†æ˜¯ï¼Œæ‚¨å¯ä»¥å®Œå…¨æ§åˆ¶è¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚æœä½ é€‰æ‹©çš„è¯ï¼Œæ‚¨å¯ä»¥æ·»åŠ ä¸€ä¸ªå°çš„å¼€é”€ï¼Œå¹¶ç¡®ä¿reductionså°†ä½¿ç”¨fp32ä½œä¸ºç´¯ç§¯æ•°æ®ç±»å‹ï¼Œåªæœ‰å½“ç»“æœå‡†å¤‡å¥½æ—¶ï¼Œå®ƒæ‰ä¼šé™çº§åˆ°æ‚¨åœ¨è®­ç»ƒä¸­ä½¿ç”¨çš„åŠç²¾åº¦`dtype`ã€‚

è¦è¦†ç›–é»˜è®¤è®¾ç½®ï¼Œæ‚¨åªéœ€æ·»åŠ ä¸€ä¸ªæ–°çš„é…ç½®æ¡ç›®ï¼š

{
    "communication_data_type": "fp32"
}

æ ¹æ®è¿™ä¸ªä¿¡æ¯ï¼Œæœ‰æ•ˆçš„å€¼åŒ…æ‹¬â€fp16â€ã€â€œbfp16â€å’Œâ€fp32â€ã€‚

æ³¨æ„ï¼šåœ¨stage zero 3ä¸­ï¼Œbf16é€šä¿¡æ•°æ®ç±»å‹å­˜åœ¨ä¸€ä¸ªbugï¼Œè¯¥é—®é¢˜å·²åœ¨`deepspeed==0.8.1`ç‰ˆæœ¬ä¸­å¾—åˆ°ä¿®å¤ã€‚

## apex

é…ç½®apex AMP-likeæ¨¡å¼ï¼š

Copied

"amp": {
    "enabled": "auto",
    "opt_level": "auto"
}

å¹¶ä¸”ï¼Œ`Trainer`å°†æ ¹æ®`args.fp16_backend`å’Œ`args.fp16_opt_level`çš„å€¼è‡ªåŠ¨é…ç½®å®ƒã€‚

å½“ä¼ é€’`--fp16 --fp16_backend apex --fp16_opt_level 01`å‘½ä»¤è¡Œå‚æ•°æ—¶ï¼Œæ­¤æ¨¡å¼å°†è¢«å¯ç”¨ã€‚

## ZeRO-3 å’Œ Infinity Nuances

ZeRO-3ä¸ZeRO-2æœ‰å¾ˆå¤§çš„ä¸åŒï¼Œä¸»è¦æ˜¯å› ä¸ºå®ƒçš„å‚æ•°åˆ†ç‰‡åŠŸèƒ½ã€‚

ZeRO-Infinityè¿›ä¸€æ­¥æ‰©å±•äº†ZeRO-3ï¼Œä»¥æ”¯æŒNVMeå†…å­˜å’Œå…¶ä»–é€Ÿåº¦å’Œå¯æ‰©å±•æ€§æ”¹è¿›ã€‚

å°½ç®¡æ‰€æœ‰åŠªåŠ›éƒ½æ˜¯ä¸ºäº†åœ¨ä¸éœ€è¦å¯¹æ¨¡å‹è¿›è¡Œä»»ä½•ç‰¹æ®Šæ›´æ”¹çš„æƒ…å†µä¸‹å°±èƒ½æ­£å¸¸è¿è¡Œï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½éœ€è¦ä»¥ä¸‹ä¿¡æ¯ã€‚

### æ„å»ºå¤§æ¨¡å‹

DeepSpeed/ZeRO-3å¯ä»¥å¤„ç†å‚æ•°é‡è¾¾åˆ°æ•°ä¸‡äº¿çš„æ¨¡å‹ï¼Œè¿™äº›æ¨¡å‹å¯èƒ½æ— æ³•é€‚åº”ç°æœ‰çš„å†…å­˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨è¿˜æ˜¯å¸Œæœ›åˆå§‹åŒ–æ›´å¿«åœ°å‘ç”Ÿï¼Œå¯ä»¥ä½¿ç”¨_deepspeed.zero.Init()_ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°è£…é¥°å™¨ï¼‰æ¥åˆå§‹åŒ–æ¨¡å‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```python
from transformers import T5ForConditionalGeneration, T5Config
import deepspeed

with deepspeed.zero.Init():
    config = T5Config.from_pretrained("google-t5/t5-small")
    model = T5ForConditionalGeneration(config)
```

å¦‚æ‚¨æ‰€è§ï¼Œè¿™ä¼šä¸ºæ‚¨éšæœºåˆå§‹åŒ–ä¸€ä¸ªæ¨¡å‹ã€‚

å¦‚æœæ‚¨æƒ³ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ï¼Œ`model_class.from_pretrained`å°†åœ¨`is_deepspeed_zero3_enabled()`è¿”å›`True`çš„æƒ…å†µä¸‹æ¿€æ´»æ­¤åŠŸèƒ½ï¼Œç›®å‰è¿™æ˜¯é€šè¿‡ä¼ é€’çš„DeepSpeedé…ç½®æ–‡ä»¶ä¸­çš„ZeRO-3é…ç½®éƒ¨åˆ†è®¾ç½®çš„ã€‚å› æ­¤ï¼Œåœ¨è°ƒç”¨`from_pretrained`ä¹‹å‰ï¼Œæ‚¨å¿…é¡»åˆ›å»º**TrainingArguments**å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯å¯èƒ½çš„é¡ºåºç¤ºä¾‹ï¼š

```python
from transformers import AutoModel, Trainer, TrainingArguments

training_args = TrainingArguments(..., deepspeed=ds_config)
model = AutoModel.from_pretrained("google-t5/t5-small")
trainer = Trainer(model=model, args=training_args, ...)
```

å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯å®˜æ–¹ç¤ºä¾‹è„šæœ¬ï¼Œå¹¶ä¸”å‘½ä»¤è¡Œå‚æ•°ä¸­åŒ…å«`--deepspeed ds_config.json`ä¸”å¯ç”¨äº†ZeRO-3é…ç½®ï¼Œé‚£ä¹ˆä¸€åˆ‡éƒ½å·²ç»ä¸ºæ‚¨å‡†å¤‡å¥½äº†ï¼Œå› ä¸ºè¿™æ˜¯ç¤ºä¾‹è„šæœ¬çš„ç¼–å†™æ–¹å¼ã€‚

æ³¨æ„ï¼šå¦‚æœæ¨¡å‹çš„fp16æƒé‡æ— æ³•é€‚åº”å•ä¸ªGPUçš„å†…å­˜ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚

æœ‰å…³æ­¤æ–¹æ³•å’Œå…¶ä»–ç›¸å…³åŠŸèƒ½çš„å®Œæ•´è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[æ„å»ºå¤§æ¨¡å‹](https://deepspeed.readthedocs.io/en/latest/zero3.html#constructing-massive-models)ã€‚

æ­¤å¤–ï¼Œåœ¨åŠ è½½fp16é¢„è®­ç»ƒæ¨¡å‹æ—¶ï¼Œæ‚¨å¸Œæœ›`from_pretrained`ä½¿ç”¨`torch_dtype=torch.float16`ã€‚è¯¦æƒ…è¯·å‚è§[from_pretrained-torch-dtype](https://huggingface.co/docs/transformers/zh/main_classes/deepspeed#from_pretrained-torch-dtype)ã€‚

### å‚æ•°æ”¶é›†

åœ¨å¤šä¸ªGPUä¸Šä½¿ç”¨ZeRO-3æ—¶ï¼Œæ²¡æœ‰ä¸€ä¸ªGPUæ‹¥æœ‰æ‰€æœ‰å‚æ•°ï¼Œé™¤éå®ƒæ˜¯å½“å‰æ‰§è¡Œå±‚çš„å‚æ•°ã€‚å› æ­¤ï¼Œå¦‚æœæ‚¨éœ€è¦ä¸€æ¬¡è®¿é—®æ‰€æœ‰å±‚çš„æ‰€æœ‰å‚æ•°ï¼Œæœ‰ä¸€ä¸ªç‰¹å®šçš„æ–¹æ³•å¯ä»¥å®ç°ã€‚ æ‚¨å¯èƒ½ä¸éœ€è¦å®ƒï¼Œä½†å¦‚æœæ‚¨éœ€è¦ï¼Œè¯·å‚è€ƒ[å‚æ•°æ”¶é›†](https://deepspeed.readthedocs.io/en/latest/zero3.html#manual-parameter-coordination)ã€‚

ç„¶è€Œï¼Œæˆ‘ä»¬åœ¨å¤šä¸ªåœ°æ–¹ç¡®å®ä½¿ç”¨äº†å®ƒï¼Œå…¶ä¸­ä¸€ä¸ªä¾‹å­æ˜¯åœ¨`from_pretrained`ä¸­åŠ è½½é¢„è®­ç»ƒæ¨¡å‹æƒé‡ã€‚æˆ‘ä»¬ä¸€æ¬¡åŠ è½½ä¸€å±‚ï¼Œç„¶åç«‹å³å°†å…¶åˆ†åŒºåˆ°æ‰€æœ‰å‚ä¸çš„GPUä¸Šï¼Œå› ä¸ºå¯¹äºéå¸¸å¤§çš„æ¨¡å‹ï¼Œæ— æ³•åœ¨ä¸€ä¸ªGPUä¸Šä¸€æ¬¡æ€§åŠ è½½å¹¶å°†å…¶åˆ†å¸ƒåˆ°å¤šä¸ªGPUä¸Šï¼Œå› ä¸ºå†…å­˜é™åˆ¶ã€‚

æ­¤å¤–ï¼Œåœ¨ZeRO-3ä¸‹ï¼Œå¦‚æœæ‚¨ç¼–å†™è‡ªå·±çš„ä»£ç å¹¶é‡åˆ°çœ‹èµ·æ¥åƒè¿™æ ·çš„æ¨¡å‹å‚æ•°æƒé‡ï¼š

tensor([1.0], device="cuda:0", dtype=torch.float16, requires_grad=True)

å¼ºè°ƒ`tensor([1.])`ï¼Œæˆ–è€…å¦‚æœæ‚¨é‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œå®ƒè¯´å‚æ•°çš„å¤§å°æ˜¯`1`ï¼Œè€Œä¸æ˜¯æŸä¸ªæ›´å¤§çš„å¤šç»´å½¢çŠ¶ï¼Œè¿™æ„å‘³ç€å‚æ•°è¢«åˆ’åˆ†äº†ï¼Œä½ çœ‹åˆ°çš„æ˜¯ä¸€ä¸ªZeRO-3å ä½ç¬¦ã€‚

## ZeRO æ¨ç†

â€œZeRO æ¨æ–­â€ ä½¿ç”¨ä¸ â€œZeRO-3 è®­ç»ƒâ€ ç›¸åŒçš„é…ç½®ã€‚æ‚¨åªéœ€è¦å»æ‰ä¼˜åŒ–å™¨å’Œè°ƒåº¦å™¨éƒ¨åˆ†ã€‚å®é™…ä¸Šï¼Œå¦‚æœæ‚¨å¸Œæœ›ä¸è®­ç»ƒå…±äº«ç›¸åŒçš„é…ç½®æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥å°†å®ƒä»¬ä¿ç•™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ƒä»¬åªä¼šè¢«å¿½ç•¥ã€‚

æ‚¨åªéœ€è¦ä¼ é€’é€šå¸¸çš„`TrainingArguments`å‚æ•°ã€‚ä¾‹å¦‚ï¼š

```python
deepspeed --num_gpus=2 your_program.py <normal cl args> --do_eval --deepspeed ds_config.json
```

å”¯ä¸€çš„é‡è¦äº‹æƒ…æ˜¯æ‚¨éœ€è¦ä½¿ç”¨ZeRO-3é…ç½®ï¼Œå› ä¸ºZeRO-2å¯¹äºæ¨ç†æ²¡æœ‰ä»»ä½•ä¼˜åŠ¿ï¼Œå› ä¸ºåªæœ‰ZeRO-3æ‰å¯¹å‚æ•°è¿›è¡Œåˆ†ç‰‡ï¼Œè€ŒZeRO-2åˆ™å¯¹æ¢¯åº¦å’Œä¼˜åŒ–å™¨çŠ¶æ€è¿›è¡Œåˆ†ç‰‡ã€‚

ä»¥ä¸‹æ˜¯åœ¨DeepSpeedä¸‹è¿è¡Œ`run_translation.py`å¯ç”¨æ‰€æœ‰å¯ç”¨GPUçš„ç¤ºä¾‹ï¼š

```python
deepspeed examples/pytorch/translation/run_translation.py \
--deepspeed tests/deepspeed/ds_config_zero3.json \
--model_name_or_path google-t5/t5-small --output_dir output_dir \
--do_eval --max_eval_samples 50 --warmup_steps 50  \
--max_source_length 128 --val_max_target_length 128 \
--overwrite_output_dir --per_device_eval_batch_size 4 \
--predict_with_generate --dataset_config "ro-en" --fp16 \
--source_lang en --target_lang ro --dataset_name wmt16 \
--source_prefix "translate English to Romanian: "
```

ç”±äºåœ¨æ¨ç†é˜¶æ®µï¼Œä¼˜åŒ–å™¨çŠ¶æ€å’Œæ¢¯åº¦ä¸éœ€è¦é¢å¤–çš„å¤§é‡å†…å­˜ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå°†æ›´å¤§çš„æ‰¹æ¬¡å’Œ/æˆ–åºåˆ—é•¿åº¦æ”¾åˆ°ç›¸åŒçš„ç¡¬ä»¶ä¸Šã€‚

æ­¤å¤–ï¼ŒDeepSpeedç›®å‰æ­£åœ¨å¼€å‘ä¸€ä¸ªåä¸ºDeepspeed-Inferenceçš„ç›¸å…³äº§å“ï¼Œå®ƒä¸ZeROæŠ€æœ¯æ— å…³ï¼Œè€Œæ˜¯ä½¿ç”¨å¼ é‡å¹¶è¡Œæ¥æ‰©å±•æ— æ³•é€‚åº”å•ä¸ªGPUçš„æ¨¡å‹ã€‚

## å†…å­˜è¦æ±‚

ç”±äº DeepSpeed ZeRO å¯ä»¥å°†å†…å­˜å¸è½½åˆ° CPUï¼ˆå’Œ NVMeï¼‰ï¼Œè¯¥æ¡†æ¶æä¾›äº†ä¸€äº›å·¥å…·ï¼Œå…è®¸æ ¹æ®ä½¿ç”¨çš„ GPU æ•°é‡å‘ŠçŸ¥å°†éœ€è¦å¤šå°‘ CPU å’Œ GPU å†…å­˜ã€‚

è®©æˆ‘ä»¬ä¼°è®¡åœ¨å•ä¸ªGPUä¸Šå¾®è°ƒâ€bigscience/T0_3Bâ€æ‰€éœ€çš„å†…å­˜ï¼š

```bash
$ python -c 'from transformers import AutoModel; \
from deepspeed.runtime.zero.stage3 import estimate_zero3_model_states_mem_needs_all_live; \
model = AutoModel.from_pretrained("bigscience/T0_3B"); \
estimate_zero3_model_states_mem_needs_all_live(model, num_gpus_per_node=1, num_nodes=1)'
[...]
Estimated memory needed for params, optim states and gradients for a:
HW: Setup with 1 node, 1 GPU per node.
SW: Model with 2783M total params, 65M largest layer params.
  per CPU  |  per GPU |   Options
   70.00GB |   0.25GB | offload_param=cpu , offload_optimizer=cpu , zero_init=1
   70.00GB |   0.25GB | offload_param=cpu , offload_optimizer=cpu , zero_init=0
   62.23GB |   5.43GB | offload_param=none, offload_optimizer=cpu , zero_init=1
   62.23GB |   5.43GB | offload_param=none, offload_optimizer=cpu , zero_init=0
    0.37GB |  46.91GB | offload_param=none, offload_optimizer=none, zero_init=1
   15.56GB |  46.91GB | offload_param=none, offload_optimizer=none, zero_init=0
```

å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†æ¨¡å‹æ‹Ÿåˆåœ¨å•ä¸ª80GBçš„GPUä¸Šï¼Œä¸è¿›è¡ŒCPU offloadï¼Œæˆ–è€…ä½¿ç”¨å¾®å°çš„8GB GPUï¼Œä½†éœ€è¦çº¦60GBçš„CPUå†…å­˜ã€‚ï¼ˆè¯·æ³¨æ„ï¼Œè¿™ä»…æ˜¯å‚æ•°ã€ä¼˜åŒ–å™¨çŠ¶æ€å’Œæ¢¯åº¦æ‰€éœ€çš„å†…å­˜ - æ‚¨è¿˜éœ€è¦ä¸ºCUDAå†…æ ¸ã€æ¿€æ´»å€¼å’Œä¸´æ—¶å˜é‡åˆ†é…æ›´å¤šçš„å†…å­˜ã€‚ï¼‰

ç„¶åï¼Œè¿™æ˜¯æˆæœ¬ä¸é€Ÿåº¦çš„æƒè¡¡ã€‚è´­ä¹°/ç§Ÿç”¨è¾ƒå°çš„ GPUï¼ˆæˆ–è¾ƒå°‘çš„ GPUï¼Œå› ä¸ºæ‚¨å¯ä»¥ä½¿ç”¨å¤šä¸ª GPU è¿›è¡Œ Deepspeed ZeROï¼‰ã€‚ä½†è¿™æ ·ä¼šæ›´æ…¢ï¼Œå› æ­¤å³ä½¿æ‚¨ä¸å…³å¿ƒå®ŒæˆæŸé¡¹ä»»åŠ¡çš„é€Ÿåº¦ï¼Œå‡é€Ÿä¹Ÿç›´æ¥å½±å“ GPU ä½¿ç”¨çš„æŒç»­æ—¶é—´ï¼Œä»è€Œå¯¼è‡´æ›´å¤§çš„æˆæœ¬ã€‚å› æ­¤ï¼Œè¯·è¿›è¡Œå®éªŒå¹¶æ¯”è¾ƒå“ªç§æ–¹æ³•æ•ˆæœæœ€å¥½ã€‚

å¦‚æœæ‚¨æœ‰è¶³å¤Ÿçš„GPUå†…å­˜ï¼Œè¯·ç¡®ä¿ç¦ç”¨CPU/NVMeå¸è½½ï¼Œå› ä¸ºè¿™ä¼šä½¿æ‰€æœ‰æ“ä½œæ›´å¿«ã€‚

## Troubleshooting

### å¯åŠ¨æ—¶ deepspeed è¿›ç¨‹è¢«ç»ˆæ­¢ï¼Œæ²¡æœ‰å›æº¯

å¦‚æœå¯åŠ¨æ—¶`deepspeed`è¿›ç¨‹è¢«ç»ˆæ­¢ï¼Œæ²¡æœ‰å›æº¯ï¼Œè¿™é€šå¸¸æ„å‘³ç€ç¨‹åºå°è¯•åˆ†é…çš„CPUå†…å­˜è¶…è¿‡äº†ç³»ç»Ÿçš„é™åˆ¶æˆ–è¿›ç¨‹è¢«å…è®¸åˆ†é…çš„å†…å­˜ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸æ€æ­»äº†è¯¥è¿›ç¨‹ã€‚è¿™æ˜¯å› ä¸ºæ‚¨çš„é…ç½®æ–‡ä»¶å¾ˆå¯èƒ½å°†`offload_optimizer`æˆ–`offload_param`æˆ–ä¸¤è€…éƒ½é…ç½®ä¸ºå¸è½½åˆ°`cpu`ã€‚å¦‚æœæ‚¨æœ‰NVMeï¼Œå¯ä»¥å°è¯•åœ¨ZeRO-3ä¸‹å¸è½½åˆ°NVMeã€‚è¿™é‡Œæ˜¯å¦‚ä½•[ä¼°è®¡ç‰¹å®šæ¨¡å‹æ‰€éœ€çš„å†…å­˜](https://deepspeed.readthedocs.io/en/latest/memory.html)ã€‚

### è®­ç»ƒå’Œ/æˆ–è¯„ä¼°/é¢„æµ‹lossä¸º NaN

è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿåœ¨ä½¿ç”¨bf16æ··åˆç²¾åº¦æ¨¡å¼é¢„è®­ç»ƒçš„æ¨¡å‹è¯•å›¾åœ¨fp16ï¼ˆå¸¦æˆ–ä¸å¸¦æ··åˆç²¾åº¦ï¼‰ä¸‹ä½¿ç”¨æ—¶ã€‚å¤§å¤šæ•°åœ¨TPUä¸Šè®­ç»ƒçš„æ¨¡å‹ä»¥åŠç”±è°·æ­Œå‘å¸ƒçš„æ¨¡å‹éƒ½å±äºè¿™ä¸ªç±»åˆ«ï¼ˆä¾‹å¦‚ï¼Œå‡ ä¹æ‰€æœ‰åŸºäºt5çš„æ¨¡å‹ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯è¦ä¹ˆä½¿ç”¨fp32ï¼Œè¦ä¹ˆåœ¨æ”¯æŒçš„æƒ…å†µä¸‹ä½¿ç”¨bf16ï¼ˆå¦‚TPUã€Ampere GPUæˆ–æ›´æ–°çš„ç‰ˆæœ¬ï¼‰ã€‚

å¦ä¸€ä¸ªé—®é¢˜å¯èƒ½ä¸ä½¿ç”¨fp16æœ‰å…³ã€‚å½“æ‚¨é…ç½®æ­¤éƒ¨åˆ†æ—¶ï¼š

{
    "fp16": {
        "enabled": "auto",
        "loss_scale": 0,
        "loss_scale_window": 1000,
        "initial_scale_power": 16,
        "hysteresis": 2,
        "min_loss_scale": 1
    }
}

å¹¶ä¸”æ‚¨åœ¨æ—¥å¿—ä¸­çœ‹åˆ°DeepspeedæŠ¥å‘Š`OVERFLOW`å¦‚ä¸‹

```
0%|                                                                                                                             | 0/189 [00:00<?, ?it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 262144, reducing to 262144
  1%|â–Œ                                                                                                                    | 1/189 [00:00<01:26,  2.17it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 262144, reducing to 131072.0
  1%|â–ˆâ–
 [...]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 14%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œ                                                                                                   | 27/189 [00:14<01:13,  2.21it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 15%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–                                                                                                  | 28/189 [00:14<01:13,  2.18it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
 15%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Š                                                                                                  | 29/189 [00:15<01:13,  2.18it/s]
 [deepscale] OVERFLOW! Rank 0 Skipping step. Attempted loss scale: 1, reducing to 1
[...]
```

è¿™æ„å‘³ç€DeepspeedæŸå¤±ç¼©æ”¾å™¨æ— æ³•æ‰¾åˆ°ä¸€ä¸ªå…‹æœæŸå¤±æº¢å‡ºçš„ç¼©æ”¾ç³»æ•°ã€‚

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé€šå¸¸éœ€è¦æé«˜`initial_scale_power`çš„å€¼ã€‚å°†å…¶è®¾ç½®ä¸º`"initial_scale_power": 32`é€šå¸¸ä¼šè§£å†³é—®é¢˜ã€‚

## æ³¨æ„äº‹é¡¹

- å°½ç®¡ DeepSpeed æœ‰ä¸€ä¸ªå¯å®‰è£…çš„ PyPI åŒ…ï¼Œä½†å¼ºçƒˆå»ºè®®ä»æºä»£ç å®‰è£…å®ƒï¼Œä»¥æœ€å¥½åœ°åŒ¹é…æ‚¨çš„ç¡¬ä»¶ï¼Œå¦‚æœæ‚¨éœ€è¦å¯ç”¨æŸäº›åŠŸèƒ½ï¼Œå¦‚ 1-bit Adamï¼Œè¿™äº›åŠŸèƒ½åœ¨ pypi å‘è¡Œç‰ˆä¸­ä¸å¯ç”¨ã€‚
- æ‚¨ä¸å¿…ä½¿ç”¨ğŸ¤— Transformersçš„Â `Trainer`Â æ¥ä½¿ç”¨ DeepSpeed - æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ¨¡å‹ä¸è‡ªå·±çš„è®­ç»ƒå™¨ï¼Œæ‚¨è¿˜éœ€è¦æ ¹æ®Â [DeepSpeed é›†æˆè¯´æ˜](https://www.deepspeed.ai/getting-started/#writing-deepspeed-models)Â è°ƒæ•´åè€…ã€‚



## å‚è€ƒèµ„æ–™

DeepSpeedä¹‹ZeROç³»åˆ—ï¼šå°†æ˜¾å­˜ä¼˜åŒ–è¿›è¡Œåˆ°åº• - basicv8vcçš„æ–‡ç«  - çŸ¥ä¹
https://zhuanlan.zhihu.com/p/513571706

huggingfaceçš„DeepSpeedé›†æˆæ–‡æ¡£ï¼š [DeepSpeed Integration](https://huggingface.co/docs/transformers/main_classes/deepspeed)
